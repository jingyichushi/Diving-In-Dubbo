
<!-- saved from url=(0361)http://localhost:63342/ead61b63-b0a6-4ff2-a49a-86be75ccfd1a/source?file=%2FUsers%2Flrq%2FWorkspace%2Fmy_pub_prjs%2FDiving-In-Dubbo%2F%E3%80%90%E5%8D%81%E4%B8%83%E3%80%91Dubbo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA.adoc&mac=d8lKLKK9ZHIOOHjwwlukRHBI83z9v9gv3qupFT9f8NM=&projectUrl=%2FUsers%2Flrq%2FWorkspace%2Fmy_pub_prjs%2FDiving-In-Dubbo -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}

</style>
<link rel="stylesheet" href="res_files/css/font-awesome.min.css"><link rel="stylesheet" href="res_files/css/dejavu.css"><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head><body><div id="MathJax_Message" style="display: none;"></div><div id="content">
<h1>【十七】Dubbo微服务导入导出</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-3">
<p>微服务的架构特点是，服务节点在网络中呈网状分布，尽管节点间以直连形式发生通讯，但在通讯连接建立之前，两节点间是彼此相互孤立的，只有通过注册中心这个第三方媒介的协助，客户端给定名称标识获得服务方的可用物理地址列表，再在此基础上利用某些策略挑选其中一个作为最终的服务提供方。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-5">
<p>在具体实现上，类似Zookeeper这类注册中心只是负责了数据的存取和节点相关变化的通知推送而已，从框架上层来看，本地实现的客户端是通过感知相应事件，以异步的方式完成数据的同步的。然而具体实现上，订阅者在发起订阅操作时会主动从注册中心拉取数据，生命周期的此后部分发生变化的数据或子节点们则由回调事件感知，也就是客户端和注册中心存在着推拉结合、推为主的互动模式。这种以响应式为主的数据同步方式的好处是可以节省业务请求之前的准备时间，进而大大的提高服务的可用性。从前面相关文章中我们已经知道，无论是负载均衡、路由处理，还是服务发现其实都是利用这个机制在本机客户端完成的。</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-8">
<h2 id="_基础">基础</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-10">
<p>《Dubbo集群 之 目录服务》一文中所谓的目录服务实际上就是业界所谓的服务发现，因其在当前客户端以被引用微服务作为粒度单元，它的多个实例组成了一个集群，即便没有集群，单个实例也能通过<code>DubboProtocol</code>等被单独导入，因而<code>RegistryDirectory</code>目录服务实现是分属于集群中的。本文要讨论分析的<code>RegistryProtocol</code>将侧重在服务导出，由于这个动作本身所在当前服务是一个服务提供者实例，和注册中心进行数据同步的主要目的是让服务消费者能感知自身的存在，但是并不需要和同一个服务的其它提供者实例有啥关联处理，因而服务导出，也就本文所讲的服务注册是发生在一个比集群更大粒度的分布式网络中的，这样也就比较容易理解为啥<code>RegistryProtocol</code>会调用<code>RegistryDirectory</code>做服务导入处理了。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-12">
<p>综上，无论是服务导入，还是服务导出，都需要放到一个比集群更大的粒度——微服务分布式网络中，只有将数据同步到注册中心这个第三方媒介，或者从中同步数据，才能让微服务实例彼此间能发现或者感知对方。<span class="big">假如说<code>DubboProtocol</code>让一个微服务实例意识到自身个体的存在，那么<code>RegistryProtocol</code>则是在注册中心的基础上让它意识到个体间关系的存在。</span></p>
</div>
<div class="paragraph has-source-line data-line-stdin-14">
<p>官网中如下实例，服务的导入导出的输入数据源依然是用URL配置总线加以表达的，表征微服务实例或微服务引用实例的URL数据被编码置入到<code>url["export"]</code>或<code>url["refer"]</code>这个参数中，也正因为如此，源码中涉及多处相关URL数据的处理。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-17">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">//① 服务导入</span>
<span style="color:#777">//      1.1）直接导入</span>
<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">dubbo://service-host/com.foo.FooService?version=1.0.0</span><span style="color:#710">"</span></span>
<span style="color:#777">//      1.2）经注册中心导入</span>
<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">registry://registry-host/org.apache.dubbo.registry.RegistryService?refer=URL.encode(</span><span style="color:#b0b">\"</span><span style="color:#D20">consumer://consumer-host/com.foo.FooService?version=1.0.0</span><span style="color:#b0b">\"</span><span style="color:#D20">)</span><span style="color:#710">"</span></span>

<span style="color:#777">//② 服务导出</span>
<span style="color:#777">//      2.1）直接导出</span>
<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">dubbo://service-host/com.foo.FooService?version=1.0.0</span><span style="color:#710">"</span></span>
<span style="color:#777">//      2.2）经注册中心导出</span>
<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">registry://registry-host/org.apache.dubbo.registry.RegistryService?export=URL.encode(</span><span style="color:#b0b">\"</span><span style="color:#D20">dubbo://service-host/com.foo.FooService?version=1.0.0</span><span style="color:#b0b">\"</span><span style="color:#D20">)</span><span style="color:#710">"</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-31">
<p>如果想要通过本文深入的理解<code>RegistryProtocol</code>，还是建议想仔细阅读《Dubbo RPC 之 Protocol协议层》的三篇文章。在此先再次拧出官方文档中如下关于<code>Protocol</code>的言简意赅的介绍：</p>
</div>
<div class="quoteblock has-source-line data-line-stdin-33">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-34">
<p>RPC 协议扩展，封装远程调用细节。</p>
</div>
</blockquote>
</div>
<div class="paragraph has-source-line data-line-stdin-37">
<p>对应本文的<code>RegistryProtocol</code>来说，其实就是将本地同注册中心的数据同步这个细节封装起来，一方面满足了接口实现，另一方面也将注册中心——准确来说是注册中心的客户端同框架上层解耦了。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-39">
<p>在进一步剖析源码实现前，先扫清一些认知上的障碍，以便接下来更加系统深入的理解整个实现。</p>
</div>
<div class="sect2 has-source-line data-line-stdin-41">
<h3 id="_spi相关">SPI相关</h3>
<div class="paragraph has-source-line data-line-stdin-43">
<p><code>RegistryProtocol</code>是接口<code>Protocol</code>的一个扩展点具类，每一个具类都是单例的，根据Dubbo的SPI机制，会为扩展点接口动态生成一个代理类，代理类的接口方法实现中，会根据接口本身的相关注解，结合SPI配置文件的映射关系，根据名称获取到它的某个具类的实例，最后将当前方法委托给该实例的对应方法。结合<code>@SPI("dubbo")</code>这个注解，默认实例的映射名称为<code>"dubbo"</code>，而<code>RegistryProtocol</code>被映射为<code>registry</code>。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-45">
<p>如果一个扩展具类中的<code>setter</code>方法的参数也是一个扩展点，Dubbo的SPI机制会自动完成其单例的装配处理，<code>RegistryProtocol</code>有多个这样的方法，如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-47">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">//@SPI(FailoverCluster.NAME)</span>
<span style="color:#088;font-weight:bold">private</span> Cluster cluster;
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setCluster(Cluster cluster) {
    <span style="color:#950">this</span>.cluster = cluster;
}

<span style="color:#777">//@SPI("dubbo")</span>
<span style="color:#088;font-weight:bold">private</span> Protocol protocol;
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setProtocol(Protocol protocol) {
    <span style="color:#950">this</span>.protocol = protocol;
}

<span style="color:#777">//@SPI("dubbo")</span>
<span style="color:#088;font-weight:bold">private</span> RegistryFactory registryFactory;
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setRegistryFactory(RegistryFactory registryFactory) {
    <span style="color:#950">this</span>.registryFactory = registryFactory;
}

<span style="color:#777">//@SPI("javassist")</span>
<span style="color:#088;font-weight:bold">private</span> ProxyFactory proxyFactory;
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setProxyFactory(ProxyFactory proxyFactory) {
    <span style="color:#950">this</span>.proxyFactory = proxyFactory;
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-73">
<p>另外如果一个实现了扩展点接口的具类，其构造函数的入参类型也是该扩展点时，那么说明它是一个包装类，这时当前扩展点除包装类外的其它具类均会被所有的包装类给做一次装饰处理，具体行为取决于他们的总和。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-75">
<p>根据各自的注解和实现类的情况，对应的默认具类如下<sub>包装类体现在第二级上</sub>：</p>
</div>
<div class="ulist has-source-line data-line-stdin-77">
<ul>
<li class="has-source-line data-line-stdin-77">
<p><strong>cluster</strong>：<code>org.apache.dubbo.rpc.cluster.support.<strong>FailoverCluster</strong></code>；</p>
<div class="ulist has-source-line data-line-stdin-78">
<ul>
<li class="has-source-line data-line-stdin-78">
<p><strong>MockClusterWrapper</strong></p>
</li>
</ul>
</div>
</li>
<li class="has-source-line data-line-stdin-79">
<p><strong>protocol</strong>：<code>org.apache.dubbo.rpc.protocol.dubbo.<strong>DubboProtocol</strong></code>；</p>
<div class="ulist has-source-line data-line-stdin-80">
<ul>
<li class="has-source-line data-line-stdin-80">
<p><strong>ProtocolListenerWrapper</strong>、<strong>ProtocolFilterWrapper</strong>、<strong>QosProtocolWrapper</strong></p>
</li>
</ul>
</div>
</li>
<li class="has-source-line data-line-stdin-81">
<p><strong>registryFactory</strong>：<code>org.apache.dubbo.registry.dubbo.<strong>DubboRegistryFactory</strong></code>；</p>
</li>
<li class="has-source-line data-line-stdin-82">
<p><strong>proxyFactory</strong>：<code>org.apache.dubbo.rpc.proxy.javassist.<strong>JavassistProxyFactory</strong></code>；</p>
<div class="ulist has-source-line data-line-stdin-83">
<ul>
<li class="has-source-line data-line-stdin-83">
<p><strong>StubProxyFactoryWrapper</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-85">
<h3 id="_单例模式的registryprotocol">单例模式的<code>RegistryProtocol</code></h3>
<div class="paragraph has-source-line data-line-stdin-87">
<p>本文所讨论的<code>RegistryProtocol</code>是一个扩展点，在《Dubbo之SPI扩展点加载》一文中，已经阐述了，于整个应用而言，使用<code>ExtensionLoader.getExtensionLoader(SomeClz.class)</code>加载的扩展点具类等价于是单例的。如下代码前面那个 public 的构造函数主要是为了赋值全局静态变量<code>INSTANCE</code>，便于后续的引用处理。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-90">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">RegistryProtocol</span> <span style="color:#088;font-weight:bold">implements</span> Protocol {
    ...
    private <span style="color:#088;font-weight:bold">static</span> RegistryProtocol INSTANCE;

    <span style="color:#088;font-weight:bold">public</span> RegistryProtocol() {
        INSTANCE = <span style="color:#950">this</span>;
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> RegistryProtocol getRegistryProtocol() {
        <span style="color:#080;font-weight:bold">if</span> (INSTANCE == <span style="color:#069">null</span>) {
            ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(REGISTRY_PROTOCOL);
        }
        <span style="color:#080;font-weight:bold">return</span> INSTANCE;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note has-source-line data-line-stdin-109">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
从<code>RegistryProtocol</code>单例这个角度来看，下文中的<code>providerConfigurationListener</code>变量也等价于是单例的。
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-111">
<h2 id="_服务导入">服务导入</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-113">
<p>在阅读这一章节的内容之前，最好先熟读《Dubbo集群 之 目录服务》，文中剖析的<code>RegistryDirectory</code>存在的目的是为指定的被引用服务接口列出其所有可用的服务实例，该列表会根据注册中心的响应节点变化而动态改变，具体实现上主要仰赖于类似基于和注册中心以事件回调方式同步覆写规则，从而刷新本地缓存的<code>Invoker</code>引用实例。</p>
</div>
<div class="sect2 has-source-line data-line-stdin-115">
<h3 id="_大体步骤">大体步骤</h3>
<div class="paragraph has-source-line data-line-stdin-117">
<p>服务导入对外的接口方位为<code>public &lt;T&gt; Invoker&lt;T&gt; refer(Class&lt;T&gt; type, URL url) throws RpcException</code>，从定义看相当简洁，假如对应<code>RegistryProtocol</code>中的实现是给客户端呈上的一道菜，发出<code>refer(…​)</code>指令后，<code>RegistryDirectory</code>按指令办事，将原料和佐料准备好后，根据既定的烹饪程序做好这道菜。相对应的我们可以认为：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-119">
<ol class="arabic">
<li class="has-source-line data-line-stdin-119">
<p>对应微服务上线的所有实例在注册中心注册的数据节点，以及由配置中心同步的覆写规则这些则可以认为是原料；</p>
</li>
<li class="has-source-line data-line-stdin-120">
<p>入参<code>url</code>中参数指定了引用服务时的限定条件，这就相当于是辅料，相当于为适配客户口味而调制的调味剂；</p>
</li>
<li class="has-source-line data-line-stdin-121">
<p>当前客户端基于中心同步事件回调执行的逻辑，类如利用覆写规则执行刷新服务实例的过程，就好比其中一个烹饪环节，而新得到的实例就像烹制好了的整菜的一部分；</p>
</li>
<li class="has-source-line data-line-stdin-122">
<p>烹饪有好几个环节，各个环节的有机组合和应用才能最终做好这道菜，服务导入涉及如下环节：</p>
<div class="ulist has-source-line data-line-stdin-123">
<ul>
<li class="has-source-line data-line-stdin-123">
<p>构建<code>RegistryDirectory</code>实例，并为其备好:</p>
<div class="ulist has-source-line data-line-stdin-124">
<ul>
<li class="has-source-line data-line-stdin-124">
<p>用于数据同步的<code>Registry</code>实例；</p>
</li>
<li class="has-source-line data-line-stdin-125">
<p>用于单个微服务实例导入的<code>Protocol</code>实例；</p>
</li>
</ul>
</div>
</li>
<li class="has-source-line data-line-stdin-126">
<p>构建用于客户端执行目标微服务实例集过滤或筛选的的路由链<code>RouterChain</code>实例；</p>
</li>
<li class="has-source-line data-line-stdin-127">
<p>到注册中心的为指定 url 数据的客户端订阅特定微服务指定类型节点的变化；</p>
</li>
<li class="has-source-line data-line-stdin-128">
<p>选用合适的容错机制<sub>或者其他类型的<code>Cluster</code></sub>将服务实例候选集伪装成一个<code>Invoker&lt;T&gt;</code>实例；</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph has-source-line data-line-stdin-130">
<p>大体步骤实现源码如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-133">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> &lt;T&gt; Invoker&lt;T&gt; doRefer(Cluster cluster, <span style="color:#0a8;font-weight:bold">Registry</span> registry, <span style="color:#0a8;font-weight:bold">Class</span>&lt;T&gt; type, <span style="color:#0a8;font-weight:bold">URL</span> url) {
    RegistryDirectory&lt;T&gt; directory = <span style="color:#080;font-weight:bold">new</span> RegistryDirectory&lt;T&gt;(type, url);
    directory.setRegistry(registry);
    directory.setProtocol(protocol);
    <span style="color:#777">// all attributes of REFER_KEY</span>
    <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; parameters = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;(directory.getUrl().getParameters());
    <span style="color:#0a8;font-weight:bold">URL</span> subscribeUrl = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">URL</span>(CONSUMER_PROTOCOL,
        parameters.remove(REGISTER_IP_KEY), <span style="color:#00D">0</span>, type.getName(), parameters);

    <span style="color:#080;font-weight:bold">if</span> (!ANY_VALUE.equals(url.getServiceInterface()) &amp;&amp; url.getParameter(REGISTER_KEY, <span style="color:#069">true</span>)) {
        directory.setRegisteredConsumerUrl(getRegisteredConsumerUrl(subscribeUrl, url));
        registry.register(directory.getRegisteredConsumerUrl());
    }
    directory.buildRouterChain(subscribeUrl);
    directory.subscribe(subscribeUrl.addParameter(CATEGORY_KEY,
            PROVIDERS_CATEGORY + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">,</span><span style="color:#710">"</span></span> + CONFIGURATORS_CATEGORY + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">,</span><span style="color:#710">"</span></span> + ROUTERS_CATEGORY));

    Invoker invoker = cluster.join(directory);
<span style="color:#777">//    ProviderConsumerRegTable.registerConsumer(invoker, url, subscribeUrl, directory);</span>
    <span style="color:#080;font-weight:bold">return</span> invoker;
}</code></pre>
</div>
</div>
<div class="admonitionblock important has-source-line data-line-stdin-158">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph has-source-line data-line-stdin-159">
<p>每一个被引用微服务在当前客户端均会存在一个<code>RegistryDirectory</code>实例，其中声明了一个用于装载该服务引用实例的容器——<code>volatile List&lt;Invoker&lt;T&gt;&gt; invokers</code>。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-161">
<p>当发起<code>subscribe(subscribeUrl)</code>操作后，会间接发起对<code>Registry#subscribe(URL url, NotifyListener listener)</code>的调用，后面这个订阅处理会确保注册中心有相应节点的路径存在，并随即增加相应的监听器和主动获取被订阅 provider 类型节点的所有子节点（<sub>页节点</sub>），也即被引用微服务的实例集合，该集合会被转换成对应的<code>List&lt;Invoker&lt;T&gt;&gt;</code>并赋值给<code>invokers</code>变量。此后如果注册中心因为有实例的增加或者删减而导致代表实例的页节点有变动时，则会通过监听器知会客户端，这时<code>invokers</code>变量则会被重新赋值刷新处理。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-163">
<p>事件发生前后，若代表服务端实例的URL数据没有变化，则其对应的<code>Invoker&lt;T&gt;</code>实例会被原样保留，只是引用会被挪入到由<code>invokers</code>指向的新产生的<code>List&lt;Invoker&lt;T&gt;&gt;</code>类型容器中。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-165">
<p><code>RegistryDirectory</code>在刷新<code>Invoker&lt;T&gt;</code>实例时会调用<code>protocol.refer(serviceType, url)</code>，这里的<code>protocol</code>是由<code>RegistryProtocol</code>负责赋值的，负责在协议层完成单个服务实例的引用(<sub>也即导入处理</sub>)，默认是<code>DubboProtocol</code>。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-168">
<h3 id="_处理细节">处理细节</h3>
<div class="paragraph has-source-line data-line-stdin-170">
<p>代码看似很简单，但是隐藏的细节却相当丰富，需要一一详述：</p>
</div>
<div class="ulist has-source-line data-line-stdin-172">
<ul>
<li class="has-source-line data-line-stdin-172">
<p>基于注册中心的服务导入中，当前客户端自身所关心的数据全部承载在<code>regUrl["refer"]</code>中，在构建获取<code>subscribeUrl</code>时，需要先解析得到<code>rawUrl = URL.decode(regUrl["refer"])</code>，假定<code>rawUrl[^"register.ip"]</code>表示<code>rawUrl</code>移除<code>"register.ip"</code>后所剩的所有参数，则最终<code>subscribeUrl</code>的构建形式如下：</p>
</li>
</ul>
</div>
<div class="listingblock has-source-line data-line-stdin-174">
<div class="content">
<pre>"consumer://" + (rawUrl["register.ip"] | {local ip}) + "/" + {type.getName()} + "?" + {rawUrl[^"register.ip"]}

//eg：
//consumer://192.168.0.7/org.apache.dubbo.samples.basic.api.DemoService?
//application=demo-consumer&amp;check=true&amp;dubbo=2.0.2&amp;
//interface=org.apache.dubbo.samples.basic.api.DemoService&amp;
//lazy=false&amp;methods=testVoid,sayHello&amp;pid=69391&amp;release=2.7.3&amp;
//side=consumer&amp;sticky=false&amp;timestamp=1573374561281</pre>
</div>
</div>
<div class="ulist has-source-line data-line-stdin-185">
<ul>
<li class="has-source-line data-line-stdin-185">
<p>在调用<code>RegistryDirectory#subscribe(…​)</code>时，会为入参置<code>url["category"] = "providers,configurators,routers"</code>，也就是任何以<code>RegistryDirectory</code>导入的引用微服务均会：1）监听目标微服务的实例上下线情况；2）同步来自注册中心的覆写规则变化，根据需要刷新本地配置；3）路由规则的同步刷新，改变过滤或筛选规则，实际上也就是改变可用的目标服务实例的候选范围；</p>
</li>
<li class="has-source-line data-line-stdin-187">
<p>如果没有指定<code>regUrl["interface"] = "*"</code>和<code>regUrl["register"] = false</code>，<code>RegistryProtocol</code>会将当前客户端作为节点注册到注册中心，用于获取注册的<code>registeredConsumerUrl</code>的逻辑代码如下，其值为置<code>subscribeUrl["category", "check"] = "consumers", false</code>得到，只是在指定<code>regUrl["simplified"] = true</code>的情况下，其它参数中只保留<code>"application"、"version"、"group"、"dubbo"、"release"</code>这些。</p>
</li>
</ul>
</div>
<div class="listingblock has-source-line data-line-stdin-190">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> DEFAULT_REGISTER_CONSUMER_KEYS = {
        APPLICATION_KEY, VERSION_KEY, GROUP_KEY, DUBBO_VERSION_KEY, RELEASE_KEY
};

<span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">URL</span> getRegisteredConsumerUrl(<span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">URL</span> consumerUrl, <span style="color:#0a8;font-weight:bold">URL</span> registryUrl) {
    <span style="color:#080;font-weight:bold">if</span> (!registryUrl.getParameter(SIMPLIFIED_KEY, <span style="color:#069">false</span>)) {
        <span style="color:#080;font-weight:bold">return</span> consumerUrl.addParameters(CATEGORY_KEY, CONSUMERS_CATEGORY,
                CHECK_KEY, <span style="color:#0a8;font-weight:bold">String</span>.valueOf(<span style="color:#069">false</span>));
    } <span style="color:#080;font-weight:bold">else</span> {
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#0a8;font-weight:bold">URL</span>.valueOf(consumerUrl, DEFAULT_REGISTER_CONSUMER_KEYS, <span style="color:#069">null</span>)
            .addParameters(CATEGORY_KEY, CONSUMERS_CATEGORY, CHECK_KEY, <span style="color:#0a8;font-weight:bold">String</span>.valueOf(<span style="color:#069">false</span>));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-206">
<h3 id="_dorefer之前"><code>doRefer(…​)</code>之前</h3>
<div class="paragraph has-source-line data-line-stdin-208">
<p>然而基于注册中心的服务导入，在<code>doRefer(…​)</code>之前还有几处细节需要处理。首先需要规整<code>regUrl</code>，也即设<code>regUrl.protocol = (regUrl["registry"] | "dubbo")</code>，移除<code>regUrl["registry"]</code>。其次对于使用<code>RegistryProtocol</code>引用<code>RegistryService</code>类型的服务时，是无需经过服务发现机制引用的，因为它不像其他服务一样，行为由远端主机提供，其实现本质而言就是一个注册中心的客户端，远端只负责相关节点及数据的存取，行为则是由本地提供，因此可以通过本机代理机制直接获取到<code>RegistryService</code>实例。最后如果客户端配置了<code>url["group"]</code>，则说明需要做结果聚合处理，此时使用的<code>Cluster</code>则应该是<code>MergeableCluster</code>，具体参考《Dubbo集群 之 容错》一文中<code>Mergeable(结果聚合)</code>这一章节内容。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-211">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> &lt;T&gt; Invoker&lt;T&gt; refer(<span style="color:#0a8;font-weight:bold">Class</span>&lt;T&gt; type, <span style="color:#0a8;font-weight:bold">URL</span> url) <span style="color:#088;font-weight:bold">throws</span> RpcException {
    url = URLBuilder.from(url)
            .setProtocol(url.getParameter(REGISTRY_KEY, DEFAULT_REGISTRY))
            .removeParameter(REGISTRY_KEY)
            .build();
    <span style="color:#0a8;font-weight:bold">Registry</span> registry = registryFactory.getRegistry(url);
    <span style="color:#080;font-weight:bold">if</span> (RegistryService.class.equals(type)) {
        <span style="color:#080;font-weight:bold">return</span> proxyFactory.getInvoker((T) registry, type, url);
    }

    <span style="color:#777">// group="a,b" or group="*"</span>
    <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; qs = StringUtils.parseQueryString(url.getParameterAndDecoded(REFER_KEY));
    <span style="color:#0a8;font-weight:bold">String</span> group = qs.get(GROUP_KEY);
    <span style="color:#080;font-weight:bold">if</span> (group != <span style="color:#069">null</span> &amp;&amp; group.length() &gt; <span style="color:#00D">0</span>) {
        <span style="color:#080;font-weight:bold">if</span> ((COMMA_SPLIT_PATTERN.split(group)).length &gt; <span style="color:#00D">1</span> || <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">*</span><span style="color:#710">"</span></span>.equals(group)) {
            <span style="color:#080;font-weight:bold">return</span> doRefer(getMergeableCluster(), registry, type, url);
        }
    }
    <span style="color:#080;font-weight:bold">return</span> doRefer(cluster, registry, type, url);
}

<span style="color:#088;font-weight:bold">private</span> Cluster getMergeableCluster() {
    <span style="color:#080;font-weight:bold">return</span> ExtensionLoader.getExtensionLoader(Cluster.class).getExtension(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">mergeable</span><span style="color:#710">"</span></span>);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-238">
<h2 id="_服务导出">服务导出</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-240">
<p>同样，微服务的导出也是相对整个微服务分布式网络而言，正如上文所述，一个微服务虽然绝大部分时刻是以集群的形式对外提供服务的，但是的就单个服务实例而言，它并不需要知道这些信息，只有服务的消费者在发起具体请求时需要知晓，也即集群信息是由客户端在注册中心的协助下各自独立维护的。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-242">
<p>然而，就如同《Dubbo 配置管理》一文中的开头部分所言，微服务的配置管理离不开注册中心这种分布式协调框架的支持。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-244">
<p>由于相关源码牵涉比较多的细节，没法一览知义，下述由浅及深，逐个击破。</p>
</div>
<div class="sect2 has-source-line data-line-stdin-246">
<h3 id="_相关url数据处理">相关<code>URL</code>数据处理</h3>
<div class="paragraph has-source-line data-line-stdin-248">
<p>Dubbo在生成本地微服务实例的初始阶段时，需要先经过配置层的数据读入处理，然后经由框架代理层将对应接口实现转换成对应的一个原始<code>Invoker&lt;T&gt;</code>对象——<code>originInvoker</code>，通过该对象的<code>getUrl()</code>方法能获得原始的URL数据——<code>regUrl</code>。然后有两种方式可以表示当前微服务使用何种注册中心导出，分别是(<sub>此处假设使用<code>zookeeper</code>作为注册中心</sub>)：1）<code>regUrl.protocol = "registry"</code> 并且<code>regUrl["registry"] = "zookeeper"</code>；2）<code>regUrl.protocol = "zookeeper"</code>。针对第一种情况，<code>RegistryProtocol</code>在执行服务到处时会使用如下<code>getRegistryUrl(originInvoker)</code>获得统一表示，也即第二种的标准表示，同时会移除<code>regUrl["registry"]</code>参数，若没有明确指定该参数，则会设<code>regUrl.protocol = "dubbo"</code>。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-251">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">URL</span> getRegistryUrl(Invoker&lt;?&gt; originInvoker) {
    <span style="color:#0a8;font-weight:bold">URL</span> registryUrl = originInvoker.getUrl();
    <span style="color:#080;font-weight:bold">if</span> (REGISTRY_PROTOCOL.equals(registryUrl.getProtocol())) {
        <span style="color:#0a8;font-weight:bold">String</span> protocol = registryUrl.getParameter(REGISTRY_KEY, DEFAULT_REGISTRY);
        registryUrl = registryUrl.setProtocol(protocol).removeParameter(REGISTRY_KEY);
    }
    <span style="color:#080;font-weight:bold">return</span> registryUrl;
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-262">
<p><code>regUrl["export"]</code>编码封装了当前被导出微服务本身的信息，需经过<code>getProviderUrl(originInvoker)</code>解码获得其URL数据——<code>providerUrl</code>。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-265">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">URL</span> getProviderUrl(<span style="color:#088;font-weight:bold">final</span> Invoker&lt;?&gt; originInvoker) {
    <span style="color:#0a8;font-weight:bold">String</span> <span style="color:#080;font-weight:bold">export</span> = originInvoker.getUrl().getParameterAndDecoded(EXPORT_KEY);
    <span style="color:#080;font-weight:bold">if</span> (<span style="color:#080;font-weight:bold">export</span> == <span style="color:#069">null</span> || <span style="color:#080;font-weight:bold">export</span>.length() == <span style="color:#00D">0</span>) {
        <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalArgumentException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">The registry export url is null! registry: </span><span style="color:#710">"</span></span> + originInvoker.getUrl());
    }
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#0a8;font-weight:bold">URL</span>.valueOf(<span style="color:#080;font-weight:bold">export</span>);
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-275">
<p>Dubbo的注册中心中存在一类<code>"configurators"</code>节点，一个微服务的相关的覆写规则会作为其子节点出现。其完整URL数据表示——<code>overrideSubscribeUrl</code>，是在<code>providerUrl</code>的基础上获得的，也即设<code>providerUrl["category", "check"] = "configurators", false</code>、<code>providerUrl.protocol = "provider"</code>。当然，它也是服务实例用于订阅配置类节点的。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-278">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">URL</span> getSubscribedOverrideUrl(<span style="color:#0a8;font-weight:bold">URL</span> registeredProviderUrl) {
    <span style="color:#080;font-weight:bold">return</span> registeredProviderUrl.setProtocol(PROVIDER_PROTOCOL)
            .addParameters(CATEGORY_KEY, CONFIGURATORS_CATEGORY, CHECK_KEY, <span style="color:#0a8;font-weight:bold">String</span>.valueOf(<span style="color:#069">false</span>));
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-285">
<p>URL配置总线在Dubbo中作为载体起到了上下文参数存取和传递的作用，然而环节传递过程中并不是毫无保留的全盘脱出，多出的参数会扰乱下一环的业务处理，也可会造成某些不必要的数据泄露风险，因此无论这种传递是跨方法的还是跨服务进程的，都会经过必要的筛选处理，或增或减，抑或重新组装URL实例。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-287">
<p>一个服务实例的大部分配置数据都有可能装载在代表它的URL数据中——<code>providerUrl = regUrl["export"]</code>，其中一部分仅限于本实例使用，集群中其它实例或者它的消费者并不需要知晓，或者说不应该暴露给它们。换言之，代表服务实例完成到注册中心注册的URL数据——<code>registeredProviderUrl</code>，应该是由<code>providerUrl</code>裁剪得到的，其获取方式有如下：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-289">
<ol class="arabic">
<li class="has-source-line data-line-stdin-289">
<p>检验是否含有<code>regUrl["simplified"] = true</code>：</p>
</li>
<li class="has-source-line data-line-stdin-290">
<p>无，默认情况，去掉<code>providerUrl</code>中的如下参数：</p>
<div class="ulist has-source-line data-line-stdin-291">
<ul>
<li class="has-source-line data-line-stdin-291">
<p>带<code>"."</code>前缀的参数；</p>
</li>
<li class="has-source-line data-line-stdin-292">
<p><code>"monitor"、 "bind.ip"、 "bind.port"、 "qos.enable"、  "qos.host"、 "qos.port"、  "qos.accept.foreign.ip"、 "validation"、 "interfaces"</code></p>
</li>
</ul>
</div>
</li>
<li class="has-source-line data-line-stdin-293">
<p>有，按如下步骤组装URL数据：</p>
<div class="olist loweralpha has-source-line data-line-stdin-294">
<ol class="loweralpha" type="a">
<li class="has-source-line data-line-stdin-294">
<p>保留<code>"application"、 "codec"、 "exchanger"、 "serialization"、 "cluster"、 "connections"、 "deprecated"、 "group"、 "loadbalance"、 "mock"、 "path"、 "timeout"、 "token"、 "version"、 "warmup"、 "weight"、 "timestamp"、 "dubbo"、 "release"</code>这些参数；</p>
</li>
<li class="has-source-line data-line-stdin-295">
<p>Dubbo优先使用<code>url["interface"]</code>参数表示服务接口，没有该参数的情况下使用<code>url.path</code>，前者存在的情况下，若和后者不一样，也需要保留；</p>
</li>
<li class="has-source-line data-line-stdin-296">
<p><code>url["extra-keys"]</code>也参数原样保留；</p>
</li>
<li class="has-source-line data-line-stdin-297">
<p>另外参数附有方法前缀的也愿意保留，前缀满足<code>prefix ∈ url["methods"]</code><sub>（","逗号分隔的方法名称)</sub>；</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="listingblock has-source-line data-line-stdin-300">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">URL</span> getRegisteredProviderUrl(<span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">URL</span> providerUrl, <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">URL</span> registryUrl) {
    <span style="color:#080;font-weight:bold">if</span> (!registryUrl.getParameter(SIMPLIFIED_KEY, <span style="color:#069">false</span>)) {
        <span style="color:#080;font-weight:bold">return</span> providerUrl.removeParameters(getFilteredKeys(providerUrl))
            .removeParameters(MONITOR_KEY, BIND_IP_KEY, BIND_PORT_KEY, QOS_ENABLE,
                QOS_HOST, QOS_PORT, ACCEPT_FOREIGN_IP, VALIDATION_KEY, INTERFACES);
    } <span style="color:#080;font-weight:bold">else</span> {
        <span style="color:#0a8;font-weight:bold">String</span> extraKeys = registryUrl.getParameter(EXTRA_KEYS_KEY, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#710">"</span></span>);
        <span style="color:#080;font-weight:bold">if</span> (!providerUrl.getPath().equals(providerUrl.getParameter(INTERFACE_KEY))) {
            <span style="color:#080;font-weight:bold">if</span> (StringUtils.isNotEmpty(extraKeys)) {
                extraKeys += <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">,</span><span style="color:#710">"</span></span>;
            }
            extraKeys += INTERFACE_KEY;
        }
        <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> paramsToRegistry = getParamsToRegistry(DEFAULT_REGISTER_PROVIDER_KEYS
                , COMMA_SPLIT_PATTERN.split(extraKeys));
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#0a8;font-weight:bold">URL</span>.valueOf(providerUrl, paramsToRegistry,
            providerUrl.getParameter(METHODS_KEY, (<span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span>) <span style="color:#069">null</span>));
    }

}

<span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> getFilteredKeys(<span style="color:#0a8;font-weight:bold">URL</span> url) {
    <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; params = url.getParameters();
    <span style="color:#080;font-weight:bold">if</span> (CollectionUtils.isNotEmptyMap(params)) {
        <span style="color:#080;font-weight:bold">return</span> params.keySet().stream()
                .filter(k -&gt; k.startsWith(HIDE_KEY_PREFIX))
                .toArray(<span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span>::<span style="color:#080;font-weight:bold">new</span>);
    } <span style="color:#080;font-weight:bold">else</span> {
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">String</span>[<span style="color:#00D">0</span>];
    }
}

<span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> DEFAULT_REGISTER_PROVIDER_KEYS = {
        APPLICATION_KEY, CODEC_KEY, EXCHANGER_KEY, SERIALIZATION_KEY,
        CLUSTER_KEY, CONNECTIONS_KEY, DEPRECATED_KEY,
        GROUP_KEY, LOADBALANCE_KEY, MOCK_KEY, PATH_KEY, TIMEOUT_KEY,
        TOKEN_KEY, VERSION_KEY, WARMUP_KEY,
        WEIGHT_KEY, TIMESTAMP_KEY, DUBBO_VERSION_KEY, RELEASE_KEY
};

<span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> getParamsToRegistry(<span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> defaultKeys, <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> additionalParameterKeys) {
    <span style="color:#339;font-weight:bold">int</span> additionalLen = additionalParameterKeys.length;
    <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> registryParams = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">String</span>[defaultKeys.length + additionalLen];
    <span style="color:#0a8;font-weight:bold">System</span>.arraycopy(defaultKeys, <span style="color:#00D">0</span>, registryParams, <span style="color:#00D">0</span>, defaultKeys.length);
    <span style="color:#0a8;font-weight:bold">System</span>.arraycopy(additionalParameterKeys, <span style="color:#00D">0</span>,
        registryParams, defaultKeys.length, additionalLen);
    <span style="color:#080;font-weight:bold">return</span> registryParams;
}</code></pre>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-351">
<h3 id="_acl_在服务端的应用"><code>ACL</code> 在服务端的应用</h3>
<div class="paragraph has-source-line data-line-stdin-353">
<p>《Dubbo集群 之 目录服务》一文中已经花费大量篇幅，深刻阐述了利用覆写规则同步刷新微服务引用实例的实现，与之相似，当本地服务实例监听到来自系统维护人员通过配置中心修改相关配置的事件后，也会对实例做相应的刷新处理。在其<code>“同步覆写规则”</code>这一章节中已经介绍过，本地接受到的事件中会含有对应的覆写规则的文本数据，<code>AbstractConfiguratorListener</code>会将其装换成对应的<code>List&lt;Configurator&gt; configurators</code>覆写规则处理器列表，实现类会在需要是调用<code>configurators</code>改写代表实例的URL数据，正如下述<code>getConfigedInvokerUrl(configurators, url)</code>所实现的逻辑那样。而方法最终返回的URL数据则是用于产生新的实例，并替换掉旧的那个。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-356">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">URL</span> getConfigedInvokerUrl(<span style="color:#0a8;font-weight:bold">List</span>&lt;Configurator&gt; configurators, <span style="color:#0a8;font-weight:bold">URL</span> url) {
    <span style="color:#080;font-weight:bold">if</span> (configurators != <span style="color:#069">null</span> &amp;&amp; configurators.size() &gt; <span style="color:#00D">0</span>) {
        <span style="color:#080;font-weight:bold">for</span> (Configurator configurator : configurators) {
            url = configurator.configure(url);
        }
    }
    <span style="color:#080;font-weight:bold">return</span> url;
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-367">
<p>相似地，由于一个应用中可以存在多个微服务，因而在服务端依然按照应用级和服务级分别同步覆写规则，对应提供<code>AbstractConfiguratorListener</code>抽象类的扩展实现——<code>ProviderConfigurationListener</code>和<code>ServiceConfigurationListener</code>，分别订阅配置中心对应的<code>"/({namespace} | dubbo)/config/dubbo/{app}.configurators"</code>节点和<code>“/({namespace} | dubbo)/config/dubbo/{interfaceName}[:{version}][:{group}].configurators”</code>节点，它们都含有如下一个覆写URL数据的方法：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-370">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">class</span> (<span style="color:#B06;font-weight:bold">ServiceConfigurationListener</span> | ProviderConfigurationListener) <span style="color:#088;font-weight:bold">extends</span> AbstractConfiguratorListener{
    ...
    private &lt;T&gt; <span style="color:#0a8;font-weight:bold">URL</span> overrideUrl(<span style="color:#0a8;font-weight:bold">URL</span> url) {
        <span style="color:#080;font-weight:bold">return</span> RegistryProtocol.getConfigedInvokerUrl(configurators, url);
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-380">
<p><code>AbstractConfiguratorListener</code>的扩展实现类会在构造函数调用其定义的<code>initWith(key)</code>方法，一旦被实例化，也意味着该方法被调用，随后便会主动从配置中心的由<code>key</code>代表的对应节点拉取到覆写规则的文本数据，并被转换成<code>Configurator</code>对象装入<code>configurators</code>容器中，而后续如果相关的治理操作改写了规则，那么<code>ConfigurationListener</code>监听器实现会被触发，回调逻辑中会对<code>configurators</code>重新赋值。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-383">
<p>显然，从属于应用的微服务，在应用覆写规则刷新实例时，需要综合应用级别和自身服务级别的覆写规则，如下，两次调用<code>overrideUrl(url)</code>这个方法。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-385">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, ServiceConfigurationListener&gt; serviceConfigurationListeners
        = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ConcurrentHashMap</span>&lt;&gt;();

<span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> ProviderConfigurationListener providerConfigurationListener
        = <span style="color:#080;font-weight:bold">new</span> ProviderConfigurationListener();

<span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">URL</span> overrideUrlWithConfig(<span style="color:#0a8;font-weight:bold">URL</span> providerUrl, OverrideListener listener) {
    providerUrl = providerConfigurationListener.overrideUrl(providerUrl);
    ServiceConfigurationListener serviceConfigurationListener =
        <span style="color:#080;font-weight:bold">new</span> ServiceConfigurationListener(providerUrl, listener);
    serviceConfigurationListeners.put(providerUrl.getServiceKey(), serviceConfigurationListener);
    <span style="color:#080;font-weight:bold">return</span> serviceConfigurationListener.overrideUrl(providerUrl);
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-401">
<p>从上述源码中不难发现，当前服务端应用的每一个微服务实例均会对应存在一个<code>ServiceConfigurationListener</code>实例，该实例中绑定了一个<code>OverrideListener</code>对象，其定义的方法<code>doOverrideIfNecessary()</code>正是用于实现服务实例刷新的，也被认为是重新导出。该方法会在父类定义的回调方法<code>notifyOverrides()</code>的实现中被调用，如下源码，也就是说服务治理引发的事件驱动着服务实例的重新导出处理。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-403">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">ProviderConfigurationListener</span> <span style="color:#088;font-weight:bold">extends</span> AbstractConfiguratorListener {
    ...
    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">protected</span> <span style="color:#339;font-weight:bold">void</span> notifyOverrides() {
        overrideListeners.values().forEach(listener -&gt; ((OverrideListener) listener).doOverrideIfNecessary());
    }
}

<span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">ServiceConfigurationListener</span> <span style="color:#088;font-weight:bold">extends</span> AbstractConfiguratorListener {
    ...
    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">protected</span> <span style="color:#339;font-weight:bold">void</span> notifyOverrides() {
        notifyListener.doOverrideIfNecessary();
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-421">
<p>可见应用级别的覆写规则会引起对应应用中的所有微服务的<code>doOverrideIfNecessary()</code>方法的回调，这里我们可以认为<code>overrideListeners.values()</code>等价于从<code>serviceConfigurationListeners.values()</code>集合中执行<code>map(v → v.notifyListener)</code>所得，具体情况下文会涉及。</p>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-423">
<h3 id="_overridelistener">OverrideListener</h3>
<div class="paragraph has-source-line data-line-stdin-425">
<p>上述章节已经说明了<code>OverrideListener</code>是利用事件回调机制同步覆写规则，从而执行服务实例刷新的。该类实现了<code>NotifyListener</code>接口，而后者是注册中心客户端所定义的，用于在被关注的节点或节点相关数据变化时，回调指定的业务逻辑。也就是说覆写规则的数据同步方案实际上是有两种实现方案，一种是拥有单独的配置中心，另外一种直接利用注册中心，如果两种都有的话，则会共同发生作用。没有提供对应的配置中心实现时，相应<code>ConfigurationListener</code>接口实现就不会发生作用。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-428">
<p>先看看对应<code>doOverrideIfNecessary()</code>方法的实现，如下，步骤很清晰：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-430">
<ol class="arabic">
<li class="has-source-line data-line-stdin-430">
<p>首先由<code>URL.decode(regUrl["export"])</code>解析得到<code>originUrl</code>；</p>
</li>
<li class="has-source-line data-line-stdin-431">
<p>然后根据它计算出<code>key</code>值，并由该<code>key</code>从<code>bounds</code>取得与<code>originInvoker</code>对应的<code>ExporterChangeableWrapper</code>实例<code>exporter</code>，它的<code>invoker</code>变量缓存了<code>originInvoker</code>经过规则覆写后的版本；</p>
</li>
<li class="has-source-line data-line-stdin-432">
<p>随后经<code>exporter.getInvoker().getUrl()</code>得到最近被覆写过的URL数据<code>currentUrl</code>；</p>
</li>
<li class="has-source-line data-line-stdin-433">
<p>接着对<code>originUrl</code>应用同步于注册中心和配置中心的覆写规则，得到新的URL数据<code>newUrl</code>；</p>
</li>
<li class="has-source-line data-line-stdin-434">
<p>最后若<code>currentUrl.equals(newUrl)</code>，则表示当前发生的覆写操作并没有引起URL数据的变化，只有不相等时才会执行对应服务实例<code>originInvoker</code>的重新导出处理；</p>
</li>
</ol>
</div>
<div class="listingblock has-source-line data-line-stdin-437">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OverrideListener</span> <span style="color:#088;font-weight:bold">implements</span> NotifyListener {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">URL</span> subscribeUrl;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> Invoker originInvoker;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;Configurator&gt; configurators;

    <span style="color:#088;font-weight:bold">public</span> OverrideListener(<span style="color:#0a8;font-weight:bold">URL</span> subscribeUrl, Invoker originalInvoker) {
        <span style="color:#950">this</span>.subscribeUrl = subscribeUrl;
        <span style="color:#950">this</span>.originInvoker = originalInvoker;
    }
    ...

    public <span style="color:#088;font-weight:bold">synchronized</span> <span style="color:#339;font-weight:bold">void</span> doOverrideIfNecessary() {
        <span style="color:#088;font-weight:bold">final</span> Invoker&lt;?&gt; invoker;
        <span style="color:#080;font-weight:bold">if</span> (originInvoker <span style="color:#080;font-weight:bold">instanceof</span> InvokerDelegate) {
            invoker = ((InvokerDelegate&lt;?&gt;) originInvoker).getInvoker();
        } <span style="color:#080;font-weight:bold">else</span> {
            invoker = originInvoker;
        }
        <span style="color:#0a8;font-weight:bold">URL</span> originUrl = RegistryProtocol.this.getProviderUrl(invoker);
        <span style="color:#0a8;font-weight:bold">String</span> key = getCacheKey(originInvoker);
        ExporterChangeableWrapper&lt;?&gt; exporter = bounds.get(key);
        <span style="color:#080;font-weight:bold">if</span> (exporter == <span style="color:#069">null</span>) {
            logger.warn(<span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalStateException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">error state, exporter should not be null</span><span style="color:#710">"</span></span>));
            <span style="color:#080;font-weight:bold">return</span>;
        }
        <span style="color:#777">//The current, may have been merged many times</span>
        <span style="color:#0a8;font-weight:bold">URL</span> currentUrl = exporter.getInvoker().getUrl();
        <span style="color:#777">//Merged with this configuration</span>
        <span style="color:#0a8;font-weight:bold">URL</span> newUrl = getConfigedInvokerUrl(configurators, originUrl);
        newUrl = getConfigedInvokerUrl(providerConfigurationListener.getConfigurators(), newUrl);
        newUrl = getConfigedInvokerUrl(serviceConfigurationListeners.get(originUrl.getServiceKey())
                .getConfigurators(), newUrl);
        <span style="color:#080;font-weight:bold">if</span> (!currentUrl.equals(newUrl)) {
            RegistryProtocol.this.reExport(originInvoker, newUrl);
            logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">exported provider url changed, origin url: </span><span style="color:#710">"</span></span> + originUrl +
                    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">, old export url: </span><span style="color:#710">"</span></span> + currentUrl + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">, new export url: </span><span style="color:#710">"</span></span> + newUrl);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-484">
<p>剩下有关的实现是同于同步注册中心的覆写规则，如下源码，先对回调事件的节点列表执行执行匹配检查，如果没有匹配则直接返回，否则将所有匹配的URL数据——<code>url.protocol = "override" 或 </code>url["category"] = "configurators"<code>——转换成覆写规则处理器，最后再同样调用</code>doOverrideIfNecessary()``执行服务实例的重新导出处理。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-487">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OverrideListener</span> <span style="color:#088;font-weight:bold">implements</span> NotifyListener {
    ...
    public <span style="color:#088;font-weight:bold">synchronized</span> <span style="color:#339;font-weight:bold">void</span> notify(<span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">URL</span>&gt; urls) {
        logger.debug(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">original override urls: </span><span style="color:#710">"</span></span> + urls);

        <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">URL</span>&gt; matchedUrls = getMatchedUrls(urls, subscribeUrl.addParameter(CATEGORY_KEY,
                CONFIGURATORS_CATEGORY));
        logger.debug(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">subscribe url: </span><span style="color:#710">"</span></span> + subscribeUrl + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">, override urls: </span><span style="color:#710">"</span></span> + matchedUrls);

        <span style="color:#777">// No matching results</span>
        <span style="color:#080;font-weight:bold">if</span> (matchedUrls.isEmpty()) {
            <span style="color:#080;font-weight:bold">return</span>;
        }

        <span style="color:#950">this</span>.configurators = Configurator.toConfigurators(classifyUrls(matchedUrls, UrlUtils::isConfigurator))
                .orElse(configurators);

        doOverrideIfNecessary();
    }
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">URL</span>&gt; getMatchedUrls(<span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">URL</span>&gt; configuratorUrls, <span style="color:#0a8;font-weight:bold">URL</span> currentSubscribe) {
        <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">URL</span>&gt; result = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ArrayList</span>&lt;<span style="color:#0a8;font-weight:bold">URL</span>&gt;();
        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">URL</span> url : configuratorUrls) {
            <span style="color:#0a8;font-weight:bold">URL</span> overrideUrl = url;
            <span style="color:#777">// Compatible with the old version</span>
            <span style="color:#080;font-weight:bold">if</span> (url.getParameter(CATEGORY_KEY) == <span style="color:#069">null</span> &amp;&amp; OVERRIDE_PROTOCOL.equals(url.getProtocol())) {
                overrideUrl = url.addParameter(CATEGORY_KEY, CONFIGURATORS_CATEGORY);
            }

            <span style="color:#777">// Check whether url is to be applied to the current service</span>
            <span style="color:#080;font-weight:bold">if</span> (UrlUtils.isMatch(currentSubscribe, overrideUrl)) {
                result.add(url);
            }
        }
        <span style="color:#080;font-weight:bold">return</span> result;
    }
}

<span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">boolean</span> UrlUtils<span style="color:#F00;background-color:#FAA">#</span>isConfigurator(<span style="color:#0a8;font-weight:bold">URL</span> url) {
    <span style="color:#080;font-weight:bold">return</span> OVERRIDE_PROTOCOL.equals(url.getProtocol()) ||
            CONFIGURATORS_CATEGORY.equals(url.getParameter(CATEGORY_KEY, DEFAULT_CATEGORY));
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-531">
<p>需要注意的是，老的版本中，一个表示配置类的节点，其<code>url.protocol = "override"</code>，而新版本则用<code>url["category"] = "configurators"</code>配置项加以表达。为了适配<code>isMatch(consumerUrl, providerUrl)（<sub>没有要求“url.protocol”也要匹配</sub></code>），特针对老版本配置类的URL数据中临时加上该项。</p>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-534">
<h3 id="sec_ExporterChangeableWrapper">ExporterChangeableWrapper</h3>
<div class="paragraph has-source-line data-line-stdin-536">
<p>根据<code>Protocol</code>的定义，服务导出后需要返回一个对应的<code>Exporter</code>实例，其目的主要是用于入参<code>Invoker&lt;T&gt;</code>实例相关的销毁处理。对应<code>RegistryProtocol</code>中的业务逻辑就是为当前服务实例执行如下动作：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-538">
<ol class="arabic">
<li class="has-source-line data-line-stdin-538">
<p>从注册中心注销，也即相应<code>provider 类</code>节点解注册；</p>
</li>
<li class="has-source-line data-line-stdin-539">
<p>删除用于同步<code>注册中心</code>覆写规则的监听器，也即解订阅相应<code>configurators 类</code>节点；</p>
</li>
<li class="has-source-line data-line-stdin-540">
<p>删除用于同步<code>配置中心</code>覆写规则的监听器，也即解订阅相应的<code>“/({namespace} | dubbo)/config/dubbo/{interfaceName}[:{version}][:{group}].configurators”</code>节点；</p>
</li>
<li class="has-source-line data-line-stdin-541">
<p>最后利用线程池异步调用<code>exporter.unexport()</code>方法最终完成销毁处理，其中<code>exporter</code>是用于完成服务实例的本机销毁处理的；</p>
</li>
</ol>
</div>
<div class="listingblock has-source-line data-line-stdin-544">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">ExporterChangeableWrapper</span>&lt;T&gt; <span style="color:#088;font-weight:bold">implements</span> Exporter&lt;T&gt; {
    ...
    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> unexport() {
        <span style="color:#0a8;font-weight:bold">String</span> key = getCacheKey(<span style="color:#950">this</span>.originInvoker);
        bounds.remove(key);

        <span style="color:#0a8;font-weight:bold">Registry</span> registry = RegistryProtocol.INSTANCE.getRegistry(originInvoker);
        <span style="color:#080;font-weight:bold">try</span> {
            registry.unregister(registerUrl);
        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#0a8;font-weight:bold">Throwable</span> t) {
            logger.warn(t.getMessage(), t);
        }
        <span style="color:#080;font-weight:bold">try</span> {
            NotifyListener listener = RegistryProtocol.INSTANCE
                .overrideListeners.remove(subscribeUrl);
            registry.unsubscribe(subscribeUrl, listener);
            DynamicConfiguration.getDynamicConfiguration()
                    .removeListener(subscribeUrl.getServiceKey() + CONFIGURATORS_SUFFIX,
                            serviceConfigurationListeners.get(subscribeUrl.getServiceKey()));
        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#0a8;font-weight:bold">Throwable</span> t) {
            logger.warn(t.getMessage(), t);
        }

        executor.submit(() -&gt; {
            <span style="color:#080;font-weight:bold">try</span> {
                <span style="color:#339;font-weight:bold">int</span> timeout = ConfigurationUtils.getServerShutdownTimeout();
                <span style="color:#080;font-weight:bold">if</span> (timeout &gt; <span style="color:#00D">0</span>) {
                    logger.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Waiting </span><span style="color:#710">"</span></span> + timeout
                        + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">ms for registry to notify all consumers before unexport. </span><span style="color:#710">"</span></span> +
                            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Usually, this is called when you use dubbo API</span><span style="color:#710">"</span></span>);
                    <span style="color:#0a8;font-weight:bold">Thread</span>.sleep(timeout);
                }
                exporter.unexport();
            } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#0a8;font-weight:bold">Throwable</span> t) {
                logger.warn(t.getMessage(), t);
            }
        });
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-587">
<p>解注册或者解订阅是一个网络I/O操作，总共涉及 3 个这样的操作，耗时相对会比较长，且没法准确预估全部完成的时间，因此使用了配置的大概时间延时执行<code>exporter</code>的销毁处理，超时配置为 <code>conf["dubbo.service.shutdown.wait"]</code> 或 <code>conf["dubbo.service.shutdown.wait.seconds"]</code>。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-591">
<p>由上文已知，本机导出的初始服务实例记为<code>originInvoker</code>，此后经通知事件同步覆写规则时都是基于它执行刷新进而得到一个新的<code>&lt;Invoker&lt;T&gt;, Exporter&lt;T&gt;&gt;</code>对象组合的。因而<code>originInvoker</code>被声明成了<code>final</code>型，而<code>exporter</code>却是可变的，而这也是类名含有<code>Changeable</code>字样的奥义所在，如下所示：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-593">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">ExporterChangeableWrapper</span>&lt;T&gt; <span style="color:#088;font-weight:bold">implements</span> Exporter&lt;T&gt; {
    ...
    private <span style="color:#088;font-weight:bold">final</span> Invoker&lt;T&gt; originInvoker;
    <span style="color:#088;font-weight:bold">private</span> Exporter&lt;T&gt; exporter;
    <span style="color:#088;font-weight:bold">public</span> ExporterChangeableWrapper(Exporter&lt;T&gt; exporter, Invoker&lt;T&gt; originInvoker) {
        <span style="color:#950">this</span>.exporter = exporter;
        <span style="color:#950">this</span>.originInvoker = originInvoker;
    }

    <span style="color:#088;font-weight:bold">public</span> Invoker&lt;T&gt; getOriginInvoker() {
        <span style="color:#080;font-weight:bold">return</span> originInvoker;
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> Invoker&lt;T&gt; getInvoker() {
        <span style="color:#080;font-weight:bold">return</span> exporter.getInvoker();
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setExporter(Exporter&lt;T&gt; exporter) {
        <span style="color:#950">this</span>.exporter = exporter;
    }

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">URL</span> subscribeUrl;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">URL</span> registerUrl;

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setSubscribeUrl(<span style="color:#0a8;font-weight:bold">URL</span> subscribeUrl) {
        <span style="color:#950">this</span>.subscribeUrl = subscribeUrl;
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setRegisterUrl(<span style="color:#0a8;font-weight:bold">URL</span> registerUrl) {
        <span style="color:#950">this</span>.registerUrl = registerUrl;
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-628">
<p>源码最后呈现的<code>subscribeUrl</code>和<code>registerUrl</code>，一个用于订阅<code>configurators 类</code>节点，另一个则用于注册一个<code>provider 类</code>节点。由于<code>provider 类</code>节点是一个服务实例的可公示数据的完整URL表示，因此经过应用覆写规则后，<code>registerUrl</code>是会发生变化的。</p>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-630">
<h3 id="_invokerdelegatet">InvokerDelegate&lt;T&gt;</h3>
<div class="paragraph has-source-line data-line-stdin-632">
<p>可以说，<code>InvokerDelegate&lt;T&gt;</code>这个公有静态内部类是整个<code>RegistryProtocol</code>源码中涉及代码最少，但理解上却最不直观的一个类，为啥需要它，它到底有啥作用？</p>
</div>
<div class="paragraph has-source-line data-line-stdin-634">
<p>先看看其父类<code>InvokerWrapper&lt;T&gt;</code>，<code>Wrapper</code>的含义是采用委托方式实现某一接口方法，而被委托对象(<sub>实现同一接口</sub>)的行为被封装了，<code>Wrapper</code>类可以对其行为进行改写或者隐藏，如下述源码所示，被委托的<code>invoker</code>变量是有自己的<code>getUrl()</code>实现的，但是<code>InvokerWrapper&lt;T&gt;</code>却利用构造函数传入的<code>url</code>将其隐藏了，调用同一方法将会得到该<code>url</code>。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-636">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">InvokerWrapper</span>&lt;T&gt; <span style="color:#088;font-weight:bold">implements</span> Invoker&lt;T&gt; {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> Invoker&lt;T&gt; invoker;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">URL</span> url;

    <span style="color:#088;font-weight:bold">public</span> InvokerWrapper(Invoker&lt;T&gt; invoker, <span style="color:#0a8;font-weight:bold">URL</span> url) {
        <span style="color:#950">this</span>.invoker = invoker;
        <span style="color:#950">this</span>.url = url;
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">URL</span> getUrl() {
        <span style="color:#080;font-weight:bold">return</span> url;
    }
    ...<span style="color:#777">//利用委托机制直接实现所有Invoker&lt;T&gt;接口的其它方法</span>
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-656">
<p>再回到<code>InvokerDelegate&lt;T&gt;</code>本身，首先它新声明的<code>invoker</code>属性“覆写”了父类所定义的，行为上没有发生变化，但是解决了父类中由于<code>invoker</code>被申明为私有而无法访问的问题。其它相比而言只增加了一个<code>getInvoker()</code>方法，原因是内嵌的<code>invoker</code>可能也是一个<code>InvokerDelegate&lt;T&gt;</code>类对象，这种情况下只有通过<code>instanceof</code>类型判断才能递归获取到最初被封装的那个<code>Invoker&lt;T&gt;</code>类对象。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-659">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">InvokerDelegate</span>&lt;T&gt; <span style="color:#088;font-weight:bold">extends</span> InvokerWrapper&lt;T&gt; {
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> Invoker&lt;T&gt; invoker;

    <span style="color:#088;font-weight:bold">public</span> InvokerDelegate(Invoker&lt;T&gt; invoker, <span style="color:#0a8;font-weight:bold">URL</span> url) {
        <span style="color:#950">super</span>(invoker, url);
        <span style="color:#950">this</span>.invoker = invoker;
    }

    <span style="color:#088;font-weight:bold">public</span> Invoker&lt;T&gt; getInvoker() {
        <span style="color:#080;font-weight:bold">if</span> (invoker <span style="color:#080;font-weight:bold">instanceof</span> InvokerDelegate) {
            <span style="color:#080;font-weight:bold">return</span> ((InvokerDelegate&lt;T&gt;) invoker).getInvoker();
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#080;font-weight:bold">return</span> invoker;
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-678">
<p>上文中关于同步覆写规则处理的剖析中，有出现过类似的一段代码，根据其应用，我们知道其目的是为了获取最初服务实例在本地导出时所输入的<code>providerUrl</code>。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-680">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OverrideListener</span> <span style="color:#088;font-weight:bold">implements</span> NotifyListener {
    ...
    public <span style="color:#088;font-weight:bold">synchronized</span> <span style="color:#339;font-weight:bold">void</span> doOverrideIfNecessary() {
        <span style="color:#088;font-weight:bold">final</span> Invoker&lt;?&gt; invoker;
        <span style="color:#080;font-weight:bold">if</span> (originInvoker <span style="color:#080;font-weight:bold">instanceof</span> InvokerDelegate) {
            invoker = ((InvokerDelegate&lt;?&gt;) originInvoker).getInvoker();
        } <span style="color:#080;font-weight:bold">else</span> {
            invoker = originInvoker;
        }
        ...
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-695">
<h3 id="_dolocalexport和dochangelocalexport"><code>doLocalExport(…​)</code>和<code>doChangeLocalExport(…​)</code></h3>
<div class="paragraph has-source-line data-line-stdin-697">
<p>见名知意，二者对应的是本地的导出处理，分别对应了服务实例的初始导出过程和同步覆写规则时的重新导出过程。显然，这里的本地导出的主要过程是由<code>protocol</code>，比如说<code>DubboProtocol</code>来完成的。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-699">
<p>上述曾提及Dubbo的框架代理层为当前微服务所最初产生<code>Invoker&lt;T&gt;</code>实例被记为<code>originInvoker</code>，其URL数据表示是一个包含了与注册相关信息的完整<code>regUrl</code>，真正代表本尊的URL数据<code>providerUrl</code>需要另行解析，并且此后随着来自于配置中心的覆写规则同步，它会发生变化。然而，业务逻辑是随代码固化下来了的，能改变的是相关配置，比如实例所运行的上下文环境、业务相关参数，也就是说变化的只是代表<code>originInvoker</code>的URL数据。因此具体实现时，<code>originInvoker</code>会被封入到一个<code>InvokerDelegate&lt;T&gt;</code>类型对象中。一方面可以确保框架后续流程中能够直接获取到服务实例的<code>providerUrl</code>，避免每次都需要在<code>regUrl</code>上另加解析，顶层并不需要或者关心该<code>regUrl</code>。另一方面，框架代理层只需执行一次<code>originInvoker</code>的生成处理。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-701">
<p>章节<a href="http://localhost:63342/ead61b63-b0a6-4ff2-a49a-86be75ccfd1a/source?file=%2FUsers%2Flrq%2FWorkspace%2Fmy_pub_prjs%2FDiving-In-Dubbo%2F%E3%80%90%E5%8D%81%E4%B8%83%E3%80%91Dubbo%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA.adoc&amp;mac=d8lKLKK9ZHIOOHjwwlukRHBI83z9v9gv3qupFT9f8NM=&amp;projectUrl=%2FUsers%2Flrq%2FWorkspace%2Fmy_pub_prjs%2FDiving-In-Dubbo#sec_ExporterChangeableWrapper">ExporterChangeableWrapper</a>中已经阐明微服务实例的销毁是一个必须的I/O流程，销毁是以<code>originInvoker</code>作为参考坐标系的，即便是在并发环境下，来自注册中心或配置中心的覆写规则同步事件可能随时发生，但任意时刻于特定微服务来说当前应用只会存在一个对应的<code>Invoker&lt;T&gt;</code>实例，初次导出时是<code>originInvoker</code>，此后则是一个封入了它的<code>InvokerDelegate&lt;T&gt;</code>类型的包装对象<code>delegateInvoker</code>，。因而组合了<code>originInvoker</code>、<code>delegateInvoker</code>、<code>delegateInvoker’sExporter</code>三者的<code>ExporterChangeableWrapper</code>类型对象会使用<code>ConcurrentMap&lt;String, ExporterChangeableWrapper&lt;?&gt;&gt;</code>类型的安全并发容器<code>bounds</code>做存取处理，键取<code>URL.decode(regUrl["export"])[^["dynamic", "enabled"]]</code>。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-704">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">ConcurrentMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, ExporterChangeableWrapper&lt;?&gt;&gt; bounds = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ConcurrentHashMap</span>&lt;&gt;();

<span style="color:#088;font-weight:bold">private</span> &lt;T&gt; ExporterChangeableWrapper&lt;T&gt; doLocalExport(<span style="color:#088;font-weight:bold">final</span> Invoker&lt;T&gt; originInvoker, <span style="color:#0a8;font-weight:bold">URL</span> providerUrl) {
    <span style="color:#0a8;font-weight:bold">String</span> key = getCacheKey(originInvoker);

    <span style="color:#080;font-weight:bold">return</span> (ExporterChangeableWrapper&lt;T&gt;) bounds.computeIfAbsent(key, s -&gt; {
        Invoker&lt;?&gt; invokerDelegate = <span style="color:#080;font-weight:bold">new</span> InvokerDelegate&lt;&gt;(originInvoker, providerUrl);
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> ExporterChangeableWrapper&lt;&gt;(
            (Exporter&lt;T&gt;)protocol.export(invokerDelegate), originInvoker);
    });
}

<span style="color:#088;font-weight:bold">private</span> &lt;T&gt; ExporterChangeableWrapper doChangeLocalExport(<span style="color:#088;font-weight:bold">final</span> Invoker&lt;T&gt; originInvoker, <span style="color:#0a8;font-weight:bold">URL</span> newInvokerUrl) {
    <span style="color:#0a8;font-weight:bold">String</span> key = getCacheKey(originInvoker);
    <span style="color:#088;font-weight:bold">final</span> ExporterChangeableWrapper&lt;T&gt; exporter = (ExporterChangeableWrapper&lt;T&gt;) bounds.get(key);
    <span style="color:#080;font-weight:bold">if</span> (exporter == <span style="color:#069">null</span>) {
        logger.warn(<span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalStateException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">error state, exporter should not be null</span><span style="color:#710">"</span></span>));
    } <span style="color:#080;font-weight:bold">else</span> {
        <span style="color:#088;font-weight:bold">final</span> Invoker&lt;T&gt; invokerDelegate = <span style="color:#080;font-weight:bold">new</span> InvokerDelegate&lt;T&gt;(originInvoker, newInvokerUrl);
        exporter.setExporter(protocol.export(invokerDelegate));
    }
    <span style="color:#080;font-weight:bold">return</span> exporter;
}


<span style="color:#777">//URL.decode(regUrl["export"])[^["dynamic", "enabled"]]</span>
<span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> getCacheKey(<span style="color:#088;font-weight:bold">final</span> Invoker&lt;?&gt; originInvoker) {
    <span style="color:#0a8;font-weight:bold">URL</span> providerUrl = getProviderUrl(originInvoker);
    <span style="color:#0a8;font-weight:bold">String</span> key = providerUrl.removeParameters(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">dynamic</span><span style="color:#710">"</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">enabled</span><span style="color:#710">"</span></span>).toFullString();
    <span style="color:#080;font-weight:bold">return</span> key;
}</code></pre>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-738">
<h3 id="_exportinvokert导出主流程"><code>export(Invoker&lt;T&gt;)</code>导出主流程</h3>
<div class="paragraph has-source-line data-line-stdin-740">
<p>终于，在理清楚所有细节后，可以进入到主流程看看具体的导出过程了。下述是所有相关剩下的源码，整体过程如下：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-742">
<ol class="arabic">
<li class="has-source-line data-line-stdin-742">
<p>首先，基于从框架代理层生成的<code>originInvoker</code>对象获得<code>regUrl</code>、<code>providerUrl</code>、<code>overrideSubscribeUrl</code>这 3 个URL数据；</p>
</li>
<li class="has-source-line data-line-stdin-743">
<p>然后，创建并增设用于从配置中心同步覆写规则的两级监听器，并完成<code>providerUrl</code>的初始化时的改写处理，基于已改写的<code>providerUrl</code>执行<code>originInvoker</code>的本地导出处理，得到 <code>ExporterChangeableWrapper&lt;T&gt;</code> 类型的<code>exporter</code>对象；</p>
</li>
<li class="has-source-line data-line-stdin-744">
<p>紧接着去除<code>providerUrl</code>中只用于服务实例本地总线参数，生成<code>registeredProviderUrl</code>，同时获取应用层提供的注册中心实例<code>registry</code>，使用二者完成完成当前服务实例到注册中心的登记处理；</p>
</li>
<li class="has-source-line data-line-stdin-745">
<p>将第二个步骤产生的<code>OverrideListener<sub>（实现了</sub></code>NotifyListener<code>接口)</code>监听器设置到<code>registry</code>的<code>overrideSubscribeUrl</code>这个<code>configurators</code>类型的页节点上；</p>
</li>
<li class="has-source-line data-line-stdin-746">
<p>最后，完善<code>exporter</code>对象的填值处理，创建并返回一个封装了它的<code>DestroyableExporter&lt;T&gt;</code>对象；</p>
</li>
</ol>
</div>
<div class="listingblock has-source-line data-line-stdin-750">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">URL</span>, NotifyListener&gt; overrideListeners = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ConcurrentHashMap</span>&lt;&gt;();

<span style="color:#088;font-weight:bold">public</span> &lt;T&gt; Exporter&lt;T&gt; <span style="color:#080;font-weight:bold">export</span>(<span style="color:#088;font-weight:bold">final</span> Invoker&lt;T&gt; originInvoker) <span style="color:#088;font-weight:bold">throws</span> RpcException {
    <span style="color:#0a8;font-weight:bold">URL</span> registryUrl = getRegistryUrl(originInvoker);
    <span style="color:#777">// url to export locally</span>
    <span style="color:#0a8;font-weight:bold">URL</span> providerUrl = getProviderUrl(originInvoker);

    <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">URL</span> overrideSubscribeUrl = getSubscribedOverrideUrl(providerUrl);
    <span style="color:#088;font-weight:bold">final</span> OverrideListener overrideSubscribeListener =
        <span style="color:#080;font-weight:bold">new</span> OverrideListener(overrideSubscribeUrl, originInvoker);
    overrideListeners.put(overrideSubscribeUrl, overrideSubscribeListener);

    providerUrl = overrideUrlWithConfig(providerUrl, overrideSubscribeListener);
    <span style="color:#088;font-weight:bold">final</span> ExporterChangeableWrapper&lt;T&gt; exporter = doLocalExport(originInvoker, providerUrl);

    <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Registry</span> registry = getRegistry(originInvoker);
    <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">URL</span> registeredProviderUrl = getRegisteredProviderUrl(providerUrl, registryUrl);
    ProviderInvokerWrapper&lt;T&gt; providerInvokerWrapper =
        ProviderConsumerRegTable.registerProvider(originInvoker, registryUrl, registeredProviderUrl);
    <span style="color:#339;font-weight:bold">boolean</span> register = providerUrl.getParameter(REGISTER_KEY, <span style="color:#069">true</span>);
    <span style="color:#080;font-weight:bold">if</span> (register) {
        register(registryUrl, registeredProviderUrl);
        providerInvokerWrapper.setReg(<span style="color:#069">true</span>);
    }

    registry.subscribe(overrideSubscribeUrl, overrideSubscribeListener);

    exporter.setRegisterUrl(registeredProviderUrl);
    exporter.setSubscribeUrl(overrideSubscribeUrl);
    <span style="color:#777">//Ensure that a new exporter instance is returned every time export</span>
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> DestroyableExporter&lt;&gt;(exporter);
}

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> register(<span style="color:#0a8;font-weight:bold">URL</span> registryUrl, <span style="color:#0a8;font-weight:bold">URL</span> registeredProviderUrl) {
    <span style="color:#0a8;font-weight:bold">Registry</span> registry = registryFactory.getRegistry(registryUrl);
    registry.register(registeredProviderUrl);
}

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> unregister(<span style="color:#0a8;font-weight:bold">URL</span> registryUrl, <span style="color:#0a8;font-weight:bold">URL</span> registeredProviderUrl) {
    <span style="color:#0a8;font-weight:bold">Registry</span> registry = registryFactory.getRegistry(registryUrl);
    registry.unregister(registeredProviderUrl);
}</code></pre>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-795">
<h3 id="_reexportinvokerturl重新导出主流程"><code>reExport(Invoker&lt;T&gt;,URL)</code>重新导出主流程</h3>
<div class="paragraph has-source-line data-line-stdin-797">
<p>如下述源码所示，重新导出的流程实际实际上很简单，首先执行本地的重导入处理，然后只是简单的将当前服务实例已应用过同步事件覆写规则的<code>registeredProviderUrl</code>设给最初服务实例在本地导出时就生成了的<code>ExporterChangeableWrapper</code>类型对象<code>exporter</code>。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-800">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> &lt;T&gt; <span style="color:#339;font-weight:bold">void</span> reExport(<span style="color:#088;font-weight:bold">final</span> Invoker&lt;T&gt; originInvoker, <span style="color:#0a8;font-weight:bold">URL</span> newInvokerUrl) {
    <span style="color:#777">// update local exporter</span>
    ExporterChangeableWrapper exporter = doChangeLocalExport(originInvoker, newInvokerUrl);
    <span style="color:#777">// update registry</span>
    <span style="color:#0a8;font-weight:bold">URL</span> registryUrl = getRegistryUrl(originInvoker);
    <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">URL</span> registeredProviderUrl = getRegisteredProviderUrl(newInvokerUrl, registryUrl);

    ...<span style="color:#777">//TAG:x</span>

    exporter.setRegisterUrl(registeredProviderUrl);
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-814">
<p>然而问题来了，之所以重新导出的原因是运维人员在配置中心改写了相关配置项，从而导致当前微服务实例的覆写规则同步事件收到了通知，这又进一步引起了<code>originInvoker</code>相关的URL数据的变化。我们都清楚一个微服务的实例是作为临时页节点存储在注册中心的，节点是该实例的完整URL数据表示，此时本地版本已经发生了变化，而注册中心还维持着原样，这肯定会导致不一致。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-816">
<p>其实上述源码中<code>TAG:x</code>处故意给删除了如下一段代码，基本意思是在本地会有一个<code>ProviderConsumerRegTable</code>缓存容器，类似于注册表，就<code>originInvoker</code>而言，如果注册表中已经记录的<code>registeredProviderUrl</code>和当前刷新后的不一致，便先使用旧的值从注册中心执行解注册处理，然后用心的值做登记。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-818">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> &lt;T&gt; <span style="color:#339;font-weight:bold">void</span> reExport(<span style="color:#088;font-weight:bold">final</span> Invoker&lt;T&gt; originInvoker, <span style="color:#0a8;font-weight:bold">URL</span> newInvokerUrl) {
    ...
    <span style="color:#777">//decide if we need to re-publish</span>
    ProviderInvokerWrapper&lt;T&gt; providerInvokerWrapper =
        ProviderConsumerRegTable.getProviderWrapper(registeredProviderUrl, originInvoker);
    ProviderInvokerWrapper&lt;T&gt; newProviderInvokerWrapper =
        ProviderConsumerRegTable.registerProvider(originInvoker, registryUrl, registeredProviderUrl);

    <span style="color:#080;font-weight:bold">if</span> (providerInvokerWrapper.isReg() &amp;&amp; !registeredProviderUrl.equals(
            providerInvokerWrapper.getProviderUrl())) {
        unregister(registryUrl, providerInvokerWrapper.getProviderUrl());
        register(registryUrl, registeredProviderUrl);
        newProviderInvokerWrapper.setReg(<span style="color:#069">true</span>);
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-837">
<p><code>ProviderInvokerWrapper</code>和<code>ProviderConsumerRegTable</code>相关实现后面有机会再聊。</p>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-839">
<h3 id="_registryprotocoldestroy"><code>RegistryProtocol#destroy()</code></h3>
<div class="paragraph has-source-line data-line-stdin-841">
<p><code>RegistryProtocol</code>的销毁处理显得相当干净利落，先是从<code>bounds</code>取出所有所有的<code>Exporter</code>执行其<code>unexport()</code>，然后删除到配置中心的应用级别的覆写规则同步监听器。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-844">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> destroy() {
    <span style="color:#0a8;font-weight:bold">List</span>&lt;Exporter&lt;?&gt;&gt; exporters = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ArrayList</span>&lt;Exporter&lt;?&gt;&gt;(bounds.values());
    <span style="color:#080;font-weight:bold">for</span> (Exporter&lt;?&gt; exporter : exporters) {
        exporter.unexport();
    }
    bounds.clear();

    DynamicConfiguration.getDynamicConfiguration().removeListener(
        ApplicationModel.getApplication() + CONFIGURATORS_SUFFIX, providerConfigurationListener);
}</code></pre>
</div>
</div>
<hr>
<div class="paragraph has-source-line data-line-stdin-858">
<p>完结</p>
</div>
</div>
</div>
</div>
</div><script src="res_files/js/scrollToElement.js"></script>
<script src="res_files/js/processLinks.js"></script>
<script src="res_files/js/pickSourceLine.js"></script>
<script type="text/x-mathjax-config;executed=true">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="res_files/js/MathJax.js"></script>
<div id="color-picker-wrap" style="display: none; position: fixed; top: 0px; left: 0px; z-index: 9999;"><!----></div></body></html>