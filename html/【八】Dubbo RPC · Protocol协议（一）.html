
<!-- saved from url=(0354)http://localhost:63342/ead61b63-b0a6-4ff2-a49a-86be75ccfd1a/source?file=%2FUsers%2Flrq%2FWorkspace%2Fmy_pub_prjs%2FDiving-In-Dubbo%2F%E3%80%90%E5%85%AB%E3%80%91Dubbo+RPC+%C2%B7+Protocol%E5%8D%8F%E8%AE%AE%EF%BC%88%E4%B8%80%EF%BC%89.adoc&mac=0zfpjAGPyc0RG8Lig9SgXQ1V+5b10jmCQKdASVAV4VM=&projectUrl=%2FUsers%2Flrq%2FWorkspace%2Fmy_pub_prjs%2FDiving-In-Dubbo -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}

</style>
<link rel="stylesheet" href="res_files/css/font-awesome.min.css"><link rel="stylesheet" href="res_files/css/dejavu.css"><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head><body><div id="MathJax_Message" style="display: none;"></div><div id="content">
<h1>Dubbo RPC 之 Protocol协议层（一）</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-3">
<p>此前几乎所有的关于Dubbo实现的剖析文章均有提到，Dubbo是一个RPC通讯框架，直白一点说就是开发人员在进行分布式开发时，可以像调用本地方法一样对远端机器提供的服务发起调用。这个过程中所有关于网络编程的具体细节都被框架给封装了，对上面的应用层屏蔽了细节，如果开发人员不细究底层实现原理，基本会对其无感。Dubbo的RPC框架层担任的正是这个封装过程，将顶端应用层<sup>Business</sup>的本地调用转换为对底端远端层<sup>Remoting</sup>的远程调用，如下图所示，整个RPC框架层被细分成了7层，占据了整个Dubbo实现的很大篇幅，本文主要聚焦于阐述<strong>Protocol</strong>这一层的具体实现。</p>
</div>
<div class="imageblock has-source-line data-line-stdin-5">
<div class="content">
<img src="res_files/imgs/8_image" alt="Dubbo Framework Protocol" width="650">
</div>
<div class="title">图：Dubbo Framework Protocol</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-7">
<h2 id="_协议层由来">协议层由来</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-9">
<p>两个实体若要能相互通讯，就必要约定某种共同的交流语言，就像两位不会讲彼此语言的小伙要完成对话，他们可以约定用中文、英文或者其他语言交流，不会所用语言的一方或者两方，要么找个翻译，要么使用Google手机实时翻译。从这个场景中可以看出，在约定了交流语种的前提下，实际参与会话的实体不一定得懂该语种，可以通过第三方代理完成。在软件领域，这个用于完成对话的工具<sub>举例场景中的自然语言</sub>被认为是一种契约。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-11">
<p>分布式应用开发中，所涉服务可能由多个团队完成，甚至用的都不是同一种编程语言，为了对付这种情况，Dubbo的RPC体系中专门提炼了一个可以扩展的<code>Protocol</code>协议层。众所周知，比如Http是被普遍支持的通讯协议，只要提供支持，跨语种的通讯就能被轻松解决。也就是说Dubbo中的远端请求实际上不限于网络请求，也可以是跨两个JVM的IPC进程间请求，Dubbo的典型特征是“<span class="big">微内核、可扩展</span>”，<code>Protocol</code>更是将这种风格体现得淋漓尽致，其内置的的支持实现有：</p>
</div>
<div class="exampleblock has-source-line data-line-stdin-13">
<div class="content">
<div class="ulist has-source-line data-line-stdin-14">
<ul>
<li class="has-source-line data-line-stdin-14">
<p>o.a.d.r.p.injvm.<code>InjvmProtocol</code>：用于同一个JVM中的客户端和服务端通讯</p>
</li>
<li class="has-source-line data-line-stdin-15">
<p>o.a.d.r.p.dubbo.<code>DubboProtocol</code>：默认实现</p>
</li>
<li class="has-source-line data-line-stdin-16">
<p>o.a.d.r.p.rmi.<code>RmiProtocol</code>：跨JVM的原生远程过程调用</p>
</li>
<li class="has-source-line data-line-stdin-17">
<p>o.a.d.r.p.http.<code>HttpProtocol</code>：HTTP协议支持</p>
</li>
<li class="has-source-line data-line-stdin-18">
<p>o.a.d.r.p.http.hessian.<code>HessianProtocol</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-21">
<p>官网中有关于<code>Protocol</code>的介绍相当简洁，如下：</p>
</div>
<div class="quoteblock has-source-line data-line-stdin-22">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-24">
<p>RPC 协议扩展，封装远程调用细节。</p>
</div>
</blockquote>
</div>
<div class="paragraph has-source-line data-line-stdin-27">
<p>简短一句话说明了其主要职责，从代码的角度看是这么一个过程——“客户端程序拥有一套服务端提供的服务接口<sup>interface</sup>，而接口的具体实现在服务端，RPC将本地的接口调用转换为对服务端的出站请求，而协议层将远端请求有关的具体细节封装起来，当请求抵达服务端后，协议层将对应的入站请求转为对接口的调用，也就是说此时在服务端完成了接口实现的本地调用”。细究之，协议层完成的客户端出站请求封装和服务端入站请求封装是两个互为逆向的过程。</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-29">
<h2 id="_关键组件">关键组件</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-31">
<p>从上文的表述知道，<code>Protocol</code>实际要做的是一个转译操作，完成<span class="big">应用层中的原生的Java源码方法调用</span>到<span class="big">网络层的远端通讯</span>间的相互转换过程<sub>由通讯双方选定协议支持</sub>。我们都清楚框架始终是某类通用问题的解决方案，这个RPC肯定是面向所有Java能够表达的方法签名的。但尽管方法的签名表示有着万千变化，但从更大的粒度而言，实际上概括起来又只有出参、入参、方法名这3个基本元素<sub>包括出参入参类型</sub>，熟悉Java反射的人不难明白这点，简言之就是任何一个方法签名都可以转换成一个Method对象，更进一步讲这个过程不需要关心方法或者说业务接口的具体细节，剩下的就是如何解决在方法和远端请求<sub>入站和出站</sub>间进行转换的问题，它也是<code>Protocol</code>所关注的重点。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-33">
<p>综上，Dubbo抽离出如下几个关键组件接口：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-35">
<ol class="arabic">
<li class="has-source-line data-line-stdin-35">
<p><strong>Invocation</strong> &amp; <strong>Result</strong>: 分别用于封装原生Java代码中方法接口的中入参和出参，包括参数类型，二者组合起来便能表达一次方法调用。</p>
</li>
<li class="has-source-line data-line-stdin-37">
<p><strong>Invoker</strong>: Dubbo中每一个<code>Invoker</code>实例代表一个服务，而后者对应一个<code>interface</code>接口，接口中的所有方法均可以用如下语句表达：</p>
<div class="literalblock has-source-line data-line-stdin-39">
<div class="content">
<pre>Result invoke(Invocation invocation) throws RpcException;</pre>
</div>
</div>
</li>
<li class="has-source-line data-line-stdin-41">
<p><strong>Protocol</strong>: 支持扩展，框架层中从底往上首次将服务的这个概念引入，类似<code>Transporter</code>、<code>Exchanger</code>等，处于Dubbo架构的中分线位置，是框架分层的一个概念，根据此前剖析文章不难看出，其实现是横跨客户端和服务端的。</p>
<div class="olist loweralpha has-source-line data-line-stdin-42">
<ol class="loweralpha" type="a">
<li class="has-source-line data-line-stdin-42">
<p>客户端需要根据接口类和其配置总线参数获得一个<code>Invoker</code>实例，供上层将原生的Java接口调用转换为远端请求，因此<code>Protocol</code>有责任为其提供一个封装了网络层用于向彼端发送网络请求的<code>ExchangeClient</code>实例。</p>
</li>
<li class="has-source-line data-line-stdin-43">
<p>服务端则需要完成服务的暴露处理，当来自客户端的<code>Invoker</code>的请求抵达时<sub>网络请求</sub>，Dubbo会将来自彼端的请求转换成<code>Invocation</code>对象，以便<code>Protocol</code>根据其中信息获得一个由Dubbo框架使用动态代理模式实现的<code>Invoker</code>实例，随后便可以使用该实例间接完成对业务接口实现的调用，获得响应结果后，经过网络层处理发回给客户端。</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-45">
<h2 id="_关键接口定义">关键接口定义</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-47">
<p>在清楚了协议层的具体职责与设计初衷后，以下按照以往惯例，我们的分析仍然聚焦在Dubbo的默认支持实现上，跟上文顺序相反，由简单到复杂，逐步深入，本章节先大概介绍一下各个结合定义，下一章节则着重剖析具体实现。</p>
</div>
<div class="sect2 has-source-line data-line-stdin-49">
<h3 id="_服务接口入参封装体_invocation">服务接口入参封装体 <code>Invocation</code></h3>
<div class="paragraph has-source-line data-line-stdin-51">
<p><code>Invocation</code>用于封装Java服务接口中的入参，包括了入参类型和方法名称。《Dubbo远程通讯 · 网络传输层》一文中曾经提到一个特性，就是用于实际通讯的通道<code>Channel</code>可以像<code>ThreadLocal</code>一样拥有自己的上下文本地变量，当前框架层利用它可以存储一些用于框架功能增强或流程控制的参数，它的作用范围是绑定在<code>Channel</code>实例上，容易确保线程安全，保持了框架实现的优雅干净。同样<code>Protocol</code>协议层的表示每一次接口方法调用的<code>Invocation</code>也可以存取其本地变量，被视作附属参数<code><strong>attachment</strong></code>。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-54">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">Invocation</span> {

<span style="color:#777">//==================================</span>
<span style="color:#777">// 表征接Java接口中的入参，包括了入参类型和方法名称</span>
<span style="color:#777">//==================================</span>
    <span style="color:#0a8;font-weight:bold">String</span> getMethodName();

    <span style="color:#0a8;font-weight:bold">Class</span>&lt;?&gt;<span style="color:#339;font-weight:bold">[]</span> getParameterTypes();

    <span style="color:#0a8;font-weight:bold">Object</span><span style="color:#339;font-weight:bold">[]</span> getArguments();

<span style="color:#777">//==================================</span>
<span style="color:#777">// 用于存取接口调用的本地附属参数</span>
<span style="color:#777">//==================================</span>
    <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; getAttachments();

    <span style="color:#339;font-weight:bold">void</span> setAttachment(<span style="color:#0a8;font-weight:bold">String</span> key, <span style="color:#0a8;font-weight:bold">String</span> value);

    <span style="color:#339;font-weight:bold">void</span> setAttachmentIfAbsent(<span style="color:#0a8;font-weight:bold">String</span> key, <span style="color:#0a8;font-weight:bold">String</span> value);

    <span style="color:#0a8;font-weight:bold">String</span> getAttachment(<span style="color:#0a8;font-weight:bold">String</span> key);

    <span style="color:#0a8;font-weight:bold">String</span> getAttachment(<span style="color:#0a8;font-weight:bold">String</span> key, <span style="color:#0a8;font-weight:bold">String</span> defaultValue);

<span style="color:#777">//==================================</span>
<span style="color:#777">// 获取实现当前Invocation调度的服务接口调度器Invoker</span>
<span style="color:#777">//==================================</span>
    Invoker&lt;?&gt; getInvoker();

}</code></pre>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-87">
<h3 id="_服务接口出参封装体_result">服务接口出参封装体 <code>Result</code></h3>
<div class="paragraph has-source-line data-line-stdin-89">
<p><code>Result</code>用于封装服务接口方法调用的结果，也就是出参，在Java中一个方法调用只会返回一个结果对象，<code>Object</code>可以代表所有类型的对象，如果业务逻辑处理异常，会抛出<code>XXXException</code>，其实它也可以被认为是另外一种形式的出参。虽然两种出参都可以统一为<code>Object</code>对象，但一般上框架会分别对待，有利于框架实现。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-91">
<p>另外从《Dubbo远程通讯 · 信息交换层》已经知悉，Dubbo为了充分压榨硬件性能、确保很高的吞吐率，在<span class="big">信息交换层</span>已经做了同步转异步的处理，因此对应到当前的协议层实现来说，RPC方法调用的返回结果也是需要异步获取的。这种异步实现是通过<code>CompleteableFuture&lt;T&gt; → CompletionStage&lt;T&gt;</code>达成的，理论上其和<code>Result</code>是一种组合关系，由于二者实例之间的<code>一对一</code>的绑定关系，外加资源回收处理的便利性考量，Dubbo使用了接口扩展来绑定这种关系，这样一来<code>Result</code>成了一个行为类。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-93">
<p>同样，在具体实现细节中，请求操作和等待响应操作实际上是两个相互独立的阶段，二者在时间发生有着严格的先后顺序，同请求阶段一样，它需要存取本地参数，但不应共享，因此接口中也定义了数个存取Result本地附属参数<code><strong>attachment</strong></code>的方法。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-95">
<p>另外为了请求方的操作的便利性，比如说使用默认提供值同步获取结果，在调用方的上下文中以响应式获取结果。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-98">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">Result</span> <span style="color:#088;font-weight:bold">extends</span> CompletionStage&lt;<span style="color:#0a8;font-weight:bold">Result</span>&gt;, <span style="color:#0a8;font-weight:bold">Future</span>&lt;<span style="color:#0a8;font-weight:bold">Result</span>&gt;, <span style="color:#0a8;font-weight:bold">Serializable</span> {

<span style="color:#777">//==================================</span>
<span style="color:#777">// 出参有两种类型，正常结果Object，抛出的异常Exception，处理是否正常需要使用 hasException 提前判断</span>
<span style="color:#777">//==================================</span>
    <span style="color:#0a8;font-weight:bold">Object</span> getValue();

    <span style="color:#339;font-weight:bold">void</span> setValue(<span style="color:#0a8;font-weight:bold">Object</span> value);

    <span style="color:#0a8;font-weight:bold">Throwable</span> getException();

    <span style="color:#339;font-weight:bold">void</span> setException(<span style="color:#0a8;font-weight:bold">Throwable</span> t);

    <span style="color:#339;font-weight:bold">boolean</span> hasException();

    <span style="color:#777">/**
     * Recreate.
     * &lt;p&gt;
     * &lt;code&gt;
     * if (hasException()) {
     * throw getException();
     * } else {
     * return getValue();
     * }
     * &lt;/code&gt;
     *
     * @return result.
     * @throws if has exception throw it.
     */</span>
    <span style="color:#0a8;font-weight:bold">Object</span> recreate() <span style="color:#088;font-weight:bold">throws</span> <span style="color:#0a8;font-weight:bold">Throwable</span>;

<span style="color:#777">//==================================</span>
<span style="color:#777">// 用于存取接口调用的本地附属参数</span>
<span style="color:#777">//==================================</span>
    <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; getAttachments();

    <span style="color:#339;font-weight:bold">void</span> addAttachments(<span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; map);

    <span style="color:#339;font-weight:bold">void</span> setAttachments(<span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; map);

    <span style="color:#0a8;font-weight:bold">String</span> getAttachment(<span style="color:#0a8;font-weight:bold">String</span> key);

    <span style="color:#0a8;font-weight:bold">String</span> getAttachment(<span style="color:#0a8;font-weight:bold">String</span> key, <span style="color:#0a8;font-weight:bold">String</span> defaultValue);

    <span style="color:#339;font-weight:bold">void</span> setAttachment(<span style="color:#0a8;font-weight:bold">String</span> key, <span style="color:#0a8;font-weight:bold">String</span> value);

<span style="color:#777">//==================================</span>
<span style="color:#777">// 要求即时返回结果，若对方还未完成不会等到地方完成，使用提供的值作为Result结果</span>
<span style="color:#777">//==================================</span>
    <span style="color:#777">/**
     * Returns the specified {@code valueIfAbsent} when not complete, or
     * returns the result value or throws an exception when complete.
     *
     * @see CompletableFuture#getNow(Object)
     */</span>
    <span style="color:#0a8;font-weight:bold">Result</span> getNow(<span style="color:#0a8;font-weight:bold">Result</span> valueIfAbsent);
<span style="color:#777">//==================================</span>
<span style="color:#777">// 使用响应式编程在回调中获取对端的处理结果，调用方在调用点持有自己的上下文，便于业务处理</span>
<span style="color:#777">// NOTE: 如名称所示，该方法在回调时，Dubbo会确保它拥有和此前原生方法调用时的上下文信息</span>
<span style="color:#777">//==================================</span>
    <span style="color:#777">/**
     * Add a callback which can be triggered when the RPC call finishes.
     * &lt;p&gt;
     * Just as the method name implies, this method will guarantee the callback
     * being triggered under the same context as when the call was started,
     * see implementation in {@link Result#whenCompleteWithContext(BiConsumer)}
     *
     * @param fn
     * @return
     */</span>
    <span style="color:#0a8;font-weight:bold">Result</span> whenCompleteWithContext(BiConsumer&lt;<span style="color:#0a8;font-weight:bold">Result</span>, <span style="color:#0a8;font-weight:bold">Throwable</span>&gt; fn);

    <span style="color:#080;font-weight:bold">default</span> CompletableFuture&lt;<span style="color:#0a8;font-weight:bold">Result</span>&gt; completionFuture() {
        <span style="color:#080;font-weight:bold">return</span> toCompletableFuture();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-177">
<h3 id="_服务接口调度器_invoker">服务接口调度器 <code>Invoker</code></h3>
<div class="paragraph has-source-line data-line-stdin-179">
<p>服务接口调度器，其作用上文已经介绍过，其实例和服务提供者接口定义是一对一的，通过接口类对象绑定，因此其定义中声明了一个<code>getInterface()</code>方法。另外一个<code>Invoker</code>对象代表了一个微服务，作为微服务它有着自己的生命周期和配置参数<sub>微服务的元数据</sub>，因此接口扩展自<code>Node</code>，使用配置总线`URL`处理配置的存取问题。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-181">
<p>当然<code>Invoker</code>的具体实现上很灵活，就像前面的剖析文章中提到的<code>ChannelHandler</code>，以它为起点实现了微服务的许多其它特性。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-184">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">Invoker</span>&lt;T&gt; <span style="color:#088;font-weight:bold">extends</span> Node {

    <span style="color:#777">/**
     * get service interface.
     *
     * @return service interface.
     */</span>
    <span style="color:#0a8;font-weight:bold">Class</span>&lt;T&gt; getInterface();

    <span style="color:#777">/**
     * invoke.
     *
     * @param invocation
     * @return result
     * @throws RpcException
     */</span>
    <span style="color:#0a8;font-weight:bold">Result</span> invoke(Invocation invocation) <span style="color:#088;font-weight:bold">throws</span> RpcException;

}</code></pre>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-206">
<h3 id="_可扩展协议接口_protocol">可扩展协议接口 <code>Protocol</code></h3>
<div class="paragraph has-source-line data-line-stdin-208">
<p>之所以把<code>Protocol</code>这个最为关键的接口放在最后才介绍，单就其官方给定的下面接口文档，在不熟悉实现细节的和设计原理时，理解起来相当费劲。在有了上面的那些铺垫后，再回来理解文档中要表达的意图就比较容易。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-211">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">Protocol</span> {
    <span style="color:#777">/**
     * 暴露远程服务：&lt;br&gt;
     * 1. 协议在接收请求时，应记录请求来源方地址信息：RpcContext.getContext().setRemoteAddress();&lt;br&gt;
     * 2. export()必须是幂等的，也就是暴露同一个URL的Invoker两次，和暴露一次没有区别。&lt;br&gt;
     * 3. export()传入的Invoker由框架实现并传入，协议不需要关心。&lt;br&gt;
     *
     * @param &lt;T&gt; 服务的类型
     * @param invoker 服务的执行体
     * @return exporter 暴露服务的引用，用于取消暴露
     * @throws RpcException 当暴露服务出错时抛出，比如端口已占用
     */</span>
    &lt;T&gt; Exporter&lt;T&gt; <span style="color:#080;font-weight:bold">export</span>(Invoker&lt;T&gt; invoker) <span style="color:#088;font-weight:bold">throws</span> RpcException;

    <span style="color:#777">/**
     * 引用远程服务：&lt;br&gt;
     * 1. 当用户调用refer()所返回的Invoker对象的invoke()方法时，协议需相应在远端执行export()的入参Invoker对象的invoke()方法，对应关系是两端的Invoker对象同URL。&lt;br&gt;
     * 2. refer()返回的Invoker由协议实现，协议通常需要在此Invoker中发送远程请求。&lt;br&gt;
     * 3. 当url中有设置check=false时，连接失败不能抛出异常，需内部自动恢复。&lt;br&gt;
     *
     * @param &lt;T&gt; 服务的类型
     * @param type 服务的类型
     * @param url 远程服务的URL地址
     * @return invoker 服务的本地代理
     * @throws RpcException 当连接服务提供方失败时抛出
     */</span>
    &lt;T&gt; Invoker&lt;T&gt; refer(<span style="color:#0a8;font-weight:bold">Class</span>&lt;T&gt; type, <span style="color:#0a8;font-weight:bold">URL</span> url) <span style="color:#088;font-weight:bold">throws</span> RpcException;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-242">
<h2 id="_协议支持实现">协议支持实现</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-244">
<p>上文曾说Dubbo在协议层提供了多种通讯方式实现，本文暂只就默认支持的Dubbo版和Injvm版的实现加以剖析。为便于各种版本协议的实现，Dubbo封装了一些基础的逻辑，本章节先就这些细节展开。</p>
</div>
<div class="sect2 has-source-line data-line-stdin-246">
<h3 id="_rpcinvocation"><code>RpcInvocation</code></h3>
<div class="paragraph has-source-line data-line-stdin-248">
<p><code>RpcInvocation</code>是<code>Invocation</code>的实现。总体上实现比较简单，只需要根据接口要求能够表达一次方法的几个基本元素就足够，因此<code>RpcInvocation</code>对应定义了如下几个属性：</p>
</div>
<div class="exampleblock has-source-line data-line-stdin-250">
<div class="content">
<div class="olist arabic has-source-line data-line-stdin-251">
<ol class="arabic">
<li class="has-source-line data-line-stdin-251">
<p>String <code>methodName</code>：实例所代表方法名称。</p>
</li>
<li class="has-source-line data-line-stdin-253">
<p>Class&lt;?&gt;[] <code>parameterTypes</code>：入参类型，数组，和arguments严格一一对应。</p>
</li>
<li class="has-source-line data-line-stdin-255">
<p>Object[] <code>arguments</code>：具体入参数据。</p>
</li>
<li class="has-source-line data-line-stdin-257">
<p>Map&lt;String, String&gt; <code>attachments</code>：附属参数，由于Invocation只对应一次方法调用，并没有存在资源争用的情况，普通Map就足够。</p>
</li>
<li class="has-source-line data-line-stdin-259">
<p>transient Invoker&lt;?&gt; <code>invoker</code>：Invoker调度器引用，后者属行为类，因而被声明为<code>transient</code>。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-262">
<p>上文已经说过，<code>Invocation</code>和Java原生程序中的方法调用是一对一的关系，如下构造方法便印证了这一点，从<code>Method</code>对象中获取到方法的名称和参数类型。另外由于它代表是一次具体的PRC方法调用而不是一个普通的本地方法调用，因此还需要加入一个无法从<code>Method</code>对象中获取的入参<code>Object[] arguments</code>。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-265">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">transient</span> <span style="color:#0a8;font-weight:bold">Class</span>&lt;?&gt; returnType;

<span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">transient</span> InvokeMode invokeMode;

<span style="color:#088;font-weight:bold">public</span> RpcInvocation(<span style="color:#0a8;font-weight:bold">String</span> methodName, <span style="color:#0a8;font-weight:bold">Class</span>&lt;?&gt;<span style="color:#339;font-weight:bold">[]</span> parameterTypes,
        <span style="color:#0a8;font-weight:bold">Object</span><span style="color:#339;font-weight:bold">[]</span> arguments, <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; attachments, Invoker&lt;?&gt; invoker) {
    <span style="color:#950">this</span>.methodName = methodName;
    <span style="color:#950">this</span>.parameterTypes = parameterTypes == <span style="color:#069">null</span> ? <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">Class</span>&lt;?&gt;[<span style="color:#00D">0</span>] : parameterTypes;
    <span style="color:#950">this</span>.arguments = arguments == <span style="color:#069">null</span> ? <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">Object</span>[<span style="color:#00D">0</span>] : arguments;
    <span style="color:#950">this</span>.attachments = attachments == <span style="color:#069">null</span> ? <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;() : attachments;
    <span style="color:#950">this</span>.invoker = invoker;
}

<span style="color:#088;font-weight:bold">public</span> RpcInvocation(Invocation invocation, Invoker&lt;?&gt; invoker) {
    <span style="color:#950">this</span>(invocation.getMethodName(), invocation.getParameterTypes(),
            invocation.getArguments(), <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;(invocation.getAttachments()),
            invocation.getInvoker());

<span style="color:#777">//==================================</span>
<span style="color:#777">// 将微服务配置元数据信息设到Invocation的本地参数容器中</span>
<span style="color:#777">//==================================</span>
    <span style="color:#080;font-weight:bold">if</span> (invoker != <span style="color:#069">null</span>) {
        <span style="color:#0a8;font-weight:bold">URL</span> url = invoker.getUrl();
        setAttachment(PATH_KEY, url.getPath());
        <span style="color:#080;font-weight:bold">if</span> (url.hasParameter(INTERFACE_KEY)) {
            setAttachment(INTERFACE_KEY, url.getParameter(INTERFACE_KEY));
        }
        <span style="color:#080;font-weight:bold">if</span> (url.hasParameter(GROUP_KEY)) {
            setAttachment(GROUP_KEY, url.getParameter(GROUP_KEY));
        }
        <span style="color:#080;font-weight:bold">if</span> (url.hasParameter(VERSION_KEY)) {
            setAttachment(VERSION_KEY, url.getParameter(VERSION_KEY, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">0.0.0</span><span style="color:#710">"</span></span>));
        }
        <span style="color:#080;font-weight:bold">if</span> (url.hasParameter(TIMEOUT_KEY)) {
            setAttachment(TIMEOUT_KEY, url.getParameter(TIMEOUT_KEY));
        }
        <span style="color:#080;font-weight:bold">if</span> (url.hasParameter(TOKEN_KEY)) {
            setAttachment(TOKEN_KEY, url.getParameter(TOKEN_KEY));
        }
        <span style="color:#080;font-weight:bold">if</span> (url.hasParameter(APPLICATION_KEY)) {
            setAttachment(APPLICATION_KEY, url.getParameter(APPLICATION_KEY));
        }
    }
}

<span style="color:#088;font-weight:bold">public</span> RpcInvocation(<span style="color:#0a8;font-weight:bold">Method</span> method, <span style="color:#0a8;font-weight:bold">Object</span><span style="color:#339;font-weight:bold">[]</span> arguments, <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; attachment) {
    <span style="color:#950">this</span>(method.getName(), method.getParameterTypes(), arguments, attachment, <span style="color:#069">null</span>);
    <span style="color:#950">this</span>.returnType = method.getReturnType();
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-317">
<p>上述源码片段中展示了其中一个构造方法中，Dubbo有将在Invoker实例设入的微服务配置元数据作为附属参数设置到Invocation中去，采用冗余手段，以空间换时间，可以快速便捷的拿到相关上下文参数，基于优先原则访问这些值，只有发现对应键值在附属参数不存在时，才绕道Invoker实例的配置总线获取。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-319">
<p>另外它还呈现了两个声明为<code>transient</code>的变量，前者表达式<code>Method</code>对象出参的类型，后者这表示当前执行上下文中<code>Invocation</code>以何种方式<sub>sync、async、future</sub>调度的，大部分时候是前者决定了后者的值。</p>
</div>
<div class="sect3 has-source-line data-line-stdin-321">
<h4 id="_由invocation获取出参">由<code>Invocation</code>获取出参</h4>
<div class="paragraph has-source-line data-line-stdin-323">
<p>根据<code>Invocation</code>这个接口的特性，它是用于表征状态类的，可被持久化，而对应调用方法的出参不是其关注重点。只有<code>RpcInvocation</code>加入了持有<code>Class&lt;?&gt; returnType</code>属性，为了尽可能获取到<code>Invocation</code>对象的出参类型，因此Dubbo在<code>RpcUtils</code>对应定义了如下一个方法，深入其细节会发现Invoker实例所表征的服务会将对应接口的名称以<code>interface</code>为键值存入到配置总线URL中，Dubbo根据该类名获取到服务的类对象，再由<code>Invocation</code>实例中的方法名称和入参类型获取到<code>Method</code>实例，以根据它进一步获取到出参类型，出参为void或者不满足源码过滤条件的都视作出参类型为null。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-326">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">RpcUtils</span> {

    ...
    public <span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">Class</span>&lt;?&gt; getReturnType(Invocation invocation) {
        <span style="color:#080;font-weight:bold">try</span> {
            <span style="color:#080;font-weight:bold">if</span> (invocation != <span style="color:#069">null</span> &amp;&amp; invocation.getInvoker() != <span style="color:#069">null</span>
                    &amp;&amp; invocation.getInvoker().getUrl() != <span style="color:#069">null</span>
                    &amp;&amp; !invocation.getMethodName().startsWith(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">$</span><span style="color:#710">"</span></span>)) {

                <span style="color:#0a8;font-weight:bold">String</span> service = invocation.getInvoker()
                    .getUrl().getServiceInterface();
                <span style="color:#080;font-weight:bold">if</span> (StringUtils.isNotEmpty(service)) {
                    <span style="color:#0a8;font-weight:bold">Class</span>&lt;?&gt; invokerInterface = invocation
                        .getInvoker().getInterface();
                    <span style="color:#0a8;font-weight:bold">Class</span>&lt;?&gt; cls = invokerInterface != <span style="color:#069">null</span> ?
                        ReflectUtils.forName(invokerInterface.getClassLoader(), service)
                            : ReflectUtils.forName(service);

                    <span style="color:#0a8;font-weight:bold">Method</span> method = cls.getMethod(invocation.getMethodName(),
                        invocation.getParameterTypes());

                    <span style="color:#080;font-weight:bold">if</span> (method.getReturnType() == <span style="color:#339;font-weight:bold">void</span>.class) {
                        <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">null</span>;
                    }
                    <span style="color:#080;font-weight:bold">return</span> method.getReturnType();
                }
            }
        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#0a8;font-weight:bold">Throwable</span> t) {
            logger.warn(t.getMessage(), t);
        }
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">null</span>;
    }
    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect3 has-source-line data-line-stdin-363">
<h4 id="_由invocation获取方法调度模式">由<code>Invocation</code>获取方法调度模式</h4>
<div class="paragraph has-source-line data-line-stdin-365">
<p>Dubbo可以根据出参类型和总线、附属参数等知晓当前被调用RPC方法的是被何种模式调度的，总共 3 种调度模式：如果接口方法本身的出参是CompletableFuture类型的则为<code>FUTURE</code>模式，如果配置参数设了<code>async</code>标识则为<code>ASYNC</code>异步模式，否则便是同步<code>SYNC</code>同步模式。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-367">
<p>在进一步了解具体实现细节前，需要了解下的是Dubbo中有两个以"$"字母打头的特殊方法，分别名为<code>"$invoke"</code>和<code>"$invokeAsync"</code>，目前只需要了解其接口定义和应用场景，具体实现将在下文中深入阐述：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-369">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#777">/**
 * Generic service interface
 *
 * @export
 */</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">GenericService</span> {

    <span style="color:#777">//Method name, e.g. findPerson. If there are overridden methods,</span>
    <span style="color:#777">//parameter info is required, e.g. findPerson(java.lang.String)</span>
    <span style="color:#0a8;font-weight:bold">Object</span> <span style="color:#F00;background-color:#FAA">$</span>invoke(<span style="color:#0a8;font-weight:bold">String</span> method, <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> parameterTypes, <span style="color:#0a8;font-weight:bold">Object</span><span style="color:#339;font-weight:bold">[]</span> args)
        <span style="color:#088;font-weight:bold">throws</span> GenericException;

    <span style="color:#080;font-weight:bold">default</span> CompletableFuture&lt;<span style="color:#0a8;font-weight:bold">Object</span>&gt; <span style="color:#F00;background-color:#FAA">$</span>invokeAsync(<span style="color:#0a8;font-weight:bold">String</span> method,
            <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> parameterTypes, <span style="color:#0a8;font-weight:bold">Object</span><span style="color:#339;font-weight:bold">[]</span> args) <span style="color:#088;font-weight:bold">throws</span> GenericException {

        <span style="color:#0a8;font-weight:bold">Object</span> object = <span style="color:#F00;background-color:#FAA">$</span>invoke(method, parameterTypes, args);
        <span style="color:#080;font-weight:bold">if</span> (object <span style="color:#080;font-weight:bold">instanceof</span> CompletableFuture) {
            <span style="color:#080;font-weight:bold">return</span> (CompletableFuture&lt;<span style="color:#0a8;font-weight:bold">Object</span>&gt;) object;
        }

        <span style="color:#080;font-weight:bold">return</span> CompletableFuture.completedFuture(object);
    }

}</code></pre>
</div>
</div>
<div class="quoteblock has-source-line data-line-stdin-395">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-396">
<p>泛接口调用方式主要用于客户端没有API接口及模型类元的情况，参数及返回值中的所有POJO均用Map表示，通常用于框架集成，比如：实现一个通用的服务测试框架，可通过GenericService调用所有服务实现。</p>
</div>
</blockquote>
</div>
<div class="paragraph has-source-line data-line-stdin-398">
<p>也就是说此场景下客户端并不需要维护和同步微服务接口签名（<sub>包括方法、入参、出参以及出入参类型相关的定义</sub>），只需要提供“方法名、入参、出参、出入参类型”这几个元素即可，此时有<code>methodName ∈ ["$invoke", "$invokeAsync"]</code>。而以字符串直接提供的方法名会被作为<code>arguments</code>中的第一个元素。Dubbo中，微服务的配置也全部在配置总线URL中体现，是可以配置到方法这一级别的，可以设置<code>url["$invoke.async"] = true</code>告知Dubbo需要异步调度该泛接口。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-401">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">RpcUtils</span> {

    ...

    public <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">boolean</span> isReturnTypeFuture(Invocation inv) {
        <span style="color:#0a8;font-weight:bold">Class</span>&lt;?&gt; clazz;
        <span style="color:#080;font-weight:bold">if</span> (inv <span style="color:#080;font-weight:bold">instanceof</span> RpcInvocation) {
            clazz = ((RpcInvocation) inv).getReturnType();
        } <span style="color:#080;font-weight:bold">else</span> {
            clazz = getReturnType(inv);
        }
        <span style="color:#777">//出参类型为CompletableFuture则为FUTURE模式</span>
        <span style="color:#080;font-weight:bold">return</span> (clazz != <span style="color:#069">null</span> &amp;&amp; CompletableFuture.
            class.isAssignableFrom(clazz)) || isGenericAsync(inv);
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">boolean</span> isGenericAsync(Invocation inv) {
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#F00;background-color:#FAA">$</span>INVOKE_ASYNC.equals(inv.getMethodName());
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> InvokeMode getInvokeMode(<span style="color:#0a8;font-weight:bold">URL</span> url, Invocation inv) {
        <span style="color:#080;font-weight:bold">if</span> (isReturnTypeFuture(inv)) {
            <span style="color:#080;font-weight:bold">return</span> InvokeMode.FUTURE;
        } <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (isAsync(url, inv)) {
            <span style="color:#080;font-weight:bold">return</span> InvokeMode.ASYNC;
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#080;font-weight:bold">return</span> InvokeMode.SYNC;
        }
    }

    <span style="color:#777">//先从附属参数获取异步设置参数，如果值为false，则配置总线中进一步获取方法参数</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">boolean</span> isAsync(<span style="color:#0a8;font-weight:bold">URL</span> url, Invocation inv) {
        <span style="color:#339;font-weight:bold">boolean</span> isAsync;
        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#0a8;font-weight:bold">Boolean</span>.TRUE.toString().equals(inv.getAttachment(ASYNC_KEY))) {
            isAsync = <span style="color:#069">true</span>;
        } <span style="color:#080;font-weight:bold">else</span> {
            isAsync = url.getMethodParameter(getMethodName(inv), ASYNC_KEY, <span style="color:#069">false</span>);
        }
        <span style="color:#080;font-weight:bold">return</span> isAsync;
    }

    <span style="color:#777">//范接口的方法名称为``$invoke``或``$invokeAsync``，指定方法名称置于入参中第一个位置</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">String</span> getMethodName(Invocation invocation) {
        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#F00;background-color:#FAA">$</span>INVOKE.equals(invocation.getMethodName())
                &amp;&amp; invocation.getArguments() != <span style="color:#069">null</span>
                &amp;&amp; invocation.getArguments().length &gt; <span style="color:#00D">0</span>
                &amp;&amp; invocation.getArguments()[<span style="color:#00D">0</span>] <span style="color:#080;font-weight:bold">instanceof</span> <span style="color:#0a8;font-weight:bold">String</span>) {
            <span style="color:#080;font-weight:bold">return</span> (<span style="color:#0a8;font-weight:bold">String</span>) invocation.getArguments()[<span style="color:#00D">0</span>];
        }
        <span style="color:#080;font-weight:bold">return</span> invocation.getMethodName();
    }

    ...

}

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">enum</span> InvokeMode {
    SYNC, ASYNC, FUTURE
}</code></pre>
</div>
</div>
<hr>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-466">
<h3 id="_result_的实现_asyncrpcresult"><code>Result</code> 的实现 <code>AsyncRpcResult</code></h3>
<div class="paragraph has-source-line data-line-stdin-468">
<p>注：<span class="small">下文中反复出现的<code>RpcContext</code>相当关键，使用Java中ThreadLocal的翻版实现InternalThreadLocal，同一个变量，使用它的多个线程各自拥有一份拷贝，也即所谓的线程本地变量，综合了性能等方面的考虑因素。这一大章节先不细究其实现，只需知道其存在价值和用法即可。</span></p>
</div>
<div class="sect3 has-source-line data-line-stdin-470">
<h4 id="_理论分析">理论分析</h4>
<div class="paragraph has-source-line data-line-stdin-472">
<p><code>AsyncRpcResult</code>是<code>Result</code>的接口实现，上文已经交代过，底层采用异步调用方式处理远端请求，也即请求发送出去就返回了，资源已经让渡出去，待服务端完成业务处理再经网络回传响应结果，最后由Dubbo执行反序列化处理，将结果扔进一个Result对象返回给应用层。稍加思考便会产生如是疑问，服务端的响应回来之后，如何获得对应的表示原生请求的<code>Invocation</code>对象以及它被调度时的上下文环境信息？为获得结果，我们得继续往下深入。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-474">
<p>先看看如下关于<code>AsyncRpcResult</code>的文档信息：</p>
</div>
<div class="quoteblock has-source-line data-line-stdin-475">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-477">
<p>This class represents an unfinished RPC call, it will hold some context information for this call, for example RpcContext and Invocation, so that when the call finishes and the result returns, it can guarantee all the contexts being recovered as the same as when the call was made before any callback is invoked.</p>
</div>
<div class="paragraph has-source-line data-line-stdin-479">
<p>As Result implements CompletionStage, AsyncRpcResult allows you to easily build a async filter chain whose status will be driven entirely by the state of the underlying RPC call.</p>
</div>
<div class="paragraph has-source-line data-line-stdin-481">
<p>AsyncRpcResult does not contain any concrete value (except the underlying value bring by CompletableFuture), consider it as a status transfer node. getValue() and getException() are all inherited from Result interface, implementing them are mainly for compatibility consideration. Because many legacy Filter implementation are most possibly to call getValue directly.</p>
</div>
</blockquote>
</div>
<div class="paragraph has-source-line data-line-stdin-484">
<p>上文中前段的大意是“<code>AsyncRpcResult</code>对象代表了一个未完成的RPC调用，它持有该调用中包括<code>RpcContext</code>和<code>Invocation</code>在内的上下文信息，因而当完成调用结果返回时，能够保证完好如初地就地恢复请求发出后还未被执行任何回调时的所有上下文信息”。这初步解开了我们上述发现的疑团，当然更加具体还得等接下来深入剖析其实现细节。</p>
</div>
<div class="admonitionblock note has-source-line data-line-stdin-487">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
恢复的时机是“<span class="big">请求发出后还未被执行任何回调时</span>”，<code>RpcContext</code>这个表征执行上下文的对象，可能在回调之前其内容已经发生了改变，原因是这期间同一个线程可能被用于执行其他的RPC调用，因而需要保存方法调度时的<code>RpcContext</code>引用，便于在回调前刹那恢复现场信息。
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph has-source-line data-line-stdin-489">
<p>中段则表明“由于<code>AsyncRpcResult</code>实现了<code>CompletionStage</code>接口，因而可以非常容易地构建一条异步过滤器链，其状态将完全由底层RPC调用的状态驱动”。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-491">
<p>最后一段给出的信息则尤为关键，基本意思是<code>AsyncRpcResult</code>本不应该持有除<code>CompletableFuture</code>携带外的任何具体值，应该把它当做一种状态传输节点。历史原因，为了兼容性实现了 <code>getValue()</code> 和 <code>getException()</code> 方法，依然还有许多遗留的过滤器使用这两个方法。</p>
</div>
</div>
<div class="sect3 has-source-line data-line-stdin-493">
<h4 id="_实现细节">实现细节</h4>
<div class="paragraph has-source-line data-line-stdin-495">
<p>从上述一个章节介绍知悉，<code>AsyncRpcResult</code>最重要的工作便是现场维护，其实现需要的几个如下组成元素：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-497">
<ol class="arabic">
<li class="has-source-line data-line-stdin-497">
<p><code>Invocation</code>：代表原生方法的一次调用，携带了入参、入参类型、以及方法名，不过上文已经说明，它是历史遗留，它的存在更多是兼容性考虑；</p>
</li>
<li class="has-source-line data-line-stdin-498">
<p><code>RpcContext</code> stored：原生方法被调度时的上下文信息，保留现场；</p>
</li>
<li class="has-source-line data-line-stdin-499">
<p><code>RpcContext</code> tmp：原生方法被回调时的，所运行线程持有的其原生方法正在执行时的上下文信息；</p>
</li>
</ol>
</div>
<div class="sect4 has-source-line data-line-stdin-501">
<h5 id="_现场信息保护和恢复">现场信息保护和恢复</h5>
<div class="paragraph has-source-line data-line-stdin-503">
<p>在具体介绍其实现之前，需要先回过头去看看此前<code>Result</code>中定义的一个关键回调方法<code>whenCompleteWithContext</code>，该方法也正是<strong>异步过滤器链</strong>实现的关键，下文将有所体现。现场信息保护的原理是<code>AsyncRpcResult</code>被实例化时，会缓存当时的RPC调用时的<code>RpcContext</code>上下文A<sub>原样保留现场信息</sub>，结果返回执行回调时，会再一次获取当前线程<sub>和<code>Invocation</code>调度时的线程可能不同</sub>中持有的<code>RpcContext</code>上下文B，接着将B缓存到一个<code>tmpContext</code>的临时变量中，随后将A的内容恢复到当前线程中，也就是替换掉其现有的内容B，此后才回调类型为<code>BiConsumer&lt;Result, Throwable&gt;</code>的入参函数，最后使用<code>tmpContext</code>恢复当前线程回调时的上下文信息，也即还原到B。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-505">
<p>具体实现源码如下，奇怪的是源码中会有两套配对的<code>RpcContext</code>，一个被称之为<code>context</code>，另一个为<code>serverContext</code>，为啥会这样，得等后面对实现有更深入的了解。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-508">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AsyncRpcResult</span> <span style="color:#088;font-weight:bold">extends</span> AbstractResult {

    ...
    private RpcContext storedContext;
    <span style="color:#088;font-weight:bold">private</span> RpcContext storedServerContext;
    <span style="color:#088;font-weight:bold">private</span> Invocation invocation;

    <span style="color:#088;font-weight:bold">public</span> AsyncRpcResult(Invocation invocation) {
        <span style="color:#950">this</span>.invocation = invocation;
        <span style="color:#950">this</span>.storedContext = RpcContext.getContext();
        <span style="color:#950">this</span>.storedServerContext = RpcContext.getServerContext();
    }

    <span style="color:#088;font-weight:bold">public</span> AsyncRpcResult(AsyncRpcResult asyncRpcResult) {
        <span style="color:#950">this</span>.invocation = asyncRpcResult.getInvocation();
        <span style="color:#950">this</span>.storedContext = asyncRpcResult.getStoredContext();
        <span style="color:#950">this</span>.storedServerContext = asyncRpcResult.getStoredServerContext();
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Result</span> whenCompleteWithContext(BiConsumer&lt;<span style="color:#0a8;font-weight:bold">Result</span>, <span style="color:#0a8;font-weight:bold">Throwable</span>&gt; fn) {
        CompletableFuture&lt;<span style="color:#0a8;font-weight:bold">Result</span>&gt; future = <span style="color:#950">this</span>.whenComplete((v, t) -&gt; {
            beforeContext.accept(v, t);
            fn.accept(v, t);
            afterContext.accept(v, t);
        });
<span style="color:#777">//==============================</span>
<span style="color:#777">//下半段代码：订阅当前对象的完成事件，第一时间获取其结果，薪火相传</span>
<span style="color:#777">//==============================</span>
        AsyncRpcResult nextStage = <span style="color:#080;font-weight:bold">new</span> AsyncRpcResult(<span style="color:#950">this</span>);
        nextStage.subscribeTo(future);
        <span style="color:#080;font-weight:bold">return</span> nextStage;
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> subscribeTo(CompletableFuture&lt;?&gt; future) {
        future.whenComplete((obj, t) -&gt; {
            <span style="color:#080;font-weight:bold">if</span> (t != <span style="color:#069">null</span>) {
                <span style="color:#950">this</span>.completeExceptionally(t);
            } <span style="color:#080;font-weight:bold">else</span> {
                <span style="color:#950">this</span>.complete((<span style="color:#0a8;font-weight:bold">Result</span>) obj);
            }
        });
    }

    <span style="color:#777">/**
     * tmp context to use when the thread switch to Dubbo thread.
     */</span>
    <span style="color:#088;font-weight:bold">private</span> RpcContext tmpContext;
    <span style="color:#088;font-weight:bold">private</span> RpcContext tmpServerContext;

    <span style="color:#088;font-weight:bold">private</span> BiConsumer&lt;<span style="color:#0a8;font-weight:bold">Result</span>, <span style="color:#0a8;font-weight:bold">Throwable</span>&gt; beforeContext = (appResponse, t) -&gt; {
        tmpContext = RpcContext.getContext();
        tmpServerContext = RpcContext.getServerContext();
        RpcContext.restoreContext(storedContext);
        RpcContext.restoreServerContext(storedServerContext);
    };

    <span style="color:#088;font-weight:bold">private</span> BiConsumer&lt;<span style="color:#0a8;font-weight:bold">Result</span>, <span style="color:#0a8;font-weight:bold">Throwable</span>&gt; afterContext = (appResponse, t) -&gt; {
        RpcContext.restoreContext(tmpContext);
        RpcContext.restoreServerContext(tmpServerContext);
    };

    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect4 has-source-line data-line-stdin-575">
<h5 id="_subscribeto_whencompletewithcontext"><code>subscribeTo</code> &amp; <code>whenCompleteWithContext</code></h5>
<div class="paragraph has-source-line data-line-stdin-577">
<p>上述源码中展示了一个比较独特的方法——<code>subscribeTo(CompletableFuture&lt;?&gt;)</code>，这段代码理解起来还是比较费劲，接下来的章节慢慢分析之。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-579">
<p>为理解方便，我们假设一个现实生活的中的场景，读者给报社下了一份订单——<code>subscribeTo</code>，要求订阅时尚杂志，后者在新一期杂志出来后时，总会及时给读者快速邮递最新的杂志。这里读者是订阅方，而报社是被订阅方，下面分析将被直接表示为<code>读者</code>和<code>报社</code>。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-581">
<p>首先暂且将其之前的<code>whenCompleteWithContext</code>先放一边。大概意思是入参<code>future</code>所代表的这个<code>CompletableFuture</code>类型对象动作完成时，会回调其<code>whenComplete</code>方法，回调代码块所做的事情就是将其结果设给当前的<code>AsyncRpcResult</code>对象，通知其完成。实质也就是<code>AsyncRpcResult</code>这个<code>future</code>对象的结果值是由另外一个<code>CompletableFuture</code>在其完成时才填充的，也即只有后者的完成了其操作，通过回调将其获得的值传递给前者。
前提是入参<code>future</code>的返回值也是要求是<code>Result</code>类型，这便有构成了一种形如“A ← B”链式操作，B订阅了A，只有B完成其自身的设值操作，才会在其回调将值传递给A，知会A整个链式操作完成，表面上B是依赖A的，但A只有在B完成时，才能完成其闭环操作。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-584">
<p>综上，也就是“读者向报社发起<code>subscribeTo</code>订单申请，报社完成最新一期的杂志印制工作后，及时邮递给读者，也即在其完成回调事件中完成成果交付，这时候读者便拥有了最新杂志。”</p>
</div>
<div class="paragraph has-source-line data-line-stdin-586">
<p>现在回到<code>whenCompleteWithContext</code>，聚焦于后半段代码，理解它的关键是要搞清楚对象间关系，其调用<code>subscribeTo</code>方法的不是当前<code>this</code>对象，而是一个新创建的<code>nextStage</code>实例，该实例会被<code>whenCompleteWithContext</code>的调用方引用，当前<code>this</code>对象完成操作后，会回调其<code>whenComplete</code>，将其完成值填充给<code>nextStage</code>实例，后者也是一个<code>CompletableFuture</code>类型对象，因此可以在其<code>whenComplete</code>回调方法得知最终响应结果。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-588">
<p>依然我们假设“读者：当前对象，报社：实际<code>Result</code>完成方，借阅方：返回的nextStage”，借阅方向读者发起<code>subscribeTo</code>，要求其在读完杂志后第一时间给他借阅，读者也发起<code>subscribeTo</code>订阅操作，向报社订购杂志，杂志的传递关系很明显：“借阅方 ← 读者 ← 报社”。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-590">
<p>到这里就很明显了，在链条上每调用一次<code>whenCompleteWithContext</code>实际上就是产生一个借书的借阅方，而每调用一次<code>subscribeTo</code>操作，则是增加一个杂志生产方——报社，越往后的越趋向杂志的生产源头。</p>
</div>
<div class="admonitionblock note has-source-line data-line-stdin-593">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>CompletableFuture</code>的<code>whenComplete</code>方法可以回调多次，按顺序依次回调。
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect3 has-source-line data-line-stdin-596">
<h4 id="_appresponse">AppResponse</h4>
<div class="paragraph has-source-line data-line-stdin-598">
<p>上文中已提及<code>AsyncRpcResult</code>是一个行为类，理论上不应该存储具体的状态值，由于历史原因需维持兼容性，Dubbo将接口<code>Result</code>定义的其它接口全部委托给了<code>AppResponse</code>，而后者是一个状态类，理论上只需存取状态值即可，同样是因为兼容原因，继承实现了同样实现了<code>Result</code>接口。可以这么认为“<code>public class AsyncRpcResult implements CompletionStage&lt;AppResponse&gt;</code>”，由于只需要存储状态值，它的实现很简单，同样<code>AsyncRpcResult</code>中委托它实现状态值存取的方法实现也会比较简单，唯一值得一看的是下述的<code>recreate()</code>方法源码，其它具体请查看Dubbo源码。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-601">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Override</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Object</span> recreate() <span style="color:#088;font-weight:bold">throws</span> <span style="color:#0a8;font-weight:bold">Throwable</span> {
    <span style="color:#080;font-weight:bold">if</span> (exception != <span style="color:#069">null</span>) {
        <span style="color:#777">// fix issue#619</span>
        <span style="color:#080;font-weight:bold">try</span> {
            <span style="color:#777">// get Throwable class</span>
            <span style="color:#0a8;font-weight:bold">Class</span> clazz = exception.getClass();
            <span style="color:#080;font-weight:bold">while</span> (!clazz.getName().equals(<span style="color:#0a8;font-weight:bold">Throwable</span>.class.getName())) {
                clazz = clazz.getSuperclass();
            }
            <span style="color:#777">// get stackTrace value</span>
            <span style="color:#0a8;font-weight:bold">Field</span> stackTraceField = clazz.getDeclaredField(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">stackTrace</span><span style="color:#710">"</span></span>);
            stackTraceField.setAccessible(<span style="color:#069">true</span>);
            <span style="color:#0a8;font-weight:bold">Object</span> stackTrace = stackTraceField.get(exception);
            <span style="color:#080;font-weight:bold">if</span> (stackTrace == <span style="color:#069">null</span>) {
                exception.setStackTrace(<span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">StackTraceElement</span>[<span style="color:#00D">0</span>]);
            }
        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#C00;font-weight:bold">Exception</span> e) {
            <span style="color:#777">// ignore</span>
        }
        <span style="color:#080;font-weight:bold">throw</span> exception;
    }
    <span style="color:#080;font-weight:bold">return</span> result;
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-627">
<p>有过Java开发经验的都知道，Java抛出的异常信息是带有当前方法所在线程的调用帧信息的，也即<code>stackTrace</code>，它的作用是辅助排查问题，随着异常在一直往上抛的过程中，其涉及帧信息也逐个在增加，最终呈现的异常信息会很长。另外如果服务提供端报了大量的 NPE 异常, JVM 为了性能会做优化, 会重新编译, 不再打印异常堆栈，只会抛出预定义的NPE异常java.lang.NullPointerException: null。这样就导致真正的异常信息被隐藏了，因此上述源码对这种情况做进一步处理了，首先找到当前异常对象的Throwable下一级的顶层类，然后获取<code>stackTrace</code>帧信息，若值为null，则设值为<code>new StackTraceElement[0]</code>，获得效果是“<em><code>只要stackTrace!=null, 就不会用错误的异常栈来赋值给stackTrace, 这样修改后, consumer会跟provider保持一致, 即抛出没有异常栈的异常, 这样就不会误导用户了</code></em>”，具体问题请查看<a href="https://www.yuque.com/fa902k/id5z6r/sr041v">Dubbo调用端hessian反序列化抛NPE问题研究</a>。</p>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-629">
<h3 id="_abstractinvokert"><code>AbstractInvoker&lt;T&gt;</code></h3>
<div class="paragraph has-source-line data-line-stdin-631">
<p>有了上述章节的铺垫后，<code>Invoker</code>的实现就比较好理解了，下面我们一步步来加以分析。</p>
</div>
<div class="sect3 has-source-line data-line-stdin-633">
<h4 id="_基础实现">基础实现</h4>
<div class="paragraph has-source-line data-line-stdin-635">
<p>上述已经讲过：1）一个<code>Invoker</code>实例实际上对应了Java中的一个服务接口，需要知晓当前实例所对应的接口类名；2）每个微服务都有自身的配置参数，配置使用配置总线URL进行存取，效率上的考虑，Dubbo采用了时空互换，将微服务配置元数据设到了附属参数中；3）微服务被认为是一个<code>Node</code>节点，有配置参数，能获取可用状态，可销毁处理。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-637">
<p>这些实现都放在基类<code>AbstractInvoker</code>中：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-640">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">abstract</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AbstractInvoker</span>&lt;T&gt; <span style="color:#088;font-weight:bold">implements</span> Invoker&lt;T&gt; {
    ...

    <span style="color:#777">//==============================</span>
    <span style="color:#777">// 时空交换，将微服务的配置总线中配置元数据置入附属参数中</span>
    <span style="color:#777">//==============================</span>
    private <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; attachment;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; convertAttachment(<span style="color:#0a8;font-weight:bold">URL</span> url, <span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> keys) {
        <span style="color:#080;font-weight:bold">if</span> (ArrayUtils.isEmpty(keys)) {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">null</span>;
        }
        <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; attachment = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt;();
        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#0a8;font-weight:bold">String</span> key : keys) {
            <span style="color:#0a8;font-weight:bold">String</span> value = url.getParameter(key);
            <span style="color:#080;font-weight:bold">if</span> (value != <span style="color:#069">null</span> &amp;&amp; value.length() &gt; <span style="color:#00D">0</span>) {
                attachment.put(key, value);
            }
        }
        <span style="color:#080;font-weight:bold">return</span> attachment;
    }

    <span style="color:#777">//==============================</span>
    <span style="color:#777">// 对应微服务实例的类名信息，唯一标识一个微服务</span>
    <span style="color:#777">//==============================</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Class</span>&lt;T&gt; type;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Class</span>&lt;T&gt; getInterface() {
        <span style="color:#080;font-weight:bold">return</span> type;
    }

    <span style="color:#777">//==============================</span>
    <span style="color:#777">// 微服务配置总线</span>
    <span style="color:#777">//==============================</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">URL</span> url;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">URL</span> getUrl() {
        <span style="color:#080;font-weight:bold">return</span> url;
    }

    <span style="color:#777">//==============================</span>
    <span style="color:#777">// 微服务可用状态，使用volatile，确保在并发多线程的可见性</span>
    <span style="color:#777">//==============================</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">volatile</span> <span style="color:#339;font-weight:bold">boolean</span> available = <span style="color:#069">true</span>;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> isAvailable() {
        <span style="color:#080;font-weight:bold">return</span> available;
    }

    <span style="color:#088;font-weight:bold">protected</span> <span style="color:#339;font-weight:bold">void</span> setAvailable(<span style="color:#339;font-weight:bold">boolean</span> available) {
        <span style="color:#950">this</span>.available = available;
    }

    <span style="color:#777">//==============================</span>
    <span style="color:#777">// 微服务被销毁了才认为不可用，使用原子变量确保多线程环境操作的安全性</span>
    <span style="color:#777">//==============================</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">AtomicBoolean</span> destroyed = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">AtomicBoolean</span>(<span style="color:#069">false</span>);

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> destroy() {
        <span style="color:#080;font-weight:bold">if</span> (!destroyed.compareAndSet(<span style="color:#069">false</span>, <span style="color:#069">true</span>)) {
            <span style="color:#080;font-weight:bold">return</span>;
        }
        setAvailable(<span style="color:#069">false</span>);
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> isDestroyed() {
        <span style="color:#080;font-weight:bold">return</span> destroyed.get();
    }

    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect3 has-source-line data-line-stdin-718">
<h4 id="_result_invokeinvocation_实现"><code>Result invoke(Invocation)</code> 实现</h4>
<div class="paragraph has-source-line data-line-stdin-720">
<p><code>Invoker</code>的每一种具体实现实际对应了一种协议，本文中讨论的是默认的Dubbo协议支持。Dubbo将其中的一些模板实现代码放在父类<code>AbstractInvoker&lt;T&gt;</code>中，而和具体协议相关的实现委托给子类进一步实现，因此申明了如下的抽象方法：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-723">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">protected</span> <span style="color:#088;font-weight:bold">abstract</span> <span style="color:#0a8;font-weight:bold">Result</span> doInvoke(Invocation invocation) <span style="color:#088;font-weight:bold">throws</span> <span style="color:#0a8;font-weight:bold">Throwable</span>;</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-727">
<p>以下着重分析以下模板代码中实现的逻辑，过程也比较简单，步骤如下：</p>
</div>
<div class="ulist has-source-line data-line-stdin-729">
<ul>
<li class="has-source-line data-line-stdin-729">
<p>① 给代表原生方法调用的<code>Invocation</code>实例inv关联其所处运行环境——当前微服务实例；</p>
</li>
<li class="has-source-line data-line-stdin-730">
<p>② 按约定给inv的附属数据容器中置入微服务配置元数据；</p>
</li>
<li class="has-source-line data-line-stdin-731">
<p>③ 将当前线程运行环境设置的上下文参数加入到inv的附属参数容器中；</p>
</li>
<li class="has-source-line data-line-stdin-732">
<p>④ 设置原生方法最终被调度时所采用的模式：Future or Async or Sync；</p>
</li>
<li class="has-source-line data-line-stdin-733">
<p>⑤ 给异步模式执行下的inv设置递增的唯一ID编号；</p>
</li>
<li class="has-source-line data-line-stdin-734">
<p>⑥ 执行具体协议实现子类提供的<code>doInvoke()</code>实现，如果调用期间遇到异常，则返回一个异常完成的<code>AsyncRpcResult</code>对象；</p>
</li>
</ul>
</div>
<div class="listingblock has-source-line data-line-stdin-737">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">abstract</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AbstractInvoker</span>&lt;T&gt; <span style="color:#088;font-weight:bold">implements</span> Invoker&lt;T&gt; {
    ...

    public <span style="color:#0a8;font-weight:bold">Result</span> invoke(Invocation inv) <span style="color:#088;font-weight:bold">throws</span> RpcException {
        <span style="color:#777">//(一) if invoker is destroyed due to address refresh from registry, let's allow the current invoke to proceed</span>
        <span style="color:#080;font-weight:bold">if</span> (destroyed.get()) {
            logger.warn(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Invoker for service </span><span style="color:#710">"</span></span> + <span style="color:#950">this</span> + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20"> on consumer </span><span style="color:#710">"</span></span> + NetUtils.getLocalHost() + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20"> is destroyed, </span><span style="color:#710">"</span></span>
                    + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">, dubbo version is </span><span style="color:#710">"</span></span> + Version.getVersion() + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">, this invoker should not be used any longer</span><span style="color:#710">"</span></span>);
        }

        <span style="color:#777">//①</span>
        RpcInvocation invocation = (RpcInvocation) inv;
        invocation.setInvoker(<span style="color:#950">this</span>);

        <span style="color:#777">//②</span>
        <span style="color:#080;font-weight:bold">if</span> (CollectionUtils.isNotEmptyMap(attachment)) {
            invocation.addAttachmentsIfAbsent(attachment);
        }

        <span style="color:#777">//③</span>
        <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">String</span>&gt; contextAttachments = RpcContext.getContext().getAttachments();
        <span style="color:#080;font-weight:bold">if</span> (CollectionUtils.isNotEmptyMap(contextAttachments)) {
            <span style="color:#777">//(二) invocation.addAttachmentsIfAbsent(context){@link RpcInvocatio ...</span>
            invocation.addAttachments(contextAttachments);
        }

        <span style="color:#777">//④</span>
        invocation.setInvokeMode(RpcUtils.getInvokeMode(url, invocation));
        <span style="color:#777">//⑤</span>
        RpcUtils.attachInvocationIdIfAsync(getUrl(), invocation);

        <span style="color:#777">//⑥</span>
        <span style="color:#080;font-weight:bold">try</span> {
            <span style="color:#080;font-weight:bold">return</span> doInvoke(invocation);
        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#C00;font-weight:bold">InvocationTargetException</span> e) { <span style="color:#777">// biz exception</span>
            <span style="color:#0a8;font-weight:bold">Throwable</span> te = e.getTargetException();
            <span style="color:#080;font-weight:bold">if</span> (te == <span style="color:#069">null</span>) {
                <span style="color:#080;font-weight:bold">return</span> AsyncRpcResult.newDefaultAsyncResult(<span style="color:#069">null</span>, e, invocation);
            } <span style="color:#080;font-weight:bold">else</span> {
                <span style="color:#080;font-weight:bold">if</span> (te <span style="color:#080;font-weight:bold">instanceof</span> RpcException) {
                    ((RpcException) te).setCode(RpcException.BIZ_EXCEPTION);
                }
                <span style="color:#080;font-weight:bold">return</span> AsyncRpcResult.newDefaultAsyncResult(<span style="color:#069">null</span>, te, invocation);
            }
        } <span style="color:#080;font-weight:bold">catch</span> (RpcException e) {
            <span style="color:#080;font-weight:bold">if</span> (e.isBiz()) {
                <span style="color:#080;font-weight:bold">return</span> AsyncRpcResult.newDefaultAsyncResult(<span style="color:#069">null</span>, e, invocation);
            } <span style="color:#080;font-weight:bold">else</span> {
                <span style="color:#080;font-weight:bold">throw</span> e;
            }
        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#0a8;font-weight:bold">Throwable</span> e) {
            <span style="color:#080;font-weight:bold">return</span> AsyncRpcResult.newDefaultAsyncResult(<span style="color:#069">null</span>, e, invocation);
        }
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-796">
<p>可以看出涉及过程虽然比较多，但理解起来不算费劲，但有些点需要单独拧出来说道说道的，其一是两处注解说明，其二是使用到的外部工具方法。</p>
</div>
<div class="sect4 has-source-line data-line-stdin-798">
<h5 id="_特别注释">特别注释</h5>
<div class="paragraph has-source-line data-line-stdin-800">
<p>代码中出现的两处注解后的代码行细究起来有点违反直觉让人费解，在注解的基础上才能和其运行上下文环境联系起来，大致意思分别是：</p>
</div>
<div class="ulist has-source-line data-line-stdin-802">
<ul>
<li class="has-source-line data-line-stdin-802">
<p>(一) 由于注册中心刷新了地址，导致微服务实例被销毁，此时对应的<code>Invocation</code>还是允许在这个微服务环境<sub>Invoker实例</sub>下完成调度的。</p>
</li>
<li class="has-source-line data-line-stdin-803">
<p>(二) 当前<code>invoke()</code>方法在Dubbo的重试机制下会被再次调用，此时会有过滤器Filter调用<code>RpcContext.setAttachment(String, String)</code>设置上下文参数。如果调用<code>addAttachmentsIfAbsent</code>存留的还是旧的上下文参数，可能已经失效，如外发的<code>traceId</code>和<code>spanId</code>。</p>
</li>
</ul>
</div>
</div>
<div class="sect4 has-source-line data-line-stdin-805">
<h5 id="_所涉外部工具方法">所涉外部工具方法</h5>
<div class="paragraph has-source-line data-line-stdin-807">
<p>另外出现的两个之前没有涉及的工具方法“<code>RpcUtils.attachInvocationIdIfAsync()</code>” 和 “<code>AsyncRpcResult.newDefaultAsyncResult()</code>”。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-809">
<p>Dubbo中的配置总线使用相当广泛，几乎所有的关键组件都会用到它，一个表征方法调用的Invocation实例也利用到这一特性来决定是否给其设置被调度的唯一ID编号，默认情况下，只有<code>Async</code>异步模式才会赋予这个编号，此外就是通过设置"<code>url[methodName + ".invocationid.autoattach"]</code>"参数来自动赋值编号。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-811">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">RpcUtils</span> {

    ...

    <span style="color:#777">//获取表征方法调用的Invocation的编号</span>
    public <span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">Long</span> getInvocationId(Invocation inv) {
        <span style="color:#0a8;font-weight:bold">String</span> id = inv.getAttachment(ID_KEY);
        <span style="color:#080;font-weight:bold">return</span> id == <span style="color:#069">null</span> ? <span style="color:#069">null</span> : <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">Long</span>(id);
    }

    <span style="color:#777">/**
     * Idempotent operation: invocation id will be added in async operation by default
     *
     * @param url
     * @param inv
     */</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">void</span> attachInvocationIdIfAsync(<span style="color:#0a8;font-weight:bold">URL</span> url, Invocation inv) {
        <span style="color:#080;font-weight:bold">if</span> (isAttachInvocationId(url, inv) &amp;&amp; getInvocationId(inv) == <span style="color:#069">null</span>
                &amp;&amp; inv <span style="color:#080;font-weight:bold">instanceof</span> RpcInvocation) {

            ((RpcInvocation) inv).setAttachment(ID_KEY,
                <span style="color:#0a8;font-weight:bold">String</span>.valueOf(INVOKE_ID.getAndIncrement()));
        }
    }

    <span style="color:#777">//如果和Invocation</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">boolean</span> isAttachInvocationId(<span style="color:#0a8;font-weight:bold">URL</span> url, Invocation invocation) {
        <span style="color:#0a8;font-weight:bold">String</span> value = url.getMethodParameter(invocation.getMethodName(),
            AUTO_ATTACH_INVOCATIONID_KEY);
        <span style="color:#080;font-weight:bold">if</span> (value == <span style="color:#069">null</span>) {
            <span style="color:#777">// add invocationid in async operation by default</span>
            <span style="color:#080;font-weight:bold">return</span> isAsync(url, invocation);
        } <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (<span style="color:#0a8;font-weight:bold">Boolean</span>.TRUE.toString().equalsIgnoreCase(value)) {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>;
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;
        }
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-855">
<p>另外在<code>AsyncRpcResult</code>中有一套<code>newDefaultAsyncResult()</code>方法是没有提及的，其作用是在结果已知或遇到异常时直接返回一个已经完成的<code>AsyncRpcResult</code>实例，有了它才可以确保上文提到的<code>subscribeTo()</code>和<code>whenCompleteWithContext()</code>等一套复杂的方法调度机制依然可以work的比较好。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-858">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AsyncRpcResult</span> <span style="color:#088;font-weight:bold">extends</span> AbstractResult {
    ...

    public <span style="color:#088;font-weight:bold">static</span> AsyncRpcResult newDefaultAsyncResult(<span style="color:#0a8;font-weight:bold">Object</span> value,
            <span style="color:#0a8;font-weight:bold">Throwable</span> t, Invocation invocation) {
        AsyncRpcResult asyncRpcResult = <span style="color:#080;font-weight:bold">new</span> AsyncRpcResult(invocation);
        AppResponse appResponse = <span style="color:#080;font-weight:bold">new</span> AppResponse();
        <span style="color:#080;font-weight:bold">if</span> (t != <span style="color:#069">null</span>) {
            appResponse.setException(t);
        } <span style="color:#080;font-weight:bold">else</span> {
            appResponse.setValue(value);
        }
        asyncRpcResult.complete(appResponse);
        <span style="color:#080;font-weight:bold">return</span> asyncRpcResult;
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-879">
<h2 id="_injvm协议实现"><code>Injvm</code>协议实现</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-881">
<p>顾名思义，Injvm解决的是部署在同一个JVM中的微服务客户端和服务端的RPC调用问题，显然这就等同于Java本地的原生方法调用，但却使得调用这个过程被拉长了，多了不少中间环节。然而，这却是必要的：<mark>框架是一类问题的通用解决方案，往往某类型的业务可能存在着多个流程有差异的实现版本，却都遵循着一套共用的基础逻辑，即便差异的部分也是实现的同一套接口，这既有利于框架加入新的扩展实现，也有利于保持整体流程上的一致性，更有利于将该类型业务作为一个分支子流程编织到更加宏大的系统流程中。</mark></p>
</div>
<div class="sect2 has-source-line data-line-stdin-883">
<h3 id="_流程分析">流程分析</h3>
<div class="paragraph has-source-line data-line-stdin-885">
<p>相对而言，<code>Injvm</code>版协议支持并不需要底层的跨进程通讯流程参与，因此其实现相对是最简单的。如下述类图所示：</p>
</div>
<div class="imageblock text-center has-source-line data-line-stdin-887">
<div class="content">
<img src="res_files/imgs/8_image(1)" alt="Injvm 协议实现" width="750">
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-889">
<p>图中涉及了<code>Exporter、Invoker、Protocol</code>这3个关键接口，它们有各自的抽象基类实现，并且<code>Injvm</code>针对各抽象基类提供了具体实现。简单来看，是<code>InjvmProtocol</code>作为创建工厂为调用方实例化了<code>InjvmExporter</code>和<code>InjvmInvoker</code>。但这里有必要大致了解下其实例化流程，理清二者间的关系。</p>
</div>
<div class="ulist has-source-line data-line-stdin-891">
<ul>
<li class="has-source-line data-line-stdin-891">
<p><code>InjvmInvoker&lt;T&gt;</code>：</p>
<div class="olist arabic has-source-line data-line-stdin-892">
<ol class="arabic">
<li class="has-source-line data-line-stdin-892">
<p>调用方通过<code>refer(serviceType, url)</code>传入服务接口类型和配置总线参数URL；</p>
</li>
<li class="has-source-line data-line-stdin-893">
<p><code>InjvmProtocol</code>利用其抽象方法<code>protocolBindingRefer(serviceType, url)</code>实现构建并返回一个<code>InjvmInvoker</code>实例，记做<code>injvmInvoker</code>；</p>
</li>
<li class="has-source-line data-line-stdin-894">
<p><code>refer(serviceType, url)</code>使用<code>AsyncToSyncInvoker</code>包装<code>injvmInvoker</code>，按需在被<code>invoke()</code>时将异步调用转为同步，给调用方返回包装后的<code>Invoker</code>实例<code>asyncInjvmInvoker</code>；</p>
</li>
</ol>
</div>
</li>
<li class="has-source-line data-line-stdin-895">
<p><code>InjvmExporter&lt;T&gt;</code>：</p>
<div class="olist arabic has-source-line data-line-stdin-896">
<ol class="arabic">
<li class="has-source-line data-line-stdin-896">
<p>首先，调用方经<code>ProxyFactory#getInvoker(implement, type, url)</code>获得一个<code>AbstractProxyInvoker</code>实例，记为<code>proxyInvoker</code>，它利用反射机制将<code>Invoker&lt;T&gt;#invoke(invocation)</code>调用转为对<code>implement</code>的本地调用；</p>
</li>
<li class="has-source-line data-line-stdin-897">
<p>随后，经由<code>Protocol$Adaptive</code>将<code>export(invoker)</code>方法调用转给<code>InjvmProtocol</code>；</p>
</li>
<li class="has-source-line data-line-stdin-898">
<p>最后，<code>InjvmProtocol</code>直接构建并返回一个<code>invoker</code>属性赋值为<code>proxyInvoker</code>的<code>InjvmExporter&lt;T&gt;</code>实例<code>injvmExporter</code>；</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph has-source-line data-line-stdin-900">
<p><code>Injvm</code>协议所发起的RPC调用实际上就是本地间接对服务接口实现的调用，那这个衔接的过程是怎么体现的呢？从上述两个实例化流程可以推断，<code>asyncInjvmInvoker</code>和<code>injvmExporter</code>必然存在着某种联系，使得方法调用行为能够从前者转移到属于后者的<code>proxyInvoker</code>上去。</p>
</div>
<div class="admonitionblock important has-source-line data-line-stdin-903">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph has-source-line data-line-stdin-904">
<p>根据SPI机制，Dubbo会为<code>Protocol</code>扩展点生成一个名为<code>Protocol$Adaptive</code>的适配型代理类，当<code>export(invoker)</code>或者<code>refer(type, url)</code>方法被调用时，它会根据入参搜寻到URL配置总线，由其<code>url.protocol</code>结合SPI配置找到目标<code>Protocol</code>扩展点具类，然后将当前方法调用委托给该具类的同名方法。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-907">
<h3 id="_源码剖析">源码剖析</h3>
<div class="paragraph has-source-line data-line-stdin-909">
<p>显然，经过上述章节的分析，我们基本已经清楚了实现机制——<code>InjvmInvoker&lt;T&gt;</code>的方法调用被转移到了<code>InjvmExporter&lt;T&gt;</code>，由其<code>proxyInvoker</code>负责响应。如下源码<code>exporter.getInvoker().invoke(invocation)</code>是最关键的一句：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-911">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">InjvmInvoker</span>&lt;T&gt; <span style="color:#088;font-weight:bold">extends</span> AbstractInvoker&lt;T&gt; {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> key;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Exporter&lt;?&gt;&gt; exporterMap;

    InjvmInvoker(<span style="color:#0a8;font-weight:bold">Class</span>&lt;T&gt; type, <span style="color:#0a8;font-weight:bold">URL</span> url, <span style="color:#0a8;font-weight:bold">String</span> key, <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Exporter&lt;?&gt;&gt; exporterMap) {
        <span style="color:#950">super</span>(type, url);
        <span style="color:#950">this</span>.key = key;
        <span style="color:#950">this</span>.exporterMap = exporterMap;
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> isAvailable() {
        InjvmExporter&lt;?&gt; exporter = (InjvmExporter&lt;?&gt;) exporterMap.get(key);
        <span style="color:#080;font-weight:bold">if</span> (exporter == <span style="color:#069">null</span>) {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#950">super</span>.isAvailable();
        }
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Result</span> doInvoke(Invocation invocation) <span style="color:#088;font-weight:bold">throws</span> <span style="color:#0a8;font-weight:bold">Throwable</span> {
        Exporter&lt;?&gt; exporter = InjvmProtocol.getExporter(exporterMap, getUrl());
        <span style="color:#080;font-weight:bold">if</span> (exporter == <span style="color:#069">null</span>) {
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> RpcException(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Service [</span><span style="color:#710">"</span></span> + key + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">] not found.</span><span style="color:#710">"</span></span>);
        }
        RpcContext.getContext().setRemoteAddress(LOCALHOST_VALUE, <span style="color:#00D">0</span>);
        <span style="color:#080;font-weight:bold">return</span> exporter.getInvoker().invoke(invocation);
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-946">
<p>实际上，<code>Injvm</code>使用了同一个<code>Map&lt;String, Exporter&lt;?&gt;&gt;</code>类型的Map容器记录所有本地导出的<code>Exporter&lt;?&gt;</code>对象，Key键的取值为<code>serviceKey = [{group}/]{interfaceName}[:{version}]</code>，而这个容器实际上就是<code>AbstractProtocol#exporterMap</code>，执行<code>InjvmExporter&lt;T&gt;#unexport()</code>操作时，会将对应Key键的<code>Exporter&lt;?&gt;</code>对象移除。 如下述源码：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-948">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">InjvmProtocol</span> <span style="color:#088;font-weight:bold">extends</span> AbstractProtocol <span style="color:#088;font-weight:bold">implements</span> Protocol {
    ...
    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> &lt;T&gt; Exporter&lt;T&gt; <span style="color:#080;font-weight:bold">export</span>(Invoker&lt;T&gt; invoker) <span style="color:#088;font-weight:bold">throws</span> RpcException {
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> InjvmExporter&lt;T&gt;(invoker, invoker.getUrl().getServiceKey(), exporterMap);
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> &lt;T&gt; Invoker&lt;T&gt; protocolBindingRefer(<span style="color:#0a8;font-weight:bold">Class</span>&lt;T&gt; serviceType, <span style="color:#0a8;font-weight:bold">URL</span> url) <span style="color:#088;font-weight:bold">throws</span> RpcException {
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> InjvmInvoker&lt;T&gt;(serviceType, url, url.getServiceKey(), exporterMap);
    }
}

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">InjvmExporter</span>&lt;T&gt; <span style="color:#088;font-weight:bold">extends</span> AbstractExporter&lt;T&gt; {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> key;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Exporter&lt;?&gt;&gt; exporterMap;

    InjvmExporter(Invoker&lt;T&gt; invoker, <span style="color:#0a8;font-weight:bold">String</span> key, <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Exporter&lt;?&gt;&gt; exporterMap) {
        <span style="color:#950">super</span>(invoker);
        <span style="color:#950">this</span>.key = key;
        <span style="color:#950">this</span>.exporterMap = exporterMap;
        exporterMap.put(key, <span style="color:#950">this</span>);
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> unexport() {
        <span style="color:#950">super</span>.unexport();
        exporterMap.remove(key);
    }

}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-984">
<p>我们曾经有说过，每一个扩展点具类都是单例的，为了编码的便利，Dubbo中有些具类会提供对应的单例获取方法，如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-986">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">InjvmProtocol</span> <span style="color:#088;font-weight:bold">extends</span> AbstractProtocol <span style="color:#088;font-weight:bold">implements</span> Protocol {
    ...
    private <span style="color:#088;font-weight:bold">static</span> InjvmProtocol INSTANCE;

    <span style="color:#088;font-weight:bold">public</span> InjvmProtocol() {
        INSTANCE = <span style="color:#950">this</span>;
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> InjvmProtocol getInjvmProtocol() {
        <span style="color:#080;font-weight:bold">if</span> (INSTANCE == <span style="color:#069">null</span>) {
            ExtensionLoader.getExtensionLoader(Protocol.class).
                getExtension(InjvmProtocol.NAME); <span style="color:#777">// load</span>
        }
        <span style="color:#080;font-weight:bold">return</span> INSTANCE;
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-1005">
<p>一个<code>refer</code>引用发生时，若<code>url.protocol != "injvm"</code>，只要配置了<code>(url["scope"] = "local" | url["injvm"] = true)</code>，那肯定会判定为JVM内引用，否则<code>(url["scope"] = "remote" | url["generic"] = true)</code>，则必定不是JVM内引用，除此之外只有当前<code>url</code>存在对应<code>Exporter&lt;T&gt;</code>才会认为是JVM内引用。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-1007">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">InjvmProtocol</span> <span style="color:#088;font-weight:bold">extends</span> AbstractProtocol <span style="color:#088;font-weight:bold">implements</span> Protocol {
    ...
    public <span style="color:#339;font-weight:bold">boolean</span> isInjvmRefer(<span style="color:#0a8;font-weight:bold">URL</span> url) {
        <span style="color:#0a8;font-weight:bold">String</span> scope = url.getParameter(SCOPE_KEY);
        <span style="color:#080;font-weight:bold">if</span> (SCOPE_LOCAL.equals(scope) || (url.getParameter(LOCAL_PROTOCOL, <span style="color:#069">false</span>))) {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>;
        } <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (SCOPE_REMOTE.equals(scope)) {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;
        } <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (url.getParameter(GENERIC_KEY, <span style="color:#069">false</span>)) {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;
        } <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (getExporter(exporterMap, url) != <span style="color:#069">null</span>) {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>;
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-1026">
<p>最后，<code>refer(serviceType, url)</code>微服务引用方法中，第二个<code>url</code>参数是可以使用通配符的，用于匹配一个目标微服务的<code>任意分组</code>或者<code>任意版本</code>实现，当然前提是微服务接口类名是匹配的，匹配的工具方法如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-1028">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">UrlUtils</span> {
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">boolean</span> isServiceKeyMatch(<span style="color:#0a8;font-weight:bold">URL</span> pattern, <span style="color:#0a8;font-weight:bold">URL</span> value) {
        <span style="color:#080;font-weight:bold">return</span> pattern.getParameter(INTERFACE_KEY).equals(
                value.getParameter(INTERFACE_KEY))
                &amp;&amp; isItemMatch(pattern.getParameter(GROUP_KEY),
                value.getParameter(GROUP_KEY))
                &amp;&amp; isItemMatch(pattern.getParameter(VERSION_KEY),
                value.getParameter(VERSION_KEY));
    }
    <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">boolean</span> isItemMatch(<span style="color:#0a8;font-weight:bold">String</span> pattern, <span style="color:#0a8;font-weight:bold">String</span> value) {
        <span style="color:#080;font-weight:bold">if</span> (pattern == <span style="color:#069">null</span>) {
            <span style="color:#080;font-weight:bold">return</span> value == <span style="color:#069">null</span>;
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">*</span><span style="color:#710">"</span></span>.equals(pattern) || pattern.equals(value);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-1048">
<p>然而，即便<code>serviceKey</code>已经匹配了，倘若通过<code>Exporter&lt;?&gt;.getInvoker()</code>查找到的<code>Invoker&lt;?&gt;</code>服务实例在其总线中配置了如是<code>url["generic"] = ("true" | "nativejava" | "bean" | "protobuf-json" | "raw.return")</code>这个参数，则说明对应微服务引用实例使用了泛化调用。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-1051">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">InjvmProtocol</span> <span style="color:#088;font-weight:bold">extends</span> AbstractProtocol <span style="color:#088;font-weight:bold">implements</span> Protocol {
    ...
    static Exporter&lt;?&gt; getExporter(<span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Exporter&lt;?&gt;&gt; map, <span style="color:#0a8;font-weight:bold">URL</span> key) {
        Exporter&lt;?&gt; result = <span style="color:#069">null</span>;

        <span style="color:#080;font-weight:bold">if</span> (!key.getServiceKey().contains(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">*</span><span style="color:#710">"</span></span>)) {
            result = map.get(key.getServiceKey());
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#080;font-weight:bold">if</span> (CollectionUtils.isNotEmptyMap(map)) {
                <span style="color:#080;font-weight:bold">for</span> (Exporter&lt;?&gt; exporter : map.values()) {
                    <span style="color:#080;font-weight:bold">if</span> (UrlUtils.isServiceKeyMatch(key, exporter.getInvoker().getUrl())) {
                        result = exporter;
                        <span style="color:#080;font-weight:bold">break</span>;
                    }
                }
            }
        }

        <span style="color:#080;font-weight:bold">if</span> (result == <span style="color:#069">null</span>) {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">null</span>;
        } <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (ProtocolUtils.isGeneric(
                result.getInvoker().getUrl().getParameter(GENERIC_KEY))) {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">null</span>;
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#080;font-weight:bold">return</span> result;
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-1082">
<h2 id="_dubbo协议实现_之_dubboinvokert"><code>Dubbo</code>协议实现 之 <code>DubboInvoker&lt;T&gt;</code></h2>
<div class="sectionbody">
<div class="admonitionblock important has-source-line data-line-stdin-1085">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
这里的<code>DubboInvoker</code>，其实例所代表的微服务是客户端一方的概念，表示引用服务端暴露的服务。
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph has-source-line data-line-stdin-1087">
<p><code>DubboInvoker</code>是协议层中Dubbo协议下的<code>Invoker</code>实现，当然主要是完成原生方法调用转换后的RPC方法调用，它在连接池中以轮询方式选用一个<code>ExchangeClient</code>实例将请求发送出去，随后返回一个<code>AsyncRpcResult</code>实例，在双工模式需要返回响应的情况下，需要等到服务端处理完请求返回响应才完成这个<code>CompleteableFuture&lt;AsyncRpcResult&gt;</code>，否则返回的是一个值为null，已经完成处理的值。</p>
</div>
<div class="sect2 has-source-line data-line-stdin-1089">
<h3 id="_状态管理">状态管理</h3>
<div class="paragraph has-source-line data-line-stdin-1091">
<p>先来看看其状态管理，在《Dubbo远程通讯 · 信息交换层》一文中，我们已经对<code>isAvailable()</code>做过初步的分析，其意义是只要还有一个<code>ExchangeClient</code>实例处于<code>非只读</code>状态，当前实例所代表的微服务就还可用，前提是微服务还没有执行关闭操作。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-1094">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">DubboInvoker</span>&lt;T&gt; <span style="color:#088;font-weight:bold">extends</span> AbstractInvoker&lt;T&gt; {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> ExchangeClient<span style="color:#339;font-weight:bold">[]</span> clients;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Invoker&lt;?&gt;&gt; invokers;
    ...

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> isAvailable() {
     <span style="color:#080;font-weight:bold">if</span> (!<span style="color:#950">super</span>.isAvailable()) {
         <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;
     }
     <span style="color:#080;font-weight:bold">for</span> (ExchangeClient client : clients) {
         <span style="color:#080;font-weight:bold">if</span> (client.isConnected() &amp;&amp; !client.hasAttribute(
            Constants.CHANNEL_ATTRIBUTE_READONLY_KEY)) {
             <span style="color:#777">//cannot write == not Available ?</span>
             <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>;
         }
     }
     <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-1119">
<p>一个微服务实例在Java应用中，绝大部分情况下会被多个线程并发使用，由于涉及到对共享资源<code>clients</code>和<code>invokers</code>的处理，因而<code>destroy</code>操作需要加锁处理。父类<code>AbstractInvoker#destroy()</code>方法定义要求该销毁操作只能执行一次有效操作，子类<code>DubboInvoker#destroy()</code>方法利用双检锁来确保这一点：</p>
</div>
<div class="exampleblock has-source-line data-line-stdin-1120">
<div class="content">
<div class="paragraph has-source-line data-line-stdin-1121">
<p>假如当前实例的该方法被A、B两个线程并发地调用了，在<code>!super.isDestroyed()</code>情况下，只会有一个线程A能在<code>TAG_lock</code>位置上顺利获得锁，线程B等到该锁被释放后也获得了锁，但是由于已经执行过了<code>destroy</code>销毁操作，<code>!super.isDestroyed()</code>这个条件已经不成立了，因此无论哪个线程，一旦进入临界区，均需执行<code>super.isDestroyed()</code>条件检测。</p>
</div>
</div>
</div>
<div class="listingblock has-source-line data-line-stdin-1124">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">DubboInvoker</span>&lt;T&gt; <span style="color:#088;font-weight:bold">extends</span> AbstractInvoker&lt;T&gt; {
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">ReentrantLock</span> destroyLock = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ReentrantLock</span>();

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> destroy() {

        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#950">super</span>.isDestroyed()) {
            <span style="color:#080;font-weight:bold">return</span>;
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#777">//double check to avoid dup close</span>
            destroyLock.lock();<span style="color:#777">//TAG_lock</span>
            <span style="color:#080;font-weight:bold">try</span> {
                <span style="color:#080;font-weight:bold">if</span> (<span style="color:#950">super</span>.isDestroyed()) {
                    <span style="color:#080;font-weight:bold">return</span>;
                }
                <span style="color:#950">super</span>.destroy();
                <span style="color:#080;font-weight:bold">if</span> (invokers != <span style="color:#069">null</span>) {
                    invokers.remove(<span style="color:#950">this</span>);
                }
                <span style="color:#777">//==============================</span>
                <span style="color:#777">//挨个关闭所使用到客户端连接池</span>
                <span style="color:#777">//==============================</span>
                <span style="color:#080;font-weight:bold">for</span> (ExchangeClient client : clients) {
                    <span style="color:#080;font-weight:bold">try</span> {
                        client.close(ConfigurationUtils.getServerShutdownTimeout());
                    } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#0a8;font-weight:bold">Throwable</span> t) {
                        logger.warn(t.getMessage(), t);
                    }
                }

            } <span style="color:#080;font-weight:bold">finally</span> {
                destroyLock.unlock();
            }
        }
    }

    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-1165">
<h3 id="_doinvoke_执行流程"><code>doInvoke</code> 执行流程</h3>
<div class="paragraph has-source-line data-line-stdin-1167">
<p>该章节开头部分已经初步介绍过其执行的基本流程，具体实现上也很简单，使用求魔<sup>%</sup>选定<code>ExchangeClient</code>对象后，组合请求发送和响应处理两阶段操作，给调用返回一个<code>Result</code>类型的<code>CompleteableFuture&lt;Result&gt;</code>实例。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-1169">
<p>代码中用到的AtomicPositiveInteger是一个线程安全的可用于单调递增地获得一个整数值，用于轮询获取<code>ExchangeClient</code>连接实例。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-1171">
<p>上文中已经花费大量篇幅阐述<code>AsyncRpcResult</code>的<code>subscribeTo</code>方法执行的原理，这里的应用简单讲就是新生成一个<code>AsyncRpcResult</code>对象，用它订阅<code>ExchangeClient</code>的<code>request()</code>方法返回的<code>CompletableFuture&lt;Object&gt;</code>，后者会在其完成回调事件中将结果塞入这个新产生的对象。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-1174">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">DubboInvoker</span>&lt;T&gt; <span style="color:#088;font-weight:bold">extends</span> AbstractInvoker&lt;T&gt; {
    ...

    private <span style="color:#088;font-weight:bold">final</span> AtomicPositiveInteger index = <span style="color:#080;font-weight:bold">new</span> AtomicPositiveInteger();

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">protected</span> <span style="color:#0a8;font-weight:bold">Result</span> doInvoke(<span style="color:#088;font-weight:bold">final</span> Invocation invocation) <span style="color:#088;font-weight:bold">throws</span> <span style="color:#0a8;font-weight:bold">Throwable</span> {
        RpcInvocation inv = (RpcInvocation) invocation;
        <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> methodName = RpcUtils.getMethodName(invocation);
        inv.setAttachment(PATH_KEY, getUrl().getPath());
        inv.setAttachment(VERSION_KEY, version);

        ExchangeClient currentClient;
        <span style="color:#080;font-weight:bold">if</span> (clients.length == <span style="color:#00D">1</span>) {
            currentClient = clients[<span style="color:#00D">0</span>];
        } <span style="color:#080;font-weight:bold">else</span> {
            currentClient = clients[index.getAndIncrement() % clients.length];
        }
        <span style="color:#080;font-weight:bold">try</span> {
            <span style="color:#339;font-weight:bold">boolean</span> isOneway = RpcUtils.isOneway(getUrl(), invocation);
            <span style="color:#339;font-weight:bold">int</span> timeout = getUrl().getMethodPositiveParameter(methodName,
                TIMEOUT_KEY, DEFAULT_TIMEOUT);
            <span style="color:#080;font-weight:bold">if</span> (isOneway) {
                <span style="color:#339;font-weight:bold">boolean</span> isSent = getUrl().getMethodParameter(methodName, Constants.SENT_KEY, <span style="color:#069">false</span>);
                currentClient.send(inv, isSent);
                <span style="color:#080;font-weight:bold">return</span> AsyncRpcResult.newDefaultAsyncResult(invocation);
            } <span style="color:#080;font-weight:bold">else</span> {

                <span style="color:#777">//==============================</span>
                <span style="color:#777">// 构建AsyncRpcResult实例，订阅由request()返回的CompletableFuture&lt;Object&gt;</span>
                <span style="color:#777">//==============================</span>
                AsyncRpcResult asyncRpcResult = <span style="color:#080;font-weight:bold">new</span> AsyncRpcResult(inv);
                CompletableFuture&lt;<span style="color:#0a8;font-weight:bold">Object</span>&gt; responseFuture =
                        currentClient.request(inv, timeout);
                asyncRpcResult.subscribeTo(responseFuture);

                <span style="color:#777">// save for 2.6.x compatibility, for example,</span>
                <span style="color:#777">// TraceFilter in Zipkin uses com.alibaba.xxx.FutureAdapter</span>
                FutureContext.getContext().setCompatibleFuture(responseFuture);
                <span style="color:#080;font-weight:bold">return</span> asyncRpcResult;
            }
        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#C00;font-weight:bold">TimeoutException</span> e) {
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> RpcException(RpcException.TIMEOUT_EXCEPTION,
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Invoke remote method timeout. method: </span><span style="color:#710">"</span></span>
                    + invocation.getMethodName() + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">, provider: </span><span style="color:#710">"</span></span> + getUrl()
                    + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">, cause: </span><span style="color:#710">"</span></span> + e.getMessage(), e);
        } <span style="color:#080;font-weight:bold">catch</span> (RemotingException e) {
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> RpcException(RpcException.NETWORK_EXCEPTION,
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Failed to invoke remote method: </span><span style="color:#710">"</span></span>
                    + invocation.getMethodName() + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">, provider: </span><span style="color:#710">"</span></span>
                    + getUrl() + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">, cause: </span><span style="color:#710">"</span></span> + e.getMessage(), e);
        }
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-1233">
<p>有必要提一下的是，DubboInvoker的构造函数中使用<code>new String[]{INTERFACE_KEY, GROUP_KEY, TOKEN_KEY, TIMEOUT_KEY}</code>表示基于Dubbo协议的微服务实例所关注的配置总线中的元数据，分别是“1）唯一标识微服务的接口；2）所属分组；3）运行环境所需的token；4）超时时间”，像<code>Invocation</code>实现一样，将他们从配置总线中设置为自身的附属参数，方便取用。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-1235">
<p>最后，需要看看上述用于判定当前请求是否为单工模式的<code>RpcUtils#isOneway(url, inv)</code>方法的实现，如下，默认是双工模式，否则需要显示设定<code>url[methodName + ".return"] = false</code>。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-1238">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">RpcUtils</span> {
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">boolean</span> isOneway(<span style="color:#0a8;font-weight:bold">URL</span> url, Invocation inv) {
        <span style="color:#339;font-weight:bold">boolean</span> isOneway;
        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#0a8;font-weight:bold">Boolean</span>.FALSE.toString().equals(inv.getAttachment(RETURN_KEY))) {
            isOneway = <span style="color:#069">true</span>;
        } <span style="color:#080;font-weight:bold">else</span> {
            isOneway = !url.getMethodParameter(getMethodName(inv), RETURN_KEY, <span style="color:#069">true</span>);
        }
        <span style="color:#080;font-weight:bold">return</span> isOneway;
    }
    ...
}</code></pre>
</div>
</div>
<hr>
<div class="paragraph has-source-line data-line-stdin-1255">
<p>篇幅原因，有关DubboProtocol的实现分析被抽调到下一篇文章。</p>
</div>
</div>
</div>
</div>
</div><script src="res_files/js/scrollToElement.js"></script>
<script src="res_files/js/processLinks.js"></script>
<script src="res_files/js/pickSourceLine.js"></script>
<script type="text/x-mathjax-config;executed=true">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="res_files/js/MathJax.js"></script>
<div id="color-picker-wrap" style="display: none; position: fixed; top: 0px; left: 0px; z-index: 9999;"><!----></div></body></html>