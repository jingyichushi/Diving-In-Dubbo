
<!-- saved from url=(0363)http://localhost:63342/ead61b63-b0a6-4ff2-a49a-86be75ccfd1a/source?file=%2FUsers%2Flrq%2FWorkspace%2Fmy_pub_prjs%2FDiving-In-Dubbo%2F%E3%80%90%E5%8D%81%E4%B8%80%E3%80%91Dubbo%E9%9B%86%E7%BE%A4+%E4%B9%8B+%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.adoc&mac=WKnoKWo909VGpstCf+r5Un7A75ctGWtr6tO+A003EyI=&projectUrl=%2FUsers%2Flrq%2FWorkspace%2Fmy_pub_prjs%2FDiving-In-Dubbo -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}

</style>
<link rel="stylesheet" href="res_files/css/font-awesome.min.css"><link rel="stylesheet" href="res_files/css/dejavu.css"><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 5px 0px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 5px; -webkit-border-radius: 5px; -moz-border-radius: 5px; -khtml-border-radius: 5px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 1px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck.RTL {right: .7em; left: auto}
.MathJax_MenuLabel {padding: 1px 2em 3px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #DDDDDD; margin: 4px 3px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: #606872; color: white}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head><body><div id="MathJax_Message" style="display: none;"></div><div id="content">
<h1>【十一】Dubbo集群 之 负载均衡</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock has-source-line data-line-stdin-3">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-4">
<p>In computing, load balancing improves the distribution of workloads across multiple computing resources, such as computers, a computer cluster, network links, central processing units, or disk drives. Load balancing aims to optimize resource use, maximize throughput, minimize response time, and avoid overload of any single resource. Using multiple components with load balancing instead of a single component may increase reliability and availability through redundancy.</p>
</div>
</blockquote>
</div>
<div class="paragraph has-source-line data-line-stdin-7">
<p>上述来自于维基百科中关于“负载均衡”的介绍，大致意思是：</p>
</div>
<div class="quoteblock has-source-line data-line-stdin-9">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-10">
<p>在计算机应用中，负载均衡可改善跨多个计算资源（例如计算机，计算机集群，网络链接，中央处理单元或磁盘驱动器）的工作负载分配。它旨在优化资源使用，最大化吞吐量，最小化响应时间并避免任何单个资源的过载。负载均衡利用冗余方式使用多个组件而不是单个组件提高可靠性和可用性。</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-13">
<h2 id="_负载均衡和微服务">负载均衡和微服务</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-16">
<p>在微服务开发领域，可以认为：1）不同微服务的实例发生通讯时，其RPC调用过程中会产生的一序列复杂的、业务无关的处理逻辑，既是分布式处理；2）为应对单一服务实例负载过重，或者异常导致的服务不可用，同一个微服务存在多个实例，在这多个实例中挑选一个以响应当前请求，这里涉及的一堆复杂处理逻辑，便对应可以认为是集群处理。本文所讨论的负载均衡应对的正是集群处理中的解决同一微服务多实例负载分配的问题，解决服务实例存在的单点故障问题。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-18">
<p><span class="big">负载均衡，令人容易本能地认为将任务均匀分配</span>。实际上任务的分配的考虑因素可能是负载、性能<sub>吞吐量、响应时间</sub>、业务特性等，例如同一个服务可能在北京和深圳都有部署实例，其它依赖他们的微服务在负载均衡的作用下会就近路由到其中一个实例上。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-20">
<p>技术发展日新月异，负载均衡方案也随之发生着变化，从传统服务端模式到现代微服务模式，其实现方式也经历了多次变革，在进一步了解Dubbo微服务的负载均衡前，我们先大体回顾下各种方案，主要是理解他们的大致实现原理。</p>
</div>
<div class="admonitionblock important has-source-line data-line-stdin-24">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph has-source-line data-line-stdin-25">
<p><span class="small">尽管多样，但由于始终和OSI网络通讯模型紧密相关，因而可以对应被划分在不同的层上。</span></p>
</div>
<div class="paragraph has-source-line data-line-stdin-27">
<p>下文提到的<code>NAT、DR、TUN 和 FULLNAT</code>这4种模式由于需要使用到端口信息，对应着OSI网络模型中的传输层，因而习惯上被统称为4层负载均衡，显然微服务中采用的<code>客户端 和 服务端</code>模式相应地被划分为7层负载均衡。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-30">
<h2 id="_传统服务端模式">传统服务端模式</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-32">
<p>注：<span class="small">本章节主要参考<a href="https://cloud.tencent.com/developer/article/1031624">大型网站架构系列：负载均衡详解</a>、<a href="http://blog.sina.com.cn/s/blog_620c47630102v2iz.html">吴佳明(普空)：LVS在大规模网络环境中的应用 </a> 和 <a href="https://yizhi.ren/2019/05/03/lvs">LVS的原理-工作模式</a>。</span></p>
</div>
<div class="paragraph has-source-line data-line-stdin-34">
<p>负载均衡最常使用的场景是从多个服务器提供单个Internet服务。例如流行的网站、大型Internet中继聊天网络、高带宽文件传输站点、网络新闻服务器、域名系统服务器和数据库。传统负载均衡的经典模式如下图所示：</p>
</div>
<div class="imageblock has-source-line data-line-stdin-36">
<div class="content">
<img src="res_files/imgs/11_image" alt="经典负载均衡架构">
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-38">
<p>其中的负载均衡设备根据负载均衡策略将接入的用户请求分发到集群的某一台机器上，同一应用部署到多个机器上便组成了集群。</p>
</div>
<div class="exampleblock has-source-line data-line-stdin-40">
<div class="content">
<div class="quoteblock has-source-line data-line-stdin-41">
<blockquote>
<div class="olist arabic has-source-line data-line-stdin-42">
<ol class="arabic">
<li class="has-source-line data-line-stdin-42">
<p><code>DS</code>：director server，即负载均衡器，根据一定的负载均衡算法将流量分发到后端的真实服务器上；</p>
</li>
<li class="has-source-line data-line-stdin-43">
<p><code>RS</code>：real server 真实的提供服务的server，可被DS划分到一个或多个负载均衡组；</p>
</li>
<li class="has-source-line data-line-stdin-44">
<p><code>VIP</code>：VS的IP，client请求服务的DIP（destination IP address），定义在DS上，client或其网关需要有其路由；</p>
</li>
</ol>
</div>
</blockquote>
</div>
<div class="ulist has-source-line data-line-stdin-47">
<ul>
<li class="has-source-line data-line-stdin-47">
<p><code>CIP</code> &amp; <code>DIP</code> &amp; <code>RIP</code>：分别代表客户端client的IP、DS的IP、RS的IP；</p>
</li>
<li class="has-source-line data-line-stdin-48">
<p><code>VIP</code>用于对外提供服务，采用的是公网IP，而<code>DIP</code>是负载均衡器的IP，虽和<code>VIP</code>属于同一主机，但一般是当前局域网IP。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-54">
<h3 id="_dns负载均衡">DNS负载均衡</h3>
<div class="paragraph has-source-line data-line-stdin-56">
<p>在DNS域名服务器中将集群中所有机器IP配置为指向同一域名，由DNS根据用户请求中内含特征将请求就近转发给其中一个实例。</p>
</div>
<div class="imageblock has-source-line data-line-stdin-58">
<div class="content">
<img src="res_files/imgs/11_image(1)" alt="DNS负载均衡">
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-60">
<p>该模式由于掌控权控制在域名服务商手里，扩展性受到限制。</p>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-62">
<h3 id="_nat模式ip负载均衡">(NAT模式)IP负载均衡</h3>
<div class="paragraph has-source-line data-line-stdin-64">
<p>用户请求接入后，<code>DS</code>在系统内核中<code>&lt;Src:CIP,Dst:VIP&gt;</code>根据负载均衡算法选用到的<code>RS</code>修改为<code>&lt;Src:CIP,Dst:RIP&gt;</code><sup>DNAT</sup>，封装成新的IP请求报文后发送给<code>RS</code>，<code>RS</code>处理完请求将响应返回给<code>DS</code>，<code>DS</code>将收到的IP响应报文<code>&lt;Src:RIP,Dst:CIP&gt;</code>修改为<code>&lt;Src:VIP,Dst:CIP&gt;</code><sup>SNAT</sup>，最后返回给client。</p>
</div>
<div class="imageblock has-source-line data-line-stdin-66">
<div class="content">
<img src="res_files/imgs/11_image(2)" alt="IP负载均衡">
</div>
</div>
<div class="admonitionblock note has-source-line data-line-stdin-69">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph has-source-line data-line-stdin-70">
<p>1）<code>RS</code>的网关必须设置为<code>DS</code>；2）需要开启<code>IP-Forward</code>支持<code>DS</code>修改源IP并转发数据包；</p>
</div>
<div class="paragraph has-source-line data-line-stdin-72">
<p><code>IP-Forward</code>：当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将数据包发往本机另一块网卡，该网卡根据路由表继续发送数据包。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph has-source-line data-line-stdin-75">
<p>这一模式还存在另外一种形式：<code>DS</code>在接入请求后，将IP请求报文修改为<code>&lt;Src:VIP,Dst:RIP&gt;</code>，也即对数据包的目标IP地址进行修改的同时，将数据包的源地址设置为自身，也即源地址转换。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-77">
<p>缺点是集群的最大吞吐量受制于负载均衡服务器的带宽。</p>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-79">
<h3 id="_dr模式链路层负载均衡">(DR模式)链路层负载均衡</h3>
<div class="paragraph has-source-line data-line-stdin-81">
<p><code>RS</code>集群和<code>DS</code><sub>不作为网关出现</sub>处于同一物理网络中的，Client发送一个<code>&lt;Src:CIP,Dst:VIP&gt;</code>IP请求报文，当<code>DS</code>接受请求后挑中某个<code>RS</code>作为目标机，并将其当前报文中的MAC地址设成<code>R_MAC</code>，随后发送一个ARP广播出去，私有<code>loopback</code>环回接口绑定了VIP的所有<code>RS</code>接受到请求后，只有MAC地址为<code>R_MAC</code>的<code>RS</code>服务器会响应请求。</p>
</div>
<div class="imageblock has-source-line data-line-stdin-84">
<div class="content">
<img src="res_files/imgs/11_image(3)" alt="DR负载均衡">
</div>
</div>
<div class="admonitionblock note has-source-line data-line-stdin-87">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="olist arabic has-source-line data-line-stdin-88">
<ol class="arabic">
<li class="has-source-line data-line-stdin-88">
<p><code>RS</code>集群中所有机器将<code>VIP</code>绑定在<code>loopback</code>环回接口上的原因有三：1）<code>DS</code>在转发请求时并没有修改目标IP地址，而报文接受方需要同时匹配目标IP和目标MAC地址，否则丢包处理，因此<code>RS</code>主机需要绑定<code>VIP</code>；2）在同一个网段中是不能存在IP冲突的，即便是虚拟IP，但<code>loopback</code>环回接口绑定的IP地址是本机私有的，不在网络上共享，因而不会产生冲突；3）当前物理网络中，只存在一个IP为<code>VIP</code>的主机，因此client使用<code>VIP</code>构建报文后能准确匹配到目标<code>DS</code>主机。</p>
</li>
<li class="has-source-line data-line-stdin-91">
<p>在局域网中的所有机器都是通过广播的形式进行通讯的，其中一台机器发送的消息会被所有其他机器接受到，后者会将报文中的目标地址<sub>包括IP信息和MAC地址</sub>和自身的比对，如果一致就接受并做响应处理，否则略过。</p>
</li>
<li class="has-source-line data-line-stdin-93">
<p>网络通讯发生的前提是知晓彼此MAC地址，当局域网中的客户端机器不知道目标机器的MAC地址时，可以在通讯正式发生之前将其设为12个F的广播地址，目标机器收到广播后会返回自身MAC地址信息，这一过程是受ARP协议支持的。DR负载均衡模式中，由于<code>DS</code>已经明确指明了目标机的MAC地址，目标IP地址VIP也和本机绑定在环回接口的私有IP一致，因而不会有ARP协议参与响应。</p>
</li>
</ol>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph has-source-line data-line-stdin-97">
<p>该模式中，<code>DS</code>无需处理响应和<code>Ip-Forward</code>数据转发，因而它不会像IP负载均衡模式中那样成为瓶颈。</p>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-99">
<h3 id="_tun模式ip_tunnel负载均衡">(TUN模式)IP tunnel负载均衡</h3>
<div class="paragraph has-source-line data-line-stdin-101">
<p>接受到报文后，<code>DS</code>依然执行负载算法挑选出<code>RS</code>；在报文转发给<code>RS</code>前会先对其进行IP封包<sub>形成IPIP包</sub>，报文内容为<code>[&lt;Src:DIP,Dst:RIP&gt;,&lt;Src:CIP,Dst:VIP&gt;,…​]</code>，随后报文被发给<code>RS</code>；<code>RS</code>收到报文后，剥离掉IP隧道包头，发现还原得到IP报文<code>[&lt;Src:CIP,Dst:VIP&gt;,…​]</code>中的目标IP<sub>也即VIP</sub>和绑定在自身环回接口上的一致，因而接受报文并处理响应，最后使用该环回接口经实体网卡将数据发送给client<sub>由解IP包获得源IP地址CIP确定的客户机</sub>。</p>
</div>
<div class="imageblock has-source-line data-line-stdin-103">
<div class="content">
<img src="res_files/imgs/11_image(4)" alt="多级全局式负载均衡">
</div>
</div>
<div class="admonitionblock note has-source-line data-line-stdin-106">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph has-source-line data-line-stdin-107">
<p>IP隧道：报文发送方在IP头的外部再包裹一个IP头，接收方先解析出第一个IP头，然后再按照正常流程处理剩下的的IP数据包。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph has-source-line data-line-stdin-110">
<p>该模式中，每个数据包都要新增IP报头，如果收到的数据包已经达到以太网帧最大长度1.5K，会因为IP报头没法添入而引发异常。</p>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-112">
<h3 id="_fullnat模式ip负载均衡">(FULLNAT模式)IP负载均衡</h3>
<div class="paragraph has-source-line data-line-stdin-114">
<p><code>NAT、DR、TUN</code>这3种模式要么配置复杂，要么限定只能使用于同一局域网，因而淘宝在<code>NAT</code>模式的基础上提出了FULLNAT模式。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-116">
<p>用户请求接入后，<code>DS</code>在系统内核中<code>&lt;Src:CIP,Dst:VIP&gt;</code>根据负载均衡算法选用到的<code>RS</code>修改为<code>&lt;Src:DIP,Dst:RIP&gt;</code>，封装成新的IP请求报文后发送给<code>RS</code>，<code>RS</code>处理完请求将响应返回给<code>DS</code>，<code>DS</code>将收到的IP响应报文<code>&lt;Src:RIP,Dst:DIP&gt;</code>修改为<code>&lt;Src:VIP,Dst:CIP&gt;</code>，最后返回给client。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-118">
<p>不同于<code>NAT</code>模式的是，<code>NAT</code>模式中<code>DS</code>对入站报文和出站报文分别做DNAT和SNAT处理，如下图：</p>
</div>
<div class="imageblock has-source-line data-line-stdin-120">
<div class="content">
<img src="res_files/imgs/11_image(5)" alt="DNAT+SNAT">
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-122">
<p>而FULLNAT模式对入出站报文均做FULLNAT<sub>DNAT+SNAT</sub>处理，在公网VIP和局域网DIP间转换，如下图：</p>
</div>
<div class="imageblock has-source-line data-line-stdin-124">
<div class="content">
<img src="res_files/imgs/11_image(6)" alt="FULLNAT">
</div>
</div>
<div class="quoteblock has-source-line data-line-stdin-126">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-128">
<p><code>FULLNAT模式</code>的问题是：RS无法获得CIP，淘宝提出TOA概念，主要原理是“将client address放到了TCP Option里面带给后端RS，RS收到后保存在socket的结构体里并通过toa内核模块hook了getname函数，这样当用户调用getname获取远端地址时，返回的是保存在socket的TCPOption的IP。”</p>
</div>
</blockquote>
</div>
<div class="paragraph has-source-line data-line-stdin-131">
<p><code>FULLNAT模式</code>主要的思想是把网关和其下机器的通信，改为了普通的网络通信，从而解决了跨局域网通讯的问题，大大提高了运维部署的便利性。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-133">
<p><code>RS</code>的增减可能会影响到客户端连接不能固定落到某同一个<code>RS</code>主机上，要求DS使用一致性算法来调度客户端的连接。</p>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-135">
<h3 id="_混合型负载均衡">混合型负载均衡</h3>
<div class="sect3 has-source-line data-line-stdin-137">
<h4 id="_多级全局式">多级全局式</h4>
<div class="paragraph has-source-line data-line-stdin-139">
<p>由于多个服务器群内硬件设备、各自的规模、提供的服务等的差异，可以考虑给每个服务器群采用最合适的负载均衡方式，然后再将这多个服务器集群组成一个规模更大的服务器集群，在前面再增加一个全局负载均衡服务器，以一个整体向外界提供服务，从而达到最佳的性能。</p>
</div>
<div class="imageblock has-source-line data-line-stdin-142">
<div class="content">
<img src="res_files/imgs/11_image(7)" alt="多级全局式负载均衡">
</div>
</div>
</div>
<div class="sect3 has-source-line data-line-stdin-144">
<h4 id="_动静分离式">动静分离式</h4>
<div class="paragraph has-source-line data-line-stdin-146">
<p>流媒体特别发达的今天，类似新闻、图片社交类的网站，其富文本交互会涉及到大量的静态资源，它们可能占比不算特别大，但访问很频繁，变化却不那么频繁。于提供这类服务的服务器集群而言，可以采用动静分离模式，在负载均衡服务器前再增设一台反向代理服务器，将静态资源交由它处理，该模式下的反向代理服务器可以起到缓存和动态请求分发的作用，当静态资源已有缓存时，可直接返回。</p>
</div>
<div class="imageblock has-source-line data-line-stdin-148">
<div class="content">
<img src="res_files/imgs/11_image(8)" alt="动静分离式负载均衡">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-150">
<h2 id="_现代微服务模式">现代微服务模式</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-152">
<p>微服务开发中，传统服务模式使用的负载均衡模式基本不再适用，即便使用同一原理，也得对应重新适配。</p>
</div>
<div class="sect2 has-source-line data-line-stdin-154">
<h3 id="_客户端模式">客户端模式</h3>
<div class="paragraph has-source-line data-line-stdin-156">
<p>微服务架构模式中，离不开服务注册中心的支持，也正是因为有了它的加持，大多数微服务框架会采用基于客户端模式的负载均衡实现。基本原理是：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-158">
<ol class="arabic">
<li class="has-source-line data-line-stdin-158">
<p>服务提供者Provider的实例启动时会将其服务名称、地址等基本信息上报到注册中心Registry，形成该Provider的一个服务实例列表；</p>
</li>
<li class="has-source-line data-line-stdin-159">
<p>在服务消费者Consumer提供服务逻辑名通过Registry对Provider进行引用时，Registry会返回一个含有1到多个其引用实例的列表RefList；</p>
</li>
<li class="has-source-line data-line-stdin-160">
<p>Consumer将RefList缓存在本地，当发起RPC调用时，会采用负载均衡算法从RefList中筛选一个Provider的服务实例<sub>已经获取到用于通讯的地址信息(IP，主机名，端口号)</sub>作为最终被调用对象；</p>
</li>
<li class="has-source-line data-line-stdin-161">
<p>Provider和Consumer同Registry始终保持着长连接，当Provider的某个服务实例宕机或下线时，该实例对应会被从Registry移除，同时Consumer也第一时间感知到这种变化，对应更新本地针对Provider的RefList。</p>
</li>
</ol>
</div>
<div class="imageblock has-source-line data-line-stdin-163">
<div class="content">
<img src="res_files/imgs/11_image(9)" alt="微服务客户端负载均衡">
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-165">
<p>这种模式的优点是没有负载均衡服务器存在所产生的中心瓶颈，缺点是具有较高的内部复杂性，也会加重网络流量负载。</p>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-167">
<h3 id="_服务端模式">服务端模式</h3>
<div class="paragraph has-source-line data-line-stdin-169">
<p>实际上上述所有提到的所有传统服务端模式的负载均衡方案都可以概括为服务端模式，而本章所述的服务端模式是在微服务开发下使用的负载均衡方案，实现方式非常不同。如下图所示，同上述客户端模式对比，服务消费者Consumer和服务提供者Provider中间横亘着一
个依赖于注册中心Registry的负载均衡器LB。</p>
</div>
<div class="imageblock has-source-line data-line-stdin-172">
<div class="content">
<img src="res_files/imgs/11_image(10)" alt="微服务服务端负载均衡">
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-174">
<p>此种模式下，在Consumer提供Provider的服务逻辑名发起RPC调用时，会先经LB先从Registry查询获得Provider的服务引用实例列表RefList，再由LB使用负载均衡算法从RefList中筛选出一个引用实例，最后才能最终完成RPC调用。由于LB所处的位置让它同时具备了反向代理的作用，因而可以内置包括服务发现机制、SSL认证等功能，而这正是承载着实现微服务边车模式的容器的职责所在，也就是说负载均衡器通常是内置在部署微服务的容器中的。</p>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-176">
<h2 id="_负载均衡算法">负载均衡算法</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-178">
<p>服务集群中已知存在若干可用<code>RS</code>，负载均衡器接入请求后，会负责选中一台<code>RS</code>主机处理请求，选中的这个过程涉及的正是负责均衡调度算法。具体采用何种算法则需要考量整个集群的特性，尽最大可能地提升整个集群的处理能力。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-180">
<p>常见的负载均衡算法有<code>轮询、随机、最少链接、源地址散列、加权</code>，该章节介绍部分来自<a href="https://www.cnblogs.com/itfly8/p/5043452.html">大型网站架构系列：负载均衡详解（2）</a>。</p>
</div>
<div class="sect2 has-source-line data-line-stdin-182">
<h3 id="_轮询">轮询</h3>
<div class="quoteblock has-source-line data-line-stdin-184">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-185">
<p>将所有请求，依次分发到每台服务器上，适合服务器硬件同相同的场景。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-187">
<p>优点：服务器请求数目相同；</p>
</div>
<div class="paragraph has-source-line data-line-stdin-189">
<p>缺点：服务器压力不一样，不适合服务器配置不同的情况；</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-192">
<h3 id="_随机">随机</h3>
<div class="quoteblock has-source-line data-line-stdin-194">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-195">
<p>请求随机分配到各个服务器。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-197">
<p>优点：使用简单；</p>
</div>
<div class="paragraph has-source-line data-line-stdin-199">
<p>缺点：不适合机器配置不同的场景；</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-202">
<h3 id="_最少链接">最少链接</h3>
<div class="quoteblock has-source-line data-line-stdin-204">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-205">
<p>将请求分配到连接数最少的服务器（目前处理请求最少的服务器）。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-207">
<p>优点：根据服务器当前的请求处理情况，动态分配；</p>
</div>
<div class="paragraph has-source-line data-line-stdin-209">
<p>缺点：算法实现相对复杂，需要监控服务器请求连接数；</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-212">
<h3 id="_源地址散列">源地址散列</h3>
<div class="quoteblock has-source-line data-line-stdin-214">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-215">
<p>根据IP地址进行Hash计算，得到IP地址。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-217">
<p>优点：将来自同一IP地址的请求，同一会话期内，转发到相同的服务器；实现会话粘滞。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-219">
<p>缺点：目标服务器宕机后，会话会丢失；</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-222">
<h3 id="_加权">加权</h3>
<div class="quoteblock has-source-line data-line-stdin-224">
<blockquote>
<div class="paragraph has-source-line data-line-stdin-225">
<p>在轮询，随机，最少链接，Hash’等算法的基础上，通过加权的方式，进行负载服务器分配。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-227">
<p>优点：根据权重，调节转发服务器的请求数目；</p>
</div>
<div class="paragraph has-source-line data-line-stdin-229">
<p>缺点：使用相对复杂；</p>
</div>
</blockquote>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-stdin-232">
<h2 id="_dubbo负载均衡实现">Dubbo负载均衡实现</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-stdin-234">
<p>Dubbo中的负载均衡采取7层客户端模式，实现的算法有<code>轮询、随机、最少链接、源地址散列</code>这4种。</p>
</div>
<div class="sect2 has-source-line data-line-stdin-236">
<h3 id="_总体方案">总体方案</h3>
<div class="paragraph has-source-line data-line-stdin-238">
<p>Dubbo微服务中的负载目的是从同一微服务的多个实例中挑选一个微服务引用实例<sup>Invoker</sup>执行当前RPC方法。Invoker是RPC方法调用的执行体，仅包含了服务级别的配置数据，要实现负载均衡中的粘滞还得有更多方法级别的数据——Invocation类型的入参。Dubbo的负载均衡是一个扩展点，定义及生成代码如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-240">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@SPI</span>(RandomLoadBalance.NAME)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">LoadBalance</span> {

    <span style="color:#007">@Adaptive</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">loadbalance</span><span style="color:#710">"</span></span>)
    &lt;T&gt; Invoker&lt;T&gt; select(<span style="color:#0a8;font-weight:bold">List</span>&lt;Invoker&lt;T&gt;&gt; invokers, <span style="color:#0a8;font-weight:bold">URL</span> referUrl, Invocation invocation) <span style="color:#088;font-weight:bold">throws</span> RpcException;

}

<span style="color:#777">//==============================================</span>
<span style="color:#777">//对应生成代码</span>
<span style="color:#777">//==============================================</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LoadBalance</span><span style="color:#F00;background-color:#FAA">$</span>Adaptive <span style="color:#088;font-weight:bold">implements</span> LoadBalance {
    <span style="color:#088;font-weight:bold">public</span> Invoker select(<span style="color:#0a8;font-weight:bold">List</span> invokers, <span style="color:#0a8;font-weight:bold">URL</span> referUrl, Invocation invocation) <span style="color:#088;font-weight:bold">throws</span> RpcException {
        <span style="color:#080;font-weight:bold">if</span> (referUrl == <span style="color:#069">null</span>) <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalArgumentException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">url == null</span><span style="color:#710">"</span></span>);
        <span style="color:#0a8;font-weight:bold">URL</span> url = referUrl;
        <span style="color:#080;font-weight:bold">if</span> (invocation == <span style="color:#069">null</span>) <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalArgumentException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">invocation == null</span><span style="color:#710">"</span></span>);
        <span style="color:#0a8;font-weight:bold">String</span> methodName = invocation.getMethodName();
        <span style="color:#0a8;font-weight:bold">String</span> extName = url.getMethodParameter(methodName, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">loadbalance</span><span style="color:#710">"</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">random</span><span style="color:#710">"</span></span>);
        <span style="color:#080;font-weight:bold">if</span> (extName == <span style="color:#069">null</span>)
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalStateException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Failed to get extension (LoadBalance) name from url (</span><span style="color:#710">"</span></span>
                    + url.toString() + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">) use keys([loadbalance])</span><span style="color:#710">"</span></span>);
        LoadBalance extension = (LoadBalance) ExtensionLoader.getExtensionLoader(
                LoadBalance.class).getExtension(extName);
        <span style="color:#080;font-weight:bold">return</span> extension.select(invokers, referUrl, invocation);
    }

}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-270">
<p>上述生成代码中，说明引用服务时传入的配置总参<code>URL referUrl</code>中如果含有配置项<code>methodName + "." + "loadbalance"</code>，则采用名称与其值所对应的负载均衡算法<sub>扩展点具类</sub>，否则则使用随机算法<sub>由<code>"random"</code>指定</sub>。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-272">
<p>Dubbo也特地对于无需执行负载均衡算法的场景做了统一处理，定义了如下抽象类，子类相应实现<code>doSelect()</code>抽象方法即可：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-275">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">abstract</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AbstractLoadBalance</span> <span style="color:#088;font-weight:bold">implements</span> LoadBalance {
    ...
    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> &lt;T&gt; Invoker&lt;T&gt; select(<span style="color:#0a8;font-weight:bold">List</span>&lt;Invoker&lt;T&gt;&gt; invokers, <span style="color:#0a8;font-weight:bold">URL</span> url, Invocation invocation) {
        <span style="color:#080;font-weight:bold">if</span> (CollectionUtils.isEmpty(invokers)) {
            <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">null</span>;
        }
        <span style="color:#080;font-weight:bold">if</span> (invokers.size() == <span style="color:#00D">1</span>) {
            <span style="color:#080;font-weight:bold">return</span> invokers.get(<span style="color:#00D">0</span>);
        }
        <span style="color:#080;font-weight:bold">return</span> doSelect(invokers, url, invocation);
    }

    <span style="color:#088;font-weight:bold">protected</span> <span style="color:#088;font-weight:bold">abstract</span> &lt;T&gt; Invoker&lt;T&gt; doSelect(
        <span style="color:#0a8;font-weight:bold">List</span>&lt;Invoker&lt;T&gt;&gt; invokers, <span style="color:#0a8;font-weight:bold">URL</span> url, Invocation invocation);
}</code></pre>
</div>
</div>
</div>
<div class="sect2 has-source-line data-line-stdin-294">
<h3 id="_算法实现">算法实现</h3>
<div class="paragraph has-source-line data-line-stdin-296">
<p>JVM是按需延迟执行类加载的，虚拟机成功启动后，需要经过一段预热时间，性能才能达到最优。于Dubbo微服务而言也是同一个道理，同一微服务的不同实例，其导出时机并不相同，已经过了预热阶段的实例可以承担更多的流量，而还在预热阶段的实例正处于性能爬升时期，应慢慢释放其流量分摊能力，因此抽象父类<code>AbstractLoadBalance</code>中还专门为此定义了一个用于根据预热和启动时间计算出某个实例应分摊流量的权重。</p>
</div>
<div class="admonitionblock note has-source-line data-line-stdin-299">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
已过预热阶段的所有实例的默认权重为100，可以根据实例所处环境<sub>I/O、CPU等能力因素</sub>单独配置其权重。
</td>
</tr>
</tbody></table>
</div>
<div class="exampleblock has-source-line data-line-stdin-301">
<div class="content">
<div class="paragraph has-source-line data-line-stdin-302">
<p>预热阶段流量分摊：</p>
</div>
<div class="ulist has-source-line data-line-stdin-304">
<ul>
<li class="has-source-line data-line-stdin-304">
<p>权重计算公式：<code>配置权重 × (实例启动耗时 ÷ 实例预热配时)</code></p>
</li>
<li class="has-source-line data-line-stdin-305">
<p>权重取值范围：<code>[1 , 配置权重]</code></p>
</li>
</ul>
</div>
<div class="paragraph has-source-line data-line-stdin-307">
<p>所涉计算因子：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-309">
<ol class="arabic">
<li class="has-source-line data-line-stdin-309">
<p>配置权重：<code>invoker.url[invocation.methodName + "." + "weight"] | 100</code></p>
</li>
<li class="has-source-line data-line-stdin-310">
<p>实例导出时间：<code>exportTime = invoker.url["timestamp"]</code></p>
</li>
<li class="has-source-line data-line-stdin-311">
<p>实例启动耗时：<code>System.currentTimeMillis() - exportTime</code></p>
</li>
<li class="has-source-line data-line-stdin-312">
<p>实例预热配时：<code>invoker.url["warmup"] | 10 * 60 * 1000</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-315">
<p>流量权重计算实现源码如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-317">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">abstract</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AbstractLoadBalance</span> <span style="color:#088;font-weight:bold">implements</span> LoadBalance {
    ...
    static <span style="color:#339;font-weight:bold">int</span> calculateWarmupWeight(<span style="color:#339;font-weight:bold">int</span> uptime, <span style="color:#339;font-weight:bold">int</span> warmup, <span style="color:#339;font-weight:bold">int</span> weight) {
        <span style="color:#339;font-weight:bold">int</span> ww = (<span style="color:#339;font-weight:bold">int</span>) ( uptime / ((<span style="color:#339;font-weight:bold">float</span>) warmup / weight));
        <span style="color:#080;font-weight:bold">return</span> ww &lt; <span style="color:#00D">1</span> ? <span style="color:#00D">1</span> : (<span style="color:#0a8;font-weight:bold">Math</span>.min(ww, weight));
    }
    <span style="color:#339;font-weight:bold">int</span> getWeight(Invoker&lt;?&gt; invoker, Invocation invocation) {
        <span style="color:#339;font-weight:bold">int</span> weight = invoker.getUrl().getMethodParameter(invocation.getMethodName(), WEIGHT_KEY, DEFAULT_WEIGHT);
        <span style="color:#080;font-weight:bold">if</span> (weight &gt; <span style="color:#00D">0</span>) {
            <span style="color:#339;font-weight:bold">long</span> timestamp = invoker.getUrl().getParameter(TIMESTAMP_KEY, <span style="color:#00D">0L</span>);
            <span style="color:#080;font-weight:bold">if</span> (timestamp &gt; <span style="color:#00D">0L</span>) {
                <span style="color:#339;font-weight:bold">long</span> uptime = <span style="color:#0a8;font-weight:bold">System</span>.currentTimeMillis() - timestamp;
                <span style="color:#080;font-weight:bold">if</span> (uptime &lt; <span style="color:#00D">0</span>) {
                    <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">1</span>;
                }
                <span style="color:#339;font-weight:bold">int</span> warmup = invoker.getUrl().getParameter(WARMUP_KEY, DEFAULT_WARMUP);
                <span style="color:#080;font-weight:bold">if</span> (uptime &gt; <span style="color:#00D">0</span> &amp;&amp; uptime &lt; warmup) {
                    weight = calculateWarmupWeight((<span style="color:#339;font-weight:bold">int</span>)uptime, warmup, weight);
                }
            }
        }
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#0a8;font-weight:bold">Math</span>.max(weight, <span style="color:#00D">0</span>);
    }
}</code></pre>
</div>
</div>
<div class="sect3 has-source-line data-line-stdin-344">
<h4 id="_随机加权随机">随机<sub><code>加权随机</code></sub></h4>
<div class="paragraph has-source-line data-line-stdin-346">
<p>熟悉概率学的话就比较清楚，在指定区间产生随机数，样本足够大的话，总体而言随机数分布会比较均匀。当所有实例的权重都一样，可以认为由其组成的整数区间中<sub>所有元素装入到列表，列表索引依顺序构成的整数序列</sub>，每一个元素参与均分获得一个单位的子区间，因而直接用元素总数取随机数获得索引位置是成立的，也即可以使用<code>ThreadLocalRandom.current()</code>取索引<code>nextInt(number of invokers)</code>可以获得当前随机数的所对应的实例。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-348">
<p>权重不等的情况下，可以想象成总区间被放大了，对应产生衍生列表，比如<code>arr1[A:2,B:3,C:1]≈arr1'[A,A',B,B',B',C]</code>，权重取总，在以总值取随机数，不难理解B被取到的概率更高。也就是说可以先使用<code>w1 + w2 + …​ + wn</code>获得权重总和得到<code>total</code>，再依其取随机数——<code>rd = nextInt(total)</code>，最后便可以依据<code>rd</code>来获取到当前随机取到的实例。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-350">
<p>接下来如何判断<code>rd</code>对应的是列表中的哪个索引值呢？<code>rd</code>是在被放大的区间中生成的，以它为索引值找到它对应位置的元素<sub>若干相同元素由同一个衍生</sub>，由该元素<sub>或为其衍生元素，比如<code>B'</code></sub>在原列表中找到的对应位置即为想要取得的索引值。当然，这只是便于理解的一种想象，继续深入观察下衍生列表<code>arr'</code>，假设<code>rd=4</code>，该位置的元素为第二个<code>B'</code>，而它前面有两个<code>A</code><sub><code>A'</code>由<code>A</code>衍生</sub>，还有两个<code>B</code>，这时会发现都列表的元素挨个迭代，取权重<sub>整数</sub>累加，直到累加值大于<code>rd</code>为止，此时所在迭代元素即为想要随机取到的实例。转为表达式也即<code>w1 + w2 + …​ + wx &gt; rd</code>，它等价于<code>rd - w1 - w2 - …​ - wx &lt; 0</code>，其中<code>wx</code>是首个表达式的元素。这时理解下述实现源码就不难了，如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-353">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">RandomLoadBalance</span> <span style="color:#088;font-weight:bold">extends</span> AbstractLoadBalance {

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> NAME = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">random</span><span style="color:#710">"</span></span>;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">protected</span> &lt;T&gt; Invoker&lt;T&gt; doSelect(<span style="color:#0a8;font-weight:bold">List</span>&lt;Invoker&lt;T&gt;&gt; invokers, <span style="color:#0a8;font-weight:bold">URL</span> url, Invocation invocation) {
        <span style="color:#339;font-weight:bold">int</span> length = invokers.size();
        <span style="color:#339;font-weight:bold">boolean</span> sameWeight = <span style="color:#069">true</span>;
        <span style="color:#339;font-weight:bold">int</span><span style="color:#339;font-weight:bold">[]</span> weights = <span style="color:#080;font-weight:bold">new</span> <span style="color:#339;font-weight:bold">int</span>[length];
        <span style="color:#339;font-weight:bold">int</span> firstWeight = getWeight(invokers.get(<span style="color:#00D">0</span>), invocation);
        weights[<span style="color:#00D">0</span>] = firstWeight;
        <span style="color:#339;font-weight:bold">int</span> totalWeight = firstWeight;
        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> i = <span style="color:#00D">1</span>; i &lt; length; i++) {
            <span style="color:#339;font-weight:bold">int</span> weight = getWeight(invokers.get(i), invocation);
            weights[i] = weight;
            totalWeight += weight;

            <span style="color:#777">//所有后续的权重和首个权重对比，首个不等就能确认整个列表权重不等</span>
            <span style="color:#080;font-weight:bold">if</span> (sameWeight &amp;&amp; weight != firstWeight) {
                sameWeight = <span style="color:#069">false</span>;
            }
        }


        <span style="color:#080;font-weight:bold">if</span> (totalWeight &gt; <span style="color:#00D">0</span> &amp;&amp; !sameWeight) {
            <span style="color:#777">//在扩展区间取随机数</span>
            <span style="color:#339;font-weight:bold">int</span> offset = ThreadLocalRandom.current().nextInt(totalWeight);
            <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> i = <span style="color:#00D">0</span>; i &lt; length; i++) {
                <span style="color:#777">//挨个迭代元素，直到offset - weights[i] &lt; 0</span>
                offset -= weights[i];
                <span style="color:#080;font-weight:bold">if</span> (offset &lt; <span style="color:#00D">0</span>) {
                    <span style="color:#080;font-weight:bold">return</span> invokers.get(i);
                }
            }
        }
        <span style="color:#777">// If all invokers have the same weight value or totalWeight=0, return evenly.</span>
        <span style="color:#080;font-weight:bold">return</span> invokers.get(ThreadLocalRandom.current().nextInt(length));
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock note has-source-line data-line-stdin-397">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph has-source-line data-line-stdin-398">
<p><strong>随机数</strong>：随机数的产生取决于种子和算法，这意味着相同算法的情况下，种子的强度决定了随机数的随机性：</p>
</div>
<div class="ulist has-source-line data-line-stdin-400">
<ul>
<li class="has-source-line data-line-stdin-400">
<p>Random的种子是System.currentTimeMillis()，所以它的随机数在理论上和实际中都是线性可预测的；</p>
</li>
<li class="has-source-line data-line-stdin-401">
<p>SecureRandom比较适合安全性要求高的场景，它会例如如键盘输入时间、CPU时钟、内存使用状态、硬盘空闲空间、IO延时进程数量、线程数量等信息来得到一个近似随机的种子，强度高以致实际中几乎没法预测。</p>
</li>
</ul>
</div>
<div class="paragraph has-source-line data-line-stdin-403">
<p>Random是基于CAS实现线程安全的，因此不适合在高并发的多线程容易产生资源争用的环境下使用，而ThreadLocalRandom是线程本地，内部实现也没有使用CAS，因而效率高。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-405">
<p>生成新的随机数需要首先根据老的种子生成新的种子，然后使用新的种子来计算得到新的随机数，因此在并发情况下，Random的种子容易成为被争用资源而导致大量线程自旋重试而效率低下。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-407">
<p><span class="big">RPC方法调用时一个高并发场景，因此Dubbo将Random改为了ThreadLocalRandom。</span></p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3 has-source-line data-line-stdin-410">
<h4 id="_轮询平滑加权轮询">轮询<sub><code>平滑加权轮询</code></sub></h4>
<div class="paragraph has-source-line data-line-stdin-412">
<p>轮询算法中，Dubbo选用了平滑加权版，一能根据节点的性能选择分摊多少流量，二能确保避免普通加权轮询算法导致的持续将流量分配给权重更大的节点，让各节点按自己的能力较为均匀地参与服务。</p>
</div>
<div class="sect4 has-source-line data-line-stdin-414">
<h5 id="_算法解析">算法解析</h5>
<div class="paragraph has-source-line data-line-stdin-415">
<p>该算法最初来源于<code>nginx</code>，分如下两步：</p>
</div>
<div class="exampleblock has-source-line data-line-stdin-417">
<div class="content">
<div class="olist arabic has-source-line data-line-stdin-418">
<ol class="arabic">
<li class="has-source-line data-line-stdin-418">
<p>为每个节点加上它的权重值；</p>
</li>
<li class="has-source-line data-line-stdin-419">
<p>选择最大的节点<code>selected</code>减去总的权重值；</p>
</li>
<li class="has-source-line data-line-stdin-420">
<p>返回选中节点<code>selected</code>；</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-423">
<p>算法本身看起来很简单，但是没法比较直观地加以理解，大致意思是“每次选用节点，所有节点都有机会累加自己的权重，然而当前权重最大的那个会以权重总值快速衰减下去，这样使得初始权重小者有机会超过初始权重大者进而得以被选中”。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-425">
<p>以{a:5, b:1, c:2}三个节点举例，其选择过程如下表：</p>
</div>
<table class="tableblock frame-all grid-all stretch has-source-line data-line-stdin-427">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 37.5%;">
<col style="width: 12.5%;">
<col style="width: 37.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">轮数</th>
<th class="tableblock halign-left valign-top">选择前的当前权重</th>
<th class="tableblock halign-left valign-top">选择节点</th>
<th class="tableblock halign-left valign-top">选择后的当前权重</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{5,1,2}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{-3,1,2}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{2,2,4}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{2,2,-4}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{7,3,-2}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{-1,3,-2}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{4,4,0}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{-4,4,0}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{1,5,2}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{1,-3,2}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{6,-2,4}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{-2,-2,4}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{3,-1,6}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{3,-1,-2}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{8,0,0}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{0,0,0}</p></td>
</tr>
</tbody>
</table>
<div class="paragraph has-source-line data-line-stdin-472">
<p>上表表示，a、b、c选择的次数符合5:1:2，而且权重大的不会被连续被选。8轮选择后，当前值又回到{0, 0, 0}，以上序列一直循环，始终是平滑的，有关算法的证明请参考<a href="https://tenfy.cn/2018/11/12/smooth-weighted-round-robin/">nginx平滑的基于权重轮询算法分析</a>。</p>
</div>
</div>
<div class="sect4 has-source-line data-line-stdin-474">
<h5 id="_代码实现">代码实现</h5>
<div class="paragraph has-source-line data-line-stdin-476">
<p>不同于<code>加权随机</code>，<code>加权轮询</code>算法需要记住RPC方法被一个服务实例调用的历史记录，轮流地让各个实例为同一个RPC方法提供服务，权重大者获得更多次调用机会。<code>LoadBalance</code>是一个扩展点，和其它扩展点一样，其实现具类都是单例的。因而就当前应用而言，它是针对所有引用服务的，每一个都会有一到多个实例，加上RPC方法被并发调用的特性等都确定了需要两级的并发类型的Map容器缓存引用服务的实例，如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-478">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#0a8;font-weight:bold">ConcurrentMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">ConcurrentMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, WeightedRoundRobin&gt;&gt;
    methodWeightMap = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ConcurrentHashMap</span>&lt;&gt;();</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-483">
<p>显然上述涉及了两级Key，而能唯一确认<code>二级Key</code>的部分是<code>host[":" + port]</code>，如下：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-485">
<ol class="arabic">
<li class="has-source-line data-line-stdin-485">
<p>一级Key：<code>group + "/" + interfaceName + ":" + version + "." + invocation[methodName]</code></p>
</li>
<li class="has-source-line data-line-stdin-487">
<p>二级Key：<code>[protocol + "://" + [username[":" + password] + "@"]][host[":" + port]]["/" + path]</code></p>
</li>
</ol>
</div>
<div class="paragraph has-source-line data-line-stdin-489">
<p>二级Map容器中装入的节点代表了一个服务引用实例，而定义的<code>methodWeightMap</code>缓存中的二级map装入的值类型为<code>WeightedRoundRobin</code>，定义如下源码：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-492">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">protected</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">WeightedRoundRobin</span> {
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">int</span> weight;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">AtomicLong</span> current = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">AtomicLong</span>(<span style="color:#00D">0</span>);
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> lastUpdate;
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">int</span> getWeight() {
        <span style="color:#080;font-weight:bold">return</span> weight;
    }
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setWeight(<span style="color:#339;font-weight:bold">int</span> weight) {
        <span style="color:#950">this</span>.weight = weight;
        current.set(<span style="color:#00D">0</span>);
    }
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">long</span> increaseCurrent() {
        <span style="color:#080;font-weight:bold">return</span> current.addAndGet(weight);
    }
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> sel(<span style="color:#339;font-weight:bold">int</span> total) {
        current.addAndGet(-<span style="color:#00D">1</span> * total);
    }
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">long</span> getLastUpdate() {
        <span style="color:#080;font-weight:bold">return</span> lastUpdate;
    }
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setLastUpdate(<span style="color:#339;font-weight:bold">long</span> lastUpdate) {
        <span style="color:#950">this</span>.lastUpdate = lastUpdate;
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-519">
<p>上述源码表示，<code>WeightedRoundRobin</code>除了记录对应微服务引用实例配置权重，还定义了处理平滑算法的自身权值行为，并且使用了原子变量保证其多线程环境下的计算安全。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-521">
<p>微服务始终处于分布式环境下，服务实例随时都有可能上下线，于Dubbo负载均衡调用而言，就是对同一个服务的调用，入参<code>invokers</code>列表中的元素比先前增加或减少了，新增的可以及时感知到，而减少的则需要借助超时机制在加锁环境下移除掉过期不在线的服务引用实例，这也是<code>WeightedRoundRobin</code>定义<code>lastUpdate</code>属性及其<code>setter</code>和<code>getter</code>的原因，如下代码所示：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-523">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">RoundRobinLoadBalance</span> <span style="color:#088;font-weight:bold">extends</span> AbstractLoadBalance {
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#339;font-weight:bold">int</span> RECYCLE_PERIOD = <span style="color:#00D">60000</span>;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">AtomicBoolean</span> updateLock = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">AtomicBoolean</span>();

    <span style="color:#088;font-weight:bold">protected</span> &lt;T&gt; Invoker&lt;T&gt; doSelect(<span style="color:#0a8;font-weight:bold">List</span>&lt;Invoker&lt;T&gt;&gt; invokers, <span style="color:#0a8;font-weight:bold">URL</span> url, Invocation invocation) {
        <span style="color:#777">//获取二级Map容器，Key：`group + "/" + interfaceName + ":" + version + "." + invocation[methodName]`</span>
        <span style="color:#0a8;font-weight:bold">String</span> key = invokers.get(<span style="color:#00D">0</span>).getUrl().getServiceKey() + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">.</span><span style="color:#710">"</span></span> + invocation.getMethodName();
        <span style="color:#0a8;font-weight:bold">ConcurrentMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, WeightedRoundRobin&gt; map = methodWeightMap.get(key);
        <span style="color:#080;font-weight:bold">if</span> (map == <span style="color:#069">null</span>) {
            methodWeightMap.putIfAbsent(key, <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ConcurrentHashMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, WeightedRoundRobin&gt;());
            map = methodWeightMap.get(key);
        }
        ...<span style="color:#777">//算法实现</span>
        <span style="color:#777">//失效引用实例处理，在最后返回结果时执行</span>
        if (!updateLock.get() &amp;&amp; invokers.size() != map.size()) {
            <span style="color:#080;font-weight:bold">if</span> (updateLock.compareAndSet(<span style="color:#069">false</span>, <span style="color:#069">true</span>)) {
                <span style="color:#080;font-weight:bold">try</span> {
                    <span style="color:#777">// copy -&gt; modify -&gt; update reference</span>
                    <span style="color:#0a8;font-weight:bold">ConcurrentMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, WeightedRoundRobin&gt; newMap = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ConcurrentHashMap</span>&lt;&gt;(map);
                    newMap.entrySet().removeIf(item -&gt; now - item.getValue().getLastUpdate() &gt; RECYCLE_PERIOD);
                    methodWeightMap.put(key, newMap);
                } <span style="color:#080;font-weight:bold">finally</span> {
                    updateLock.set(<span style="color:#069">false</span>);
                }
            }
        }
        ...
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-557">
<p>仔细研读上述代码，有3点值得一提的：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-559">
<ol class="arabic">
<li class="has-source-line data-line-stdin-559">
<p>执行<code>methodWeightMap</code>缓存更新时的其中一个条件是入参<code>invokers</code>列表元素个数和服务引用实例<sub>属于执行当前RPC方法调用的微服务</sub>二级缓存的要一致，因为新增的从<code>invokers</code>入参可以及时发现，因而那种列表中同时出现新增或减少的也会导致<code>invokers.size() != map.size()</code>条件成立。</p>
</li>
<li class="has-source-line data-line-stdin-561">
<p><code>RoundRobinLoadBalance</code>使用了类型的原子变量<code>AtomicBoolean</code>作为锁，目的是为了减少锁的自旋带来的性能损耗，<code>compareAndSet()</code>尝试一次执行不成功，便直接略过，说明其它线程已经获得了该锁正在执行目标逻辑，于当前微服务的实例缓存而言，当前时刻该逻辑只需执行一次，无论哪个线程获得机会执行都可以。然而<code>updateLock</code>这个锁于<code>RoundRobinLoadBalance</code>单例而言它是全局的，每个服务都对应一个装其引用实例的<code>ConcurrentMap&lt;String, WeightedRoundRobin&gt;</code>容器，<code>updateLock</code>作用在所有这些二级容器上，如果另有一个高频RPC调用存在，其所属服务实例频繁上下线，那么当前逻辑可能长时间没法及时获得机会执行，不过这种场景不常见，概率较低，即时发生也只是多浪费点缓存空间而已。</p>
</li>
<li class="has-source-line data-line-stdin-563">
<p>尽管<code>ConcurrentMap&lt;String, WeightedRoundRobin&gt;</code>是线程安全的，但代码中还是采用了<code>copy → modify → update reference</code>这种更新模式，这样做的好处将加锁块的逻辑限定在当前块，可以做到容器正在更新的过程对外不可见。</p>
</li>
</ol>
</div>
<div class="paragraph has-source-line data-line-stdin-565">
<p>最后剩下的是算法实现部分，算法有关原理请参考上一子章节，代码如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-568">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">protected</span> &lt;T&gt; Invoker&lt;T&gt; doSelect(<span style="color:#0a8;font-weight:bold">List</span>&lt;Invoker&lt;T&gt;&gt; invokers, <span style="color:#0a8;font-weight:bold">URL</span> url, Invocation invocation) {
    ...<span style="color:#777">//获取二级Map容器</span>
    int totalWeight = <span style="color:#00D">0</span>;
    <span style="color:#339;font-weight:bold">long</span> maxCurrent = <span style="color:#0a8;font-weight:bold">Long</span>.MIN_VALUE;
    <span style="color:#339;font-weight:bold">long</span> now = <span style="color:#0a8;font-weight:bold">System</span>.currentTimeMillis();
    Invoker&lt;T&gt; selectedInvoker = <span style="color:#069">null</span>;
    WeightedRoundRobin selectedWRR = <span style="color:#069">null</span>;
    <span style="color:#080;font-weight:bold">for</span> (Invoker&lt;T&gt; invoker : invokers) {
        <span style="color:#777">//[protocol + "://" + [username[":" + password] + "@"]][host[":" + port]]["/" + path]</span>
        <span style="color:#0a8;font-weight:bold">String</span> identifyString = invoker.getUrl().toIdentityString();
        WeightedRoundRobin weightedRoundRobin = map.get(identifyString);
        <span style="color:#339;font-weight:bold">int</span> weight = getWeight(invoker, invocation);

        <span style="color:#080;font-weight:bold">if</span> (weightedRoundRobin == <span style="color:#069">null</span>) {
            weightedRoundRobin = <span style="color:#080;font-weight:bold">new</span> WeightedRoundRobin();
            weightedRoundRobin.setWeight(weight);
            map.putIfAbsent(identifyString, weightedRoundRobin);
        }
        <span style="color:#777">//在预热阶段权重可能发生变化，需要更新</span>
        <span style="color:#080;font-weight:bold">if</span> (weight != weightedRoundRobin.getWeight()) {
            <span style="color:#777">//weight changed</span>
            weightedRoundRobin.setWeight(weight);
        }
        <span style="color:#339;font-weight:bold">long</span> cur = weightedRoundRobin.increaseCurrent();
        weightedRoundRobin.setLastUpdate(now);
        <span style="color:#080;font-weight:bold">if</span> (cur &gt; maxCurrent) {
            maxCurrent = cur;
            selectedInvoker = invoker;
            selectedWRR = weightedRoundRobin;
        }
        totalWeight += weight;
    }

    ...<span style="color:#777">//失效引用实例处理</span>

    if (selectedInvoker != <span style="color:#069">null</span>) {
        selectedWRR.sel(totalWeight);
        <span style="color:#080;font-weight:bold">return</span> selectedInvoker;
    }
    <span style="color:#777">// should not happen here</span>
    <span style="color:#080;font-weight:bold">return</span> invokers.get(<span style="color:#00D">0</span>);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3 has-source-line data-line-stdin-613">
<h4 id="_最少链接最少活跃调用数">最少链接<sub><code>最少活跃调用数</code></sub></h4>
<div class="paragraph has-source-line data-line-stdin-615">
<p>一个微服务的若干实例皆在提供服务时，于接入客户端而言，一个实例，发往其中的并发请求越少，意味着被快速得到处理的可能性就越高。Dubbo微服务在注册中心的支持下，客户端持有连入微服务实例的更多相关信息，几乎是实时同步的，因而又进一步促成了使用客户端负载均衡模式的Dubbo将最小活跃数策略作为默认实现之一。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-617">
<p>显然，<code>最小活跃数</code>或<code>最少活跃调用数</code>是服务实例的一种实时状态，需要实时跟踪记录，为支持这一特性，Dubbo在协议层中已经基于拦截链机制提供了Filter实现，具体参考《Dubbo RPC 之 Protocol协议层（三）》一文中<code>并发量控制</code>这一章节。需要的状态值记录在<code>ConcurrentMap&lt;String, ConcurrentMap&lt;String, RpcStatus&gt;&gt;</code>类型的<code>METHOD_STATISTICS</code>容器中，<code>RpcStatus</code>是用于汇总一个RPC方法在一个特定服务实例的历史处理情况的。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-619">
<p>源码实现总体上来说比较简单，大致逻辑是：1）每次接入一个RPC请求后，依次遍历给定的对应微服务的所有服务实例，在<code>RpcStatus.getStatus(referUrl, methodName).getActive()</code>的支持下，对比计算得出所有满足<code>最少活跃调用数</code>要求的实例；2）如果满足要求的个数为1，直接返回这个实例；否则，采用上述提到的<code>加权随机</code>挑选一个。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-622">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LeastActiveLoadBalance</span> <span style="color:#088;font-weight:bold">extends</span> AbstractLoadBalance {

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> NAME = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">leastactive</span><span style="color:#710">"</span></span>;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">protected</span> &lt;T&gt; Invoker&lt;T&gt; doSelect(<span style="color:#0a8;font-weight:bold">List</span>&lt;Invoker&lt;T&gt;&gt; invokers, <span style="color:#0a8;font-weight:bold">URL</span> url, Invocation invocation) {
        <span style="color:#339;font-weight:bold">int</span> length = invokers.size();
        <span style="color:#339;font-weight:bold">int</span> leastActive = -<span style="color:#00D">1</span>;
        <span style="color:#339;font-weight:bold">int</span> leastCount = <span style="color:#00D">0</span>;
        <span style="color:#339;font-weight:bold">int</span><span style="color:#339;font-weight:bold">[]</span> leastIndexes = <span style="color:#080;font-weight:bold">new</span> <span style="color:#339;font-weight:bold">int</span>[length];
        <span style="color:#339;font-weight:bold">int</span><span style="color:#339;font-weight:bold">[]</span> weights = <span style="color:#080;font-weight:bold">new</span> <span style="color:#339;font-weight:bold">int</span>[length];
        <span style="color:#339;font-weight:bold">int</span> totalWeight = <span style="color:#00D">0</span>;
        <span style="color:#339;font-weight:bold">int</span> firstWeight = <span style="color:#00D">0</span>;
        <span style="color:#339;font-weight:bold">boolean</span> sameWeight = <span style="color:#069">true</span>;


        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> i = <span style="color:#00D">0</span>; i &lt; length; i++) {
            Invoker&lt;T&gt; invoker = invokers.get(i);
            <span style="color:#339;font-weight:bold">int</span> active = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName()).getActive();
            <span style="color:#777">//计算加权值，在预热阶段会变化</span>
            <span style="color:#339;font-weight:bold">int</span> afterWarmup = getWeight(invoker, invocation);
            weights[i] = afterWarmup;
            <span style="color:#080;font-weight:bold">if</span> (leastActive == -<span style="color:#00D">1</span> || active &lt; leastActive) {<span style="color:#777">//①</span>
                leastActive = active;
                leastCount = <span style="color:#00D">1</span>;
                leastIndexes[<span style="color:#00D">0</span>] = i;
                totalWeight = afterWarmup;
                firstWeight = afterWarmup;
                sameWeight = <span style="color:#069">true</span>;
            } <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (active == leastActive) {<span style="color:#777">//②</span>
                leastIndexes[leastCount++] = i;
                totalWeight += afterWarmup;
                <span style="color:#080;font-weight:bold">if</span> (sameWeight &amp;&amp; i &gt; <span style="color:#00D">0</span>
                        &amp;&amp; afterWarmup != firstWeight) {
                    sameWeight = <span style="color:#069">false</span>;
                }
            }
        }
        <span style="color:#080;font-weight:bold">if</span> (leastCount == <span style="color:#00D">1</span>) {
            <span style="color:#080;font-weight:bold">return</span> invokers.get(leastIndexes[<span style="color:#00D">0</span>]);
        }
        <span style="color:#080;font-weight:bold">if</span> (!sameWeight &amp;&amp; totalWeight &gt; <span style="color:#00D">0</span>) {
            <span style="color:#339;font-weight:bold">int</span> offsetWeight = ThreadLocalRandom.current().nextInt(totalWeight);
            <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> i = <span style="color:#00D">0</span>; i &lt; leastCount; i++) {
                <span style="color:#339;font-weight:bold">int</span> leastIndex = leastIndexes[i];
                offsetWeight -= weights[leastIndex];
                <span style="color:#080;font-weight:bold">if</span> (offsetWeight &lt; <span style="color:#00D">0</span>) {
                    <span style="color:#080;font-weight:bold">return</span> invokers.get(leastIndex);
                }
            }
        }
        <span style="color:#080;font-weight:bold">return</span> invokers.get(leastIndexes[ThreadLocalRandom.current().nextInt(leastCount)]);
    }
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-680">
<p>上述源码如下几处有亮点的地方，它们都利用临时空间记录了中间过程值，增加了效率：</p>
</div>
<div class="olist arabic has-source-line data-line-stdin-682">
<ol class="arabic">
<li class="has-source-line data-line-stdin-682">
<p>在循环迭代的过程中，始终关注最终状态值<sub>代码块②</sub>，一旦被破坏，则重新开始累计<sub>代码块①</sub>；</p>
</li>
<li class="has-source-line data-line-stdin-683">
<p><code>totalWeight</code>、<code>firstWeight</code>、<code>sameWeight</code>的处理；</p>
</li>
</ol>
</div>
</div>
<div class="sect3 has-source-line data-line-stdin-686">
<h4 id="_源地址散列一致性hash算法">源地址散列<sub><code>一致性hash算法</code></sub></h4>
<div class="paragraph has-source-line data-line-stdin-688">
<p>分布式盛行前，人们习惯使用大型机运行他们的应用，对外提供服务。此时的服务器几乎承载着所有跟应用相关的后台进程，顶多搭配一些负载均衡策略将几套应用打包对外提供用户界面。大型机造价不菲，一般规模的公司几乎没法承担，就连大型互联公司也为之头疼，阿里在2009年就已经开启了去IOE的征程，如今已经成绩斐然，被业界纷纷效仿。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-690">
<p>分布式已盛行的时代，开发者们习惯于将多台普通机器组合一起，采用一些冗余、分工、容错等技术手段将应用打散成更小的单元，然后整体向外提供服务。例如一台普通运行着MySQL的机器能承载的数据规模是千万级别，但应用面向的是十亿级别的，这时就会利用分工机制，让若干个这样部署在不同机器上的MySQL实例共同协作，以满足需求（<span class="small">实际生产环境中，往往是超过80%的数据集中在低于20%的数据表中，一般同时采用采用分表分库方案解决</span>）；使用普通的设备虽然大幅降低了资金的耗费，但也往往意味着更高概率的单机故障，因此前面这个案例中人们还往往为每个MySQL实例提供它专属的备机，也即做主从热备处理。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-692">
<p>MySQL分表分库案例中，涉及到一个特别典型的问题，就是如何根据ID无需挨个分表查找、快速定位其所属分表，学过算法的都清楚，hash显然是最高效的一种查询方案，其算法复杂度为<code>O(1</code>)。业界通常使用<code>一致性hash算法</code>确保同一ID标识的记录只会定位到同一个库的同一张分表中去，因它同其他hash算法相比有着无可比拟的优势。实际上该算法最初应用在分布式缓存中，它有着能避免一般hash算法在某个节点不可用时导致的雪崩效应的能力。缓存有个特点就是一个节点奔溃，其他节点可以替它完成工作<sub>没有命中则到数据库中查询，将查到的数据填入缓存</sub>，大多数微服务的服务实例也有着这个特点，因此Dubbo将其作为它负载均衡扩展点的一种实现。</p>
</div>
<div class="sect4 has-source-line data-line-stdin-694">
<h5 id="_算法介绍">算法介绍</h5>
<div class="paragraph has-source-line data-line-stdin-696">
<p>该章节参考<a href="https://www.cnblogs.com/lpfuture/p/5796398.html">一致性哈希算法原理</a>和<a href="https://zhuanlan.zhihu.com/p/34985026">什么是一致性Hash算法？</a>。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-698">
<p><code>一致性hash算法</code>将整个哈希值空间组织成一个虚拟圆环，其上顺时钟依序编号分布着2<sup>32</sup>个点<sub>0和2<sup>32</sup>位置的两个点重合</sub>，我们将其称为<code>Hash环</code>。对所有参与服务的节点根据其唯一性标识<sub>服务器的IP或主机名</sub>进行hash确定它们所在<code>Hash环</code>的位置，称它们为<code>服务节点</code>。接入客户端查询请求后，提取key按相同函数Hash得到<code>Hash环</code>上的点，由该点出发顺时针找到的第一个<code>服务节点</code>即为要找的目标。如下图，假设有<code>A、B、C、D</code> 4个<code>服务节点</code>，接入了4个请求，Key分别为<code>Object A、Object B、Object C、Object D</code>，hash处理示意图如下：</p>
</div>
<div class="imageblock has-source-line data-line-stdin-700">
<div class="content">
<img src="res_files/imgs/11_image(11)" alt="一致性Hash算法">
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-703">
<p><span class="big">该算法有着良好的容错性和可扩展性。</span></p>
</div>
<div class="paragraph has-source-line data-line-stdin-705">
<p><code>Hash环</code>中如果有一个<code>服务节点</code>不幸宕机，受影响的仅仅是该节点到前一节点所组成的哈希值空间，这个空间的接受的请求会被定位到后一节点上，如下，假设C掉线：</p>
</div>
<div class="imageblock has-source-line data-line-stdin-707">
<div class="content">
<img src="res_files/imgs/11_image(12)" alt="一致性Hash算法——服务节点掉线">
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-709">
<p>相应的在<code>Hash环</code>动态地填入一个<code>服务节点</code>，受影响的只是该新增节点到其前一个<code>服务节点</code>的所组成的哈希值空间，如下，假设X<code>服务节点</code>上线：</p>
</div>
<div class="imageblock has-source-line data-line-stdin-711">
<div class="content">
<img src="res_files/imgs/11_image(13)" alt="一致性Hash算法——服务节点上线">
</div>
</div>
<div class="sect5 has-source-line data-line-stdin-713">
<h6 id="_数据倾斜">数据倾斜</h6>
<div class="paragraph has-source-line data-line-stdin-715">
<p><code>一致性Hash算法</code>在服务节点太少时，容易因为节点分部不均匀而造成数据倾斜问题，例如只有两个节点，其环分布如下：</p>
</div>
<div class="imageblock has-source-line data-line-stdin-717">
<div class="content">
<img src="res_files/imgs/11_image(14)" alt="一致性Hash算法——倾斜问题">
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-719">
<p>为解决数据倾斜问题，引入了虚拟节点机制，通过给每个<code>服务节点</code>编号，如<code>“Node A#1”、“Node A#2”、“Node A#3”</code>，计算多个hash值空间，如下所示：</p>
</div>
<div class="imageblock has-source-line data-line-stdin-721">
<div class="content">
<img src="res_files/imgs/11_image(15)" alt="一致性Hash算法——倾斜问题解决">
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-723">
<p>在实际应用中，通常将虚拟节点数设置为32甚至更大，因此即使很少的服务节点也能做到相对均匀的数据分布。</p>
</div>
</div>
</div>
<div class="sect4 has-source-line data-line-stdin-726">
<h5 id="_源码实现">源码实现</h5>
<div class="paragraph has-source-line data-line-stdin-729">
<p>扩展点具类<code>ConsistentHashLoadBalance</code>的实现分为两部分，1）一致性Hash算法选择器<code>ConsistentHashSelector</code>实现；2）获取<code>ConsistentHashSelector</code>实例，用其挑选执行当前RPC方法的服务实例。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-732">
<p>同其他算法实现不一样的是，<code>ConsistentHashSelector</code>将算法实现部分以内部静态类的方式包装起来了，好处是在服务实例列表没有发生变化的情况下，可以反复利用，使用空间换时间，提升了微服务的执行效率，因而声明了针对算法实现的缓存容器<code>ConcurrentMap&lt;String, ConsistentHashSelector&lt;?&gt;&gt; selectors</code>。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-734">
<p>Dubbo中的负载均衡目的是从一个微服务的多个服务实例中挑选一个用于执行当前RPC方法，一个微服务可以存在多个方法，也就是说服务实例是针对方法级别的，而非服务级别的，因而使用<code>group + "/" + interfaceName + ":" + version + "." + invocation[methodName]</code>作为<code>selectors</code>的Key键。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-737">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">ConsistentHashLoadBalance</span> <span style="color:#088;font-weight:bold">extends</span> AbstractLoadBalance {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">ConcurrentMap</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, ConsistentHashSelector&lt;?&gt;&gt; selectors = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ConcurrentHashMap</span>&lt;&gt;();

    <span style="color:#088;font-weight:bold">protected</span> &lt;T&gt; Invoker&lt;T&gt; doSelect(<span style="color:#0a8;font-weight:bold">List</span>&lt;Invoker&lt;T&gt;&gt; invokers, <span style="color:#0a8;font-weight:bold">URL</span> url, Invocation invocation) {
        <span style="color:#0a8;font-weight:bold">String</span> methodName = RpcUtils.getMethodName(invocation);
        <span style="color:#0a8;font-weight:bold">String</span> key = invokers.get(<span style="color:#00D">0</span>).getUrl().getServiceKey() + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">.</span><span style="color:#710">"</span></span> + methodName;
        <span style="color:#339;font-weight:bold">int</span> identityHashCode = <span style="color:#0a8;font-weight:bold">System</span>.identityHashCode(invokers);
        ConsistentHashSelector&lt;T&gt; selector = (ConsistentHashSelector&lt;T&gt;) selectors.get(key);
        <span style="color:#080;font-weight:bold">if</span> (selector == <span style="color:#069">null</span> || selector.identityHashCode != identityHashCode) {
            selectors.put(key, <span style="color:#080;font-weight:bold">new</span> ConsistentHashSelector&lt;T&gt;(invokers, methodName, identityHashCode));
            selector = (ConsistentHashSelector&lt;T&gt;) selectors.get(key);
        }
        <span style="color:#080;font-weight:bold">return</span> selector.select(invocation);
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-757">
<p>因<code>identityHashCode()</code>不管对象是否重写了<code>hashCode()</code>方法，都会返回对象的<code>hash code</code>，上述代码中使用<code>System.identityHashCode(invokers)</code>作为服务实例列表是否发生变化的检测依据，只要发生变化，就会重新生成服务实例选择器<code>ConsistentHashSelector</code>。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-759">
<p>下述将展开算法的具体实现部分的剖析，按照惯例，我们将源码打散，和上述算法对应起来，一个点一个点地逐个击破。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-761">
<p><code>一致性hash算法</code>的实现是以hash为基础的，上述提到的<code>Hash环</code>内的值的计算实际分为两步，先使用MD5计算得到16个字节的<code>byte[]</code>，被切分为4段<sub>由低位到高位</sub>，再利用该数组取其中一段得到4个字节计算得到一个32位的二进制数字，刚好是一个long类型数字。实现源码如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-763">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">byte</span><span style="color:#339;font-weight:bold">[]</span> md5(<span style="color:#0a8;font-weight:bold">String</span> value) {
    <span style="color:#0a8;font-weight:bold">MessageDigest</span> md5;
    <span style="color:#080;font-weight:bold">try</span> {
        md5 = <span style="color:#0a8;font-weight:bold">MessageDigest</span>.getInstance(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">MD5</span><span style="color:#710">"</span></span>);
    } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#C00;font-weight:bold">NoSuchAlgorithmException</span> e) {
        <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalStateException</span>(e.getMessage(), e);
    }
    md5.reset();
    <span style="color:#339;font-weight:bold">byte</span><span style="color:#339;font-weight:bold">[]</span> bytes = value.getBytes(StandardCharsets.UTF_8);
    md5.update(bytes);
    <span style="color:#080;font-weight:bold">return</span> md5.digest();
}

<span style="color:#777">//获取number指定的一段4个字节（每字节8位），首先取得的字节形成结果整数的高位</span>
<span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> hash(<span style="color:#339;font-weight:bold">byte</span><span style="color:#339;font-weight:bold">[]</span> digest, <span style="color:#339;font-weight:bold">int</span> number) {
    <span style="color:#080;font-weight:bold">return</span> (((<span style="color:#339;font-weight:bold">long</span>) (digest[<span style="color:#00D">3</span> + number * <span style="color:#00D">4</span>] &amp; <span style="color:#02b">0xFF</span>) &lt;&lt; <span style="color:#00D">24</span>)
            | ((<span style="color:#339;font-weight:bold">long</span>) (digest[<span style="color:#00D">2</span> + number * <span style="color:#00D">4</span>] &amp; <span style="color:#02b">0xFF</span>) &lt;&lt; <span style="color:#00D">16</span>)
            | ((<span style="color:#339;font-weight:bold">long</span>) (digest[<span style="color:#00D">1</span> + number * <span style="color:#00D">4</span>] &amp; <span style="color:#02b">0xFF</span>) &lt;&lt; <span style="color:#00D">8</span>)
            | (digest[number * <span style="color:#00D">4</span>] &amp; <span style="color:#02b">0xFF</span>))
            &amp; <span style="color:#02b">0xFFFFFFFF</span>L;
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-786">
<p>注：<span class="small"><code>实际上上述方案潜藏着bug，散列方案并不完美，两个不同的数据内容，散列得到的整数可能刚好一样。</code></span></p>
</div>
<div class="paragraph has-source-line data-line-stdin-788">
<p>一个RPC调用请求接入后，需要使用同一个hash算法对提取到的Key执行hash求值，以确定其到底被那个<code>服务节点</code>所调用，RPC方法表征的是一个原生的Java方法调用，使用<code>invocation.getArguments()</code>能提取到Key。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-790">
<p>如果使用<code>一致性hash算法</code>作为负载均衡器，Dubbo要求得另外在微服务引用实例的配置总线中加入配置项<code>invocation[methodName]+"."+"hash.arguments"</code>，值为以","分割的参数索引位置，顺序随意。</p>
</div>
<div class="listingblock has-source-line data-line-stdin-793">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> HASH_ARGUMENTS = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">hash.arguments</span><span style="color:#710">"</span></span>;

<span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#339;font-weight:bold">int</span><span style="color:#339;font-weight:bold">[]</span> argumentIndex;

ConsistentHashSelector(<span style="color:#0a8;font-weight:bold">List</span>&lt;Invoker&lt;T&gt;&gt; invokers,
        <span style="color:#0a8;font-weight:bold">String</span> methodName, <span style="color:#339;font-weight:bold">int</span> identityHashCode) {
    ...
    String<span style="color:#339;font-weight:bold">[]</span> index = COMMA_SPLIT_PATTERN.split(
        url.getMethodParameter(methodName, HASH_ARGUMENTS, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">0</span><span style="color:#710">"</span></span>));

    argumentIndex = <span style="color:#080;font-weight:bold">new</span> <span style="color:#339;font-weight:bold">int</span>[index.length];
    <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> i = <span style="color:#00D">0</span>; i &lt; index.length; i++) {
        argumentIndex[i] = <span style="color:#0a8;font-weight:bold">Integer</span>.parseInt(index[i]);
    }
    ...
}

<span style="color:#088;font-weight:bold">public</span> Invoker&lt;T&gt; select(Invocation invocation) {
    <span style="color:#0a8;font-weight:bold">String</span> key = toKey(invocation.getArguments());
    <span style="color:#339;font-weight:bold">byte</span><span style="color:#339;font-weight:bold">[]</span> digest = md5(key);
    <span style="color:#080;font-weight:bold">return</span> selectForKey(hash(digest, <span style="color:#00D">0</span>));
}


<span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> toKey(<span style="color:#0a8;font-weight:bold">Object</span><span style="color:#339;font-weight:bold">[]</span> args) {
    <span style="color:#0a8;font-weight:bold">StringBuilder</span> buf = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">StringBuilder</span>();
    <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> i : argumentIndex) {
        <span style="color:#080;font-weight:bold">if</span> (i &gt;= <span style="color:#00D">0</span> &amp;&amp; i &lt; args.length) {
            buf.append(args[i]);
        }
    }
    <span style="color:#080;font-weight:bold">return</span> buf.toString();
}</code></pre>
</div>
</div>
<div class="admonitionblock note has-source-line data-line-stdin-830">
<table>
<tbody><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
选用<code>一致性hash算法</code>的一个重要原因是实现粘滞，也就是说让满足某些特征的数据尽量被分派在同一个实例上运行，或者说针对同一RPC方法的前后两次不同的调用，如果某些参数一样，那么它就应该落在同一个实例上。Dubbo的实现给予了开发充分的自由去决策配置所使用哪些参数作为特征依据。
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph has-source-line data-line-stdin-832">
<p>最后还剩下一个问题，就是如何将服务实例散列到<code>Hash环</code>上，包括虚拟节点的处理。如果没有特殊配置的话，Dubbo会为每个服务实例产生160个虚拟几点，也可就配置项<code>invoker.url[invocation[methodName]+"."+"hash.nodes"]</code>设置值，在映射<code>Hash环</code>目标位置时，使用<code>invoker.url[host][":" + invoker.url[port]] + index</code>取hash的方式，和上述RPC方法取hash不同的是，这次使用<code>md5</code>计算得到的16个字节全部被派上了用场，因而多了<code>replicaNumber / 4</code>和最里头的一层循环处理。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-834">
<p>包括虚拟节点在内的所有<code>服务节点</code>在<code>Hash环</code>上表示为一个0到2<sup>32</sup>的整数，需要对应关联服务实例，也即<code>&lt;Long, Invoker&lt;T&gt;&gt;</code>，另外最好能兼顾实现根据请求数据提取的Key找到对应<code>服务节点</code>，Java中满足这些要求的理想的容器是<code>TreeMap</code>，如下：</p>
</div>
<div class="listingblock has-source-line data-line-stdin-836">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> HASH_NODES = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">hash.nodes</span><span style="color:#710">"</span></span>;

<span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">ConsistentHashSelector</span>&lt;T&gt; {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">TreeMap</span>&lt;<span style="color:#0a8;font-weight:bold">Long</span>, Invoker&lt;T&gt;&gt; virtualInvokers;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#339;font-weight:bold">int</span> replicaNumber;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#339;font-weight:bold">int</span> identityHashCode;

    ConsistentHashSelector(<span style="color:#0a8;font-weight:bold">List</span>&lt;Invoker&lt;T&gt;&gt; invokers, <span style="color:#0a8;font-weight:bold">String</span> methodName, <span style="color:#339;font-weight:bold">int</span> identityHashCode) {
        <span style="color:#950">this</span>.virtualInvokers = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">TreeMap</span>&lt;<span style="color:#0a8;font-weight:bold">Long</span>, Invoker&lt;T&gt;&gt;();
        <span style="color:#950">this</span>.identityHashCode = identityHashCode;
        <span style="color:#0a8;font-weight:bold">URL</span> url = invokers.get(<span style="color:#00D">0</span>).getUrl();
        <span style="color:#950">this</span>.replicaNumber = url.getMethodParameter(methodName, HASH_NODES, <span style="color:#00D">160</span>);
        ...<span style="color:#777">//特征参数索引处理</span>
        for (Invoker&lt;T&gt; invoker : invokers) {
            <span style="color:#0a8;font-weight:bold">String</span> address = invoker.getUrl().getAddress();
            <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> i = <span style="color:#00D">0</span>; i &lt; replicaNumber / <span style="color:#00D">4</span>; i++) {
                <span style="color:#339;font-weight:bold">byte</span><span style="color:#339;font-weight:bold">[]</span> digest = md5(address + i);
                <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">int</span> h = <span style="color:#00D">0</span>; h &lt; <span style="color:#00D">4</span>; h++) {
                    <span style="color:#339;font-weight:bold">long</span> m = hash(digest, h);
                    virtualInvokers.put(m, invoker);
                }
            }
        }
    }
    <span style="color:#088;font-weight:bold">private</span> Invoker&lt;T&gt; selectForKey(<span style="color:#339;font-weight:bold">long</span> hash) {
        <span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">Long</span>, Invoker&lt;T&gt;&gt; entry = virtualInvokers.ceilingEntry(hash);
        <span style="color:#080;font-weight:bold">if</span> (entry == <span style="color:#069">null</span>) {
            entry = virtualInvokers.firstEntry();
        }
        <span style="color:#080;font-weight:bold">return</span> entry.getValue();
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-stdin-875">
<p><code>TreeMap</code>使用红黑树实现，插入到其中的元素是按Key键排序的，支持Key键做升序访问。它实现了<code>NavigableMap → SortedMap</code>接口，具有了针对给定搜索目标返回最接近匹配项的导航方法。方法 <code>lowerEntry()、floorEntry()、ceilingEntry() 和 higherEntry()</code> 分别返回与小于、小于等于、大于等于、大于给定键的键关联的 Map.Entry 对象，如果不存在这样的键，则返回 null。</p>
</div>
<div class="paragraph has-source-line data-line-stdin-877">
<p>另外<code>selectForKey()</code>方法中在<code>ceilingEntry()</code>方法没有找到满足要求的节点<sub>结果为null</sub>时，调用了<code>virtualInvokers.firstEntry()</code>返回第一个节点，这正是<code>Hash环</code>闭环形成的位置<sub>0和2<sup>32</sup>重合的点</sub>。</p>
</div>
<hr>
<div class="paragraph has-source-line data-line-stdin-881">
<p>完结</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div><script src="res_files/js/scrollToElement.js"></script>
<script src="res_files/js/processLinks.js"></script>
<script src="res_files/js/pickSourceLine.js"></script>
<script type="text/x-mathjax-config;executed=true">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="res_files/js/MathJax.js"></script>
<div id="color-picker-wrap" style="display: none; position: fixed; top: 0px; left: 0px; z-index: 9999;"><!----></div></body></html>